"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.readSchema = exports.isNestedTypeAttribute = exports.isAttributeNestedType = void 0;
const fs = __importStar(require("fs-extra"));
const path = __importStar(require("path"));
const util_1 = require("../../util");
const hcl2json_1 = require("@cdktf/hcl2json");
const terraformBinaryName = process.env.TERRAFORM_BINARY_NAME || "terraform";
function isAttributeNestedType(type) {
    return (typeof type === "object" &&
        !Array.isArray(type) &&
        typeof type.nesting_mode === "string" &&
        typeof type.attributes === "object");
}
exports.isAttributeNestedType = isAttributeNestedType;
function isNestedTypeAttribute(att) {
    return (typeof att.nested_type !== "undefined" &&
        isAttributeNestedType(att.nested_type));
}
exports.isNestedTypeAttribute = isNestedTypeAttribute;
const transformVariables = (variables) => {
    var _a;
    const result = [];
    if (!variables)
        return result;
    for (const name of Object.keys(variables)) {
        const variable = variables[name][0];
        let variableType;
        if (
        // eslint-disable-next-line no-prototype-builtins
        variable.hasOwnProperty("type") == false &&
            // eslint-disable-next-line no-prototype-builtins
            variable.hasOwnProperty("default") == true) {
            switch (typeof variable["default"]) {
                case "boolean":
                    variableType = "bool";
                    break;
                case "number":
                    variableType = "number";
                    break;
                default:
                    variableType = "any";
            }
        }
        else {
            const matched = (_a = variable["type"]) === null || _a === void 0 ? void 0 : _a.match(/\$\{(.*)\}/);
            variableType = matched ? matched[1] : "any";
        }
        const item = {
            name,
            type: variableType,
            description: variable["description"],
            // eslint-disable-next-line no-prototype-builtins
            required: variable.hasOwnProperty("default") == false,
        };
        if (!item.required) {
            item["default"] = variable["default"];
        }
        result.push(item);
    }
    return result;
};
const transformOutputs = (outputs) => {
    const result = [];
    if (outputs) {
        for (const name of Object.keys(outputs)) {
            const output = outputs[name][0];
            const item = {
                name,
                description: output["description"],
            };
            result.push(item);
        }
    }
    return result;
};
const harvestModuleSchema = async (workingDirectory, modules) => {
    const fileName = path.join(workingDirectory, ".terraform", "modules", "modules.json");
    const result = {};
    if (!fs.existsSync(fileName)) {
        throw new Error(`Modules were not generated properly - couldn't find ${fileName}`);
    }
    const moduleIndex = JSON.parse(fs.readFileSync(fileName, "utf-8"));
    for (const mod of modules) {
        const m = moduleIndex.Modules.find((other) => mod === other.Key);
        if (!m) {
            throw new Error(`Couldn't find ${m}`);
        }
        const parsed = await hcl2json_1.convertFiles(path.join(workingDirectory, m.Dir));
        if (!parsed) {
            throw new Error(`Modules were not generated properly - couldn't parse ${m.Dir}`);
        }
        const schema = {
            inputs: transformVariables(parsed.variable),
            outputs: transformOutputs(parsed.output),
            name: mod,
        };
        result[mod] = schema;
    }
    return result;
};
async function readSchema(targets) {
    const config = {
        terraform: {},
    };
    if (targets.length === 0) {
        return {
            providerSchema: {
                format_version: "0.1",
                provider_schemas: {},
            },
            moduleSchema: {},
        };
    }
    for (const target of targets) {
        if (target.isModule) {
            if (!config.module)
                config.module = {};
            const source = target.constraint.localSource || target.source;
            config.module[target.moduleKey] = { source: source };
            if (target.version) {
                config.module[target.moduleKey]["version"] = target.version;
            }
        }
        else {
            if (!config.provider)
                config.provider = {};
            if (!config.terraform.required_providers) {
                config.terraform.required_providers = {};
            }
            config.provider[target.name] = {};
            config.terraform.required_providers[target.name] = {
                version: target.version,
                source: target.source,
            };
        }
    }
    let providerSchema = { format_version: "0.1" };
    let moduleSchema = {};
    await util_1.withTempDir("fetchSchema", async () => {
        const outdir = process.cwd();
        const filePath = path.join(outdir, "main.tf.json");
        await fs.writeFile(filePath, JSON.stringify(config));
        await util_1.exec(terraformBinaryName, ["init"], { cwd: outdir });
        if (config.provider) {
            providerSchema = JSON.parse(await util_1.exec(terraformBinaryName, ["providers", "schema", "-json"], {
                cwd: outdir,
            }));
            const versionSchema = JSON.parse(await util_1.exec(terraformBinaryName, ["version", "-json"], {
                cwd: outdir,
            }));
            providerSchema.provider_versions = versionSchema.provider_selections;
        }
        if (config.module) {
            moduleSchema = await harvestModuleSchema(outdir, Object.keys(config.module));
        }
    });
    return {
        providerSchema,
        moduleSchema,
    };
}
exports.readSchema = readSchema;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXItc2NoZW1hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJvdmlkZXItc2NoZW1hLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2Q0FBK0I7QUFDL0IsMkNBQTZCO0FBQzdCLHFDQUErQztBQUcvQyw4Q0FBK0M7QUFFL0MsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixJQUFJLFdBQVcsQ0FBQztBQW1DN0UsU0FBZ0IscUJBQXFCLENBQ25DLElBQXlDO0lBRXpDLE9BQU8sQ0FDTCxPQUFPLElBQUksS0FBSyxRQUFRO1FBQ3hCLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDcEIsT0FBTyxJQUFJLENBQUMsWUFBWSxLQUFLLFFBQVE7UUFDckMsT0FBTyxJQUFJLENBQUMsVUFBVSxLQUFLLFFBQVEsQ0FDcEMsQ0FBQztBQUNKLENBQUM7QUFURCxzREFTQztBQXdCRCxTQUFnQixxQkFBcUIsQ0FDbkMsR0FBYztJQUVkLE9BQU8sQ0FDTCxPQUFPLEdBQUcsQ0FBQyxXQUFXLEtBQUssV0FBVztRQUN0QyxxQkFBcUIsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQ3ZDLENBQUM7QUFDSixDQUFDO0FBUEQsc0RBT0M7QUFpREQsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLFNBQWMsRUFBRSxFQUFFOztJQUM1QyxNQUFNLE1BQU0sR0FBWSxFQUFFLENBQUM7SUFFM0IsSUFBSSxDQUFDLFNBQVM7UUFBRSxPQUFPLE1BQU0sQ0FBQztJQUU5QixLQUFLLE1BQU0sSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUU7UUFDekMsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLElBQUksWUFBb0IsQ0FBQztRQUV6QjtRQUNFLGlEQUFpRDtRQUNqRCxRQUFRLENB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QW1CLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQzNELElBQUksTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUNuQixjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FDekIsTUFBTSxXQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxXQUFXLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxFQUFFO2dCQUNoRSxHQUFHLEVBQUUsTUFBTTthQUNaLENBQUMsQ0FDZSxDQUFDO1lBRXBCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQzlCLE1BQU0sV0FBSSxDQUFDLG1CQUFtQixFQUFFLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxFQUFFO2dCQUNwRCxHQUFHLEVBQUUsTUFBTTthQUNaLENBQUMsQ0FDYyxDQUFDO1lBRW5CLGNBQWMsQ0FBQyxpQkFBaUIsR0FBRyxhQUFhLENBQUMsbUJBQW1CLENBQUM7U0FDdEU7UUFDRCxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUU7WUFDakIsWUFBWSxHQUFHLE1BQU0sbUJBQW1CLENBQ3RDLE1BQU0sRUFDTixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FDM0IsQ0FBQztTQUNIO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPO1FBQ0wsY0FBYztRQUNkLFlBQVk7S0FDYixDQUFDO0FBQ0osQ0FBQztBQXhFRCxnQ0F3RUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IGV4ZWMsIHdpdGhUZW1wRGlyIH0gZnJvbSBcIi4uLy4uL3V0aWxcIjtcbmltcG9ydCB7IE1vZHVsZVNjaGVtYSwgSW5wdXQgfSBmcm9tIFwiLi9tb2R1bGUtc2NoZW1hXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3RzTWFrZXJUYXJnZXQgfSBmcm9tIFwiLi4vY29uc3RydWN0cy1tYWtlclwiO1xuaW1wb3J0IHsgY29udmVydEZpbGVzIH0gZnJvbSBcIkBjZGt0Zi9oY2wyanNvblwiO1xuXG5jb25zdCB0ZXJyYWZvcm1CaW5hcnlOYW1lID0gcHJvY2Vzcy5lbnYuVEVSUkFGT1JNX0JJTkFSWV9OQU1FIHx8IFwidGVycmFmb3JtXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvdmlkZXJTY2hlbWEge1xuICAvKlxuICAwLjEgaXMgZS5nLiByZXR1cm5lZCBieSBUZXJyYWZvcm0gMC4xNFxuICAwLjIgaXMgZS5nLiByZXR1cm5lZCBieSBUZXJyYWZvcm0gMS4wICgwLjIgYWRkZWQgc3VwcG9ydCBmb3IgbmVzdGVkX3R5cGUgLyBwbHVnaW4gcHJvdG9jb2wgdjYpXG4gICovXG4gIGZvcm1hdF92ZXJzaW9uPzogXCIwLjFcIiB8IFwiMC4yXCI7XG4gIHByb3ZpZGVyX3NjaGVtYXM/OiB7IFt0eXBlOiBzdHJpbmddOiBQcm92aWRlciB9O1xuICBwcm92aWRlcl92ZXJzaW9ucz86IHsgW2Zxbjogc3RyaW5nXTogc3RyaW5nIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvdmlkZXIge1xuICBwcm92aWRlcjogU2NoZW1hO1xuICByZXNvdXJjZV9zY2hlbWFzOiB7IFt0eXBlOiBzdHJpbmddOiBTY2hlbWEgfTtcbiAgZGF0YV9zb3VyY2Vfc2NoZW1hczogeyBbdHlwZTogc3RyaW5nXTogU2NoZW1hIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2NoZW1hIHtcbiAgdmVyc2lvbjogbnVtYmVyO1xuICBibG9jazogQmxvY2s7XG59XG5cbnR5cGUgQXR0cmlidXRlTmVzdGVkVHlwZU5lc3RpbmcgPSBcImludmFsaWRcIiB8IFwic2luZ2xlXCIgfCBcImxpc3RcIiB8IFwic2V0XCIgfCBcIm1hcFwiO1xuXG4vKipcbiAqIEluIHRmcGx1Z2luNi4wLnByb3RvIHRoaXMgYXMgY2FsbGVkIE9iamVjdCB0byBhdm9pZFxuICogY29sbGlzaW9ucyB3aXRoIHRoZSBuYXRpdmUgSmF2YVNjcmlwdCBPYmplY3Qgd2UgY2FsbCBpdFxuICogQXR0cmlidXRlTmVzdGVkVHlwZSBoZXJlXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXR0cmlidXRlTmVzdGVkVHlwZSB7XG4gIGF0dHJpYnV0ZXM6IHsgW25hbWU6IHN0cmluZ106IEF0dHJpYnV0ZSB9O1xuICBuZXN0aW5nX21vZGU6IEF0dHJpYnV0ZU5lc3RlZFR5cGVOZXN0aW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNBdHRyaWJ1dGVOZXN0ZWRUeXBlKFxuICB0eXBlOiBBdHRyaWJ1dGVUeXBlIHwgQXR0cmlidXRlTmVzdGVkVHlwZVxuKTogdHlwZSBpcyBBdHRyaWJ1dGVOZXN0ZWRUeXBlIHtcbiAgcmV0dXJuIChcbiAgICB0eXBlb2YgdHlwZSA9PT0gXCJvYmplY3RcIiAmJlxuICAgICFBcnJheS5pc0FycmF5KHR5cGUpICYmXG4gICAgdHlwZW9mIHR5cGUubmVzdGluZ19tb2RlID09PSBcInN0cmluZ1wiICYmXG4gICAgdHlwZW9mIHR5cGUuYXR0cmlidXRlcyA9PT0gXCJvYmplY3RcIlxuICApO1xufVxuXG5pbnRlcmZhY2UgQmFzZUF0dHJpYnV0ZSB7XG4gIHR5cGU/OiBBdHRyaWJ1dGVUeXBlO1xuICBuZXN0ZWRfdHlwZT86IEF0dHJpYnV0ZU5lc3RlZFR5cGU7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICByZXF1aXJlZD86IGJvb2xlYW47XG4gIG9wdGlvbmFsPzogYm9vbGVhbjtcbiAgY29tcHV0ZWQ/OiBib29sZWFuO1xuICBzZW5zaXRpdmU/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgTmVzdGVkVHlwZUF0dHJpYnV0ZSBleHRlbmRzIEJhc2VBdHRyaWJ1dGUge1xuICB0eXBlPzogbmV2ZXI7XG4gIG5lc3RlZF90eXBlOiBBdHRyaWJ1dGVOZXN0ZWRUeXBlO1xufVxuaW50ZXJmYWNlIFR5cGVkQXR0cmlidXRlIGV4dGVuZHMgQmFzZUF0dHJpYnV0ZSB7XG4gIHR5cGU6IEF0dHJpYnV0ZVR5cGU7XG4gIG5lc3RlZF90eXBlPzogbmV2ZXI7XG59XG5cbi8vIHRvIHN1cHBvcnQgZWl0aGVyIHR5cGUgb3IgbmVzdGVkX3R5cGUgYmVpbmcgc2V0XG5leHBvcnQgdHlwZSBBdHRyaWJ1dGUgPSBOZXN0ZWRUeXBlQXR0cmlidXRlIHwgVHlwZWRBdHRyaWJ1dGU7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc05lc3RlZFR5cGVBdHRyaWJ1dGUoXG4gIGF0dDogQXR0cmlidXRlXG4pOiBhdHQgaXMgTmVzdGVkVHlwZUF0dHJpYnV0ZSB7XG4gIHJldHVybiAoXG4gICAgdHlwZW9mIGF0dC5uZXN0ZWRfdHlwZSAhPT0gXCJ1bmRlZmluZWRcIiAmJlxuICAgIGlzQXR0cmlidXRlTmVzdGVkVHlwZShhdHQubmVzdGVkX3R5cGUpXG4gICk7XG59XG5cbmV4cG9ydCB0eXBlIEF0dHJpYnV0ZVR5cGUgPVxuICB8IFwic3RyaW5nXCJcbiAgfCBcImJvb2xcIlxuICB8IFwibnVtYmVyXCJcbiAgfCBcImR5bmFtaWNcIlxuICB8IFtcInNldFwiLCBBdHRyaWJ1dGVUeXBlXVxuICB8IFtcIm1hcFwiLCBBdHRyaWJ1dGVUeXBlXVxuICB8IFtcImxpc3RcIiwgQXR0cmlidXRlVHlwZV1cbiAgfCBbXCJvYmplY3RcIiwgeyBbYXR0cmlidXRlOiBzdHJpbmddOiBBdHRyaWJ1dGVUeXBlIH1dO1xuXG5leHBvcnQgdHlwZSBCbG9ja1R5cGUgPVxuICB8IHtcbiAgICAgIG5lc3RpbmdfbW9kZTogXCJzaW5nbGVcIiB8IFwibWFwXCI7XG4gICAgICBibG9jazogQmxvY2s7XG4gICAgfVxuICB8IHtcbiAgICAgIG5lc3RpbmdfbW9kZTogXCJsaXN0XCIgfCBcInNldFwiO1xuICAgICAgYmxvY2s6IEJsb2NrO1xuICAgICAgbWluX2l0ZW1zPzogbnVtYmVyO1xuICAgICAgbWF4X2l0ZW1zPzogbnVtYmVyO1xuICAgIH07XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmxvY2sge1xuICBhdHRyaWJ1dGVzOiB7IFtuYW1lOiBzdHJpbmddOiBBdHRyaWJ1dGUgfTtcbiAgYmxvY2tfdHlwZXM6IHsgW25hbWU6IHN0cmluZ106IEJsb2NrVHlwZSB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRlcnJhZm9ybVNjaGVtYSB7XG4gIHByb3ZpZGVyczogUHJvdmlkZXJTY2hlbWE7XG4gIG1vZHVsZXM6IE1vZHVsZVNjaGVtYTtcbn1cblxuaW50ZXJmYWNlIFZlcnNpb25TY2hlbWEge1xuICBwcm92aWRlcl9zZWxlY3Rpb25zOiB7IFtmcW46IHN0cmluZ106IHN0cmluZyB9O1xuICAvLyBvdGhlciBwcm9wZXJ0aWVzIGFyZW4ndCB1c2VkXG59XG5cbmludGVyZmFjZSBNb2R1bGVJbmRleEl0ZW0ge1xuICBLZXk6IHN0cmluZztcbiAgU291cmNlOiBzdHJpbmc7XG4gIERpcjogc3RyaW5nO1xuICBWZXJzaW9uPzogc3RyaW5nO1xufVxuaW50ZXJmYWNlIE1vZHVsZUluZGV4IHtcbiAgTW9kdWxlczogTW9kdWxlSW5kZXhJdGVtW107XG59XG5cbmNvbnN0IHRyYW5zZm9ybVZhcmlhYmxlcyA9ICh2YXJpYWJsZXM6IGFueSkgPT4ge1xuICBjb25zdCByZXN1bHQ6IElucHV0W10gPSBbXTtcblxuICBpZiAoIXZhcmlhYmxlcykgcmV0dXJuIHJlc3VsdDtcblxuICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXModmFyaWFibGVzKSkge1xuICAgIGNvbnN0IHZhcmlhYmxlID0gdmFyaWFibGVzW25hbWVdWzBdO1xuICAgIGxldCB2YXJpYWJsZVR5cGU6IHN0cmluZztcblxuICAgIGlmIChcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm90b3R5cGUtYnVpbHRpbnNcbiAgICAgIHZhcmlhYmxlLmhhc093blByb3BlcnR5KFwidHlwZVwiKSA9PSBmYWxzZSAmJlxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgICAgdmFyaWFibGUuaGFzT3duUHJvcGVydHkoXCJkZWZhdWx0XCIpID09IHRydWVcbiAgICApIHtcbiAgICAgIHN3aXRjaCAodHlwZW9mIHZhcmlhYmxlW1wiZGVmYXVsdFwiXSkge1xuICAgICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICAgIHZhcmlhYmxlVHlwZSA9IFwiYm9vbFwiO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgICAgICAgdmFyaWFibGVUeXBlID0gXCJudW1iZXJcIjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB2YXJpYWJsZVR5cGUgPSBcImFueVwiO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBtYXRjaGVkID0gKHZhcmlhYmxlW1widHlwZVwiXSBhcyBzdHJpbmcpPy5tYXRjaCgvXFwkXFx7KC4qKVxcfS8pO1xuICAgICAgdmFyaWFibGVUeXBlID0gbWF0Y2hlZCA/IG1hdGNoZWRbMV0gOiBcImFueVwiO1xuICAgIH1cblxuICAgIGNvbnN0IGl0ZW06IElucHV0ID0ge1xuICAgICAgbmFtZSxcbiAgICAgIHR5cGU6IHZhcmlhYmxlVHlwZSxcbiAgICAgIGRlc2NyaXB0aW9uOiB2YXJpYWJsZVtcImRlc2NyaXB0aW9uXCJdLFxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgICAgcmVxdWlyZWQ6IHZhcmlhYmxlLmhhc093blByb3BlcnR5KFwiZGVmYXVsdFwiKSA9PSBmYWxzZSxcbiAgICB9O1xuXG4gICAgaWYgKCFpdGVtLnJlcXVpcmVkKSB7XG4gICAgICBpdGVtW1wiZGVmYXVsdFwiXSA9IHZhcmlhYmxlW1wiZGVmYXVsdFwiXTtcbiAgICB9XG5cbiAgICByZXN1bHQucHVzaChpdGVtKTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCB0cmFuc2Zvcm1PdXRwdXRzID0gKG91dHB1dHM6IGFueSkgPT4ge1xuICBjb25zdCByZXN1bHQgPSBbXTtcblxuICBpZiAob3V0cHV0cykge1xuICAgIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhvdXRwdXRzKSkge1xuICAgICAgY29uc3Qgb3V0cHV0ID0gb3V0cHV0c1tuYW1lXVswXTtcblxuICAgICAgY29uc3QgaXRlbTogYW55ID0ge1xuICAgICAgICBuYW1lLFxuICAgICAgICBkZXNjcmlwdGlvbjogb3V0cHV0W1wiZGVzY3JpcHRpb25cIl0sXG4gICAgICB9O1xuXG4gICAgICByZXN1bHQucHVzaChpdGVtKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgaGFydmVzdE1vZHVsZVNjaGVtYSA9IGFzeW5jIChcbiAgd29ya2luZ0RpcmVjdG9yeTogc3RyaW5nLFxuICBtb2R1bGVzOiBzdHJpbmdbXVxuKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBhbnk+PiA9PiB7XG4gIGNvbnN0IGZpbGVOYW1lID0gcGF0aC5qb2luKFxuICAgIHdvcmtpbmdEaXJlY3RvcnksXG4gICAgXCIudGVycmFmb3JtXCIsXG4gICAgXCJtb2R1bGVzXCIsXG4gICAgXCJtb2R1bGVzLmpzb25cIlxuICApO1xuICBjb25zdCByZXN1bHQ6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuICBpZiAoIWZzLmV4aXN0c1N5bmMoZmlsZU5hbWUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYE1vZHVsZXMgd2VyZSBub3QgZ2VuZXJhdGVkIHByb3Blcmx5IC0gY291bGRuJ3QgZmluZCAke2ZpbGVOYW1lfWBcbiAgICApO1xuICB9XG5cbiAgY29uc3QgbW9kdWxlSW5kZXggPSBKU09OLnBhcnNlKFxuICAgIGZzLnJlYWRGaWxlU3luYyhmaWxlTmFtZSwgXCJ1dGYtOFwiKVxuICApIGFzIE1vZHVsZUluZGV4O1xuXG4gIGZvciAoY29uc3QgbW9kIG9mIG1vZHVsZXMpIHtcbiAgICBjb25zdCBtID0gbW9kdWxlSW5kZXguTW9kdWxlcy5maW5kKChvdGhlcikgPT4gbW9kID09PSBvdGhlci5LZXkpO1xuXG4gICAgaWYgKCFtKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkbid0IGZpbmQgJHttfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHBhcnNlZCA9IGF3YWl0IGNvbnZlcnRGaWxlcyhwYXRoLmpvaW4od29ya2luZ0RpcmVjdG9yeSwgbS5EaXIpKTtcblxuICAgIGlmICghcGFyc2VkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBNb2R1bGVzIHdlcmUgbm90IGdlbmVyYXRlZCBwcm9wZXJseSAtIGNvdWxkbid0IHBhcnNlICR7bS5EaXJ9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzY2hlbWE6IE1vZHVsZVNjaGVtYSA9IHtcbiAgICAgIGlucHV0czogdHJhbnNmb3JtVmFyaWFibGVzKHBhcnNlZC52YXJpYWJsZSksXG4gICAgICBvdXRwdXRzOiB0cmFuc2Zvcm1PdXRwdXRzKHBhcnNlZC5vdXRwdXQpLFxuICAgICAgbmFtZTogbW9kLFxuICAgIH07XG5cbiAgICByZXN1bHRbbW9kXSA9IHNjaGVtYTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIFRlcnJhZm9ybUNvbmZpZyB7XG4gIHByb3ZpZGVyPzogeyBbbmFtZTogc3RyaW5nXTogUmVjb3JkPHN0cmluZywgYW55PiB9O1xuICB0ZXJyYWZvcm06IHtcbiAgICByZXF1aXJlZF9wcm92aWRlcnM/OiB7XG4gICAgICBbbmFtZTogc3RyaW5nXTogeyBzb3VyY2U/OiBzdHJpbmc7IHZlcnNpb24/OiBzdHJpbmcgfTtcbiAgICB9O1xuICB9O1xuICBtb2R1bGU/OiB7IFtuYW1lOiBzdHJpbmddOiB7IHNvdXJjZTogc3RyaW5nOyB2ZXJzaW9uPzogc3RyaW5nIH0gfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlYWRTY2hlbWEodGFyZ2V0czogQ29uc3RydWN0c01ha2VyVGFyZ2V0W10pIHtcbiAgY29uc3QgY29uZmlnOiBUZXJyYWZvcm1Db25maWcgPSB7XG4gICAgdGVycmFmb3JtOiB7fSxcbiAgfTtcblxuICBpZiAodGFyZ2V0cy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHJvdmlkZXJTY2hlbWE6IHtcbiAgICAgICAgZm9ybWF0X3ZlcnNpb246IFwiMC4xXCIgYXMgXCIwLjFcIixcbiAgICAgICAgcHJvdmlkZXJfc2NoZW1hczoge30sXG4gICAgICB9LFxuICAgICAgbW9kdWxlU2NoZW1hOiB7fSxcbiAgICB9O1xuICB9XG5cbiAgZm9yIChjb25zdCB0YXJnZXQgb2YgdGFyZ2V0cykge1xuICAgIGlmICh0YXJnZXQuaXNNb2R1bGUpIHtcbiAgICAgIGlmICghY29uZmlnLm1vZHVsZSkgY29uZmlnLm1vZHVsZSA9IHt9O1xuICAgICAgY29uc3Qgc291cmNlID0gKHRhcmdldC5jb25zdHJhaW50IGFzIGFueSkubG9jYWxTb3VyY2UgfHwgdGFyZ2V0LnNvdXJjZTtcbiAgICAgIGNvbmZpZy5tb2R1bGVbdGFyZ2V0Lm1vZHVsZUtleV0gPSB7IHNvdXJjZTogc291cmNlIH07XG4gICAgICBpZiAodGFyZ2V0LnZlcnNpb24pIHtcbiAgICAgICAgY29uZmlnLm1vZHVsZVt0YXJnZXQubW9kdWxlS2V5XVtcInZlcnNpb25cIl0gPSB0YXJnZXQudmVyc2lvbjtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjb25maWcucHJvdmlkZXIpIGNvbmZpZy5wcm92aWRlciA9IHt9O1xuXG4gICAgICBpZiAoIWNvbmZpZy50ZXJyYWZvcm0ucmVxdWlyZWRfcHJvdmlkZXJzKSB7XG4gICAgICAgIGNvbmZpZy50ZXJyYWZvcm0ucmVxdWlyZWRfcHJvdmlkZXJzID0ge307XG4gICAgICB9XG4gICAgICBjb25maWcucHJvdmlkZXJbdGFyZ2V0Lm5hbWVdID0ge307XG4gICAgICBjb25maWcudGVycmFmb3JtLnJlcXVpcmVkX3Byb3ZpZGVyc1t0YXJnZXQubmFtZV0gPSB7XG4gICAgICAgIHZlcnNpb246IHRhcmdldC52ZXJzaW9uLFxuICAgICAgICBzb3VyY2U6IHRhcmdldC5zb3VyY2UsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuICBsZXQgcHJvdmlkZXJTY2hlbWE6IFByb3ZpZGVyU2NoZW1hID0geyBmb3JtYXRfdmVyc2lvbjogXCIwLjFcIiB9O1xuICBsZXQgbW9kdWxlU2NoZW1hOiBSZWNvcmQ8c3RyaW5nLCBNb2R1bGVTY2hlbWE+ID0ge307XG5cbiAgYXdhaXQgd2l0aFRlbXBEaXIoXCJmZXRjaFNjaGVtYVwiLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgb3V0ZGlyID0gcHJvY2Vzcy5jd2QoKTtcbiAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihvdXRkaXIsIFwibWFpbi50Zi5qc29uXCIpO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShmaWxlUGF0aCwgSlNPTi5zdHJpbmdpZnkoY29uZmlnKSk7XG5cbiAgICBhd2FpdCBleGVjKHRlcnJhZm9ybUJpbmFyeU5hbWUsIFtcImluaXRcIl0sIHsgY3dkOiBvdXRkaXIgfSk7XG4gICAgaWYgKGNvbmZpZy5wcm92aWRlcikge1xuICAgICAgcHJvdmlkZXJTY2hlbWEgPSBKU09OLnBhcnNlKFxuICAgICAgICBhd2FpdCBleGVjKHRlcnJhZm9ybUJpbmFyeU5hbWUsIFtcInByb3ZpZGVyc1wiLCBcInNjaGVtYVwiLCBcIi1qc29uXCJdLCB7XG4gICAgICAgICAgY3dkOiBvdXRkaXIsXG4gICAgICAgIH0pXG4gICAgICApIGFzIFByb3ZpZGVyU2NoZW1hO1xuXG4gICAgICBjb25zdCB2ZXJzaW9uU2NoZW1hID0gSlNPTi5wYXJzZShcbiAgICAgICAgYXdhaXQgZXhlYyh0ZXJyYWZvcm1CaW5hcnlOYW1lLCBbXCJ2ZXJzaW9uXCIsIFwiLWpzb25cIl0sIHtcbiAgICAgICAgICBjd2Q6IG91dGRpcixcbiAgICAgICAgfSlcbiAgICAgICkgYXMgVmVyc2lvblNjaGVtYTtcblxuICAgICAgcHJvdmlkZXJTY2hlbWEucHJvdmlkZXJfdmVyc2lvbnMgPSB2ZXJzaW9uU2NoZW1hLnByb3ZpZGVyX3NlbGVjdGlvbnM7XG4gICAgfVxuICAgIGlmIChjb25maWcubW9kdWxlKSB7XG4gICAgICBtb2R1bGVTY2hlbWEgPSBhd2FpdCBoYXJ2ZXN0TW9kdWxlU2NoZW1hKFxuICAgICAgICBvdXRkaXIsXG4gICAgICAgIE9iamVjdC5rZXlzKGNvbmZpZy5tb2R1bGUpXG4gICAgICApO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBwcm92aWRlclNjaGVtYSxcbiAgICBtb2R1bGVTY2hlbWEsXG4gIH07XG59XG4iXX0=