"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AttributesEmitter = void 0;
const models_1 = require("../models");
const util_1 = require("../../../util");
const custom_defaults_1 = require("../custom-defaults");
const config_1 = require("../../../config");
function titleCase(value) {
    return value[0].toUpperCase() + value.slice(1);
}
class AttributesEmitter {
    constructor(code) {
        this.code = code;
    }
    emit(att, escapeReset, escapeInput) {
        this.code.line();
        this.code.line(`// ${att.terraformName} - computed: ${att.computed}, optional: ${att.isOptional}, required: ${att.isRequired}`);
        const isStored = att.isStored;
        const hasResetMethod = isStored && !att.isRequired && att.setterType._type !== "none";
        const hasInputMethod = isStored && att.setterType._type !== "none";
        const getterType = att.getterType;
        if (getterType._type === "stored_class") {
            this.code.line(`private ${att.storageName} = ${this.storedClassInit(att)};`);
        }
        else if (isStored) {
            this.code.line(`private ${att.storageName}?: ${att.type.name}; `);
        }
        switch (getterType._type) {
            case "plain":
                this.code.openBlock(`public get ${att.name}()`);
                this.code.line(`return ${this.determineGetAttCall(att)};`);
                this.code.closeBlock();
                break;
            case "args":
                this.code.openBlock(`public ${att.name}(${getterType.args})${getterType.returnType ? ": " + getterType.returnType : ""}`);
                this.code.line(`return ${getterType.returnStatement};`);
                this.code.closeBlock();
                break;
            case "stored_class":
                this.code.openBlock(`public get ${att.name}()`);
                this.code.line(`return this.${att.storageName};`);
                this.code.closeBlock();
                break;
        }
        const setterType = att.setterType;
        switch (setterType._type) {
            case "set":
                this.code.openBlock(`public set ${att.name}(value: ${setterType.type})`);
                this.code.line(`this.${att.storageName} = value;`);
                this.code.closeBlock();
                break;
            case "put":
                this.code.openBlock(`public put${titleCase(att.name)}(value: ${setterType.type})`);
                this.code.line(`this.${att.storageName} = value;`);
                this.code.closeBlock();
                break;
            case "stored_class":
                this.code.openBlock(`public put${titleCase(att.name)}(value: ${setterType.type})`);
                this.code.line(`this.${att.storageName}.internalValue = value;`);
                this.code.closeBlock();
                break;
        }
        if (hasResetMethod) {
            this.code.openBlock(`public ${this.getResetName(att.name, escapeReset)}()`);
            if (setterType._type === "stored_class") {
                this.code.line(`this.${att.storageName}.internalValue = undefined;`);
            }
            else {
                this.code.line(`this.${att.storageName} = undefined;`);
            }
            this.code.closeBlock();
        }
        if (hasInputMethod) {
            this.code.line(`// Temporarily expose input value. Use with caution.`);
            this.code.openBlock(`public get ${this.getInputName(att, escapeInput)}()`);
            if (setterType._type === "stored_class") {
                this.code.line(`return this.${att.storageName}.internalValue;`);
            }
            else {
                this.code.line(`return this.${att.storageName};`);
            }
            this.code.closeBlock();
        }
    }
    // returns an invocation of a stored class, e.g. 'new DeplotmentMetadataOutputReference(this, "metadata")'
    storedClassInit(att) {
        if ((att.type.isList || att.type.isSet) && !att.type.isSingleItem) {
            // list/set
            if (att.type.struct) {
                return `new ${att.type.struct.name}List(this, "${att.terraformName}", ${att.type.isSet})`;
            }
            else {
                return `new ${att.type.name}List(this, "${att.terraformName}", ${att.type.isSet})`;
            }
        }
        else if (att.type.isMap) {
            if (att.type.struct) {
                return `new ${att.type.struct.name}Map(this, "${att.terraformName}")`;
            }
            else {
                return `new ${att.type.name}(this, "${att.terraformName}")`;
            }
        }
        else {
            if (att.type.name.includes("IResolvable")) {
                return `new ${att.type.innerType}OutputReference(this, "${att.terraformName}")`;
            }
            else {
                return `new ${att.type.name}OutputReference(this, "${att.terraformName}")`;
            }
        }
    }
    determineGetAttCall(att) {
        if (att.isProvider) {
            return `this.${att.storageName}`;
        }
        const type = att.type;
        if (type.isString) {
            return `this.getStringAttribute('${att.terraformName}')`;
        }
        if (type.isStringList) {
            return `this.getListAttribute('${att.terraformName}')`;
        }
        if (type.isNumberList) {
            return `this.getNumberListAttribute('${att.terraformName}')`;
        }
        if (type.isStringSet) {
            return `cdktf.Fn.tolist(this.getListAttribute('${att.terraformName}'))`;
        }
        if (type.isNumberSet) {
            return `cdktf.Token.asNumberList(cdktf.Fn.tolist(this.getNumberListAttribute('${att.terraformName}')))`;
        }
        if (type.isNumber) {
            return `this.getNumberAttribute('${att.terraformName}')`;
        }
        if (type.isBoolean) {
            return `this.getBooleanAttribute('${att.terraformName}')`;
        }
        if (type.isMap) {
            return `this.get${util_1.uppercaseFirst(att.mapType)}MapAttribute('${att.terraformName}')`;
        }
        config_1.logger.debug(`The attribute isn't implemented yet: ${JSON.stringify(att)}`);
        this.code.line(`// Getting the computed value is not yet implemented`);
        if (type.isSet) {
            // Token.asAny is required because tolist returns an Array encoded token which the listMapper
            // would try to map over when this is passed to another resource. With Token.asAny() it is left
            // as is by the listMapper and is later properly resolved to a reference
            // (this only works in TypeScript currently, same as for referencing lists
            // [see "interpolationForAttribute(...)" further below])
            return `cdktf.Token.asAny(cdktf.Fn.tolist(this.interpolationForAttribute('${att.terraformName}')))`;
        }
        return `this.interpolationForAttribute('${att.terraformName}')`;
    }
    needsInputEscape(att, attributes) {
        return (attributes.find((a) => a.terraformName.match(`^${att.terraformName}_input$`)) instanceof models_1.AttributeModel);
    }
    getInputName(att, escape) {
        if (escape) {
            return `${att.name}TfInput`;
        }
        else {
            return `${att.name}Input`;
        }
    }
    needsResetEscape(att, attributes) {
        return (attributes.find((a) => a.terraformName.match(`^reset_${att.terraformName}$`)) instanceof models_1.AttributeModel);
    }
    getResetName(name, escape) {
        if (!name)
            return name;
        if (escape) {
            return `resetTf${titleCase(name)}`;
        }
        else {
            return `reset${titleCase(name)}`;
        }
    }
    emitToTerraform(att, isStruct) {
        var _a, _b;
        const type = att.type;
        const context = isStruct ? "struct!" : "this";
        const name = isStruct ? att.name : att.storageName;
        const customDefault = custom_defaults_1.CUSTOM_DEFAULTS[att.terraformFullName];
        const varReference = `${context}.${name}${!isStruct &&
            type.isComplex &&
            !att.isProvider &&
            (((_a = type.struct) === null || _a === void 0 ? void 0 : _a.isClass) || att.getterType._type === "stored_class")
            ? ".internalValue"
            : ""}`;
        const defaultCheck = customDefault !== undefined
            ? `${varReference} === undefined ? ${customDefault} : `
            : "";
        const isBlockType = att.type.isBlock;
        switch (true) {
            case type.isSet && type.isMap:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.listMapper(cdktf.hashMapper(cdktf.${att.mapType}ToTerraform), ${isBlockType})(${varReference}),`);
                break;
            case type.isList && type.isMap:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.listMapper(cdktf.hashMapper(cdktf.${att.mapType}ToTerraform), ${isBlockType})(${varReference}),`);
                break;
            case type.isStringSet || type.isNumberSet || type.isBooleanSet:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.listMapper(cdktf.${util_1.downcaseFirst(type.innerType)}ToTerraform, ${isBlockType})(${varReference}),`);
                break;
            case type.isStringList || type.isNumberList || type.isBooleanList:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.listMapper(cdktf.${util_1.downcaseFirst(type.innerType)}ToTerraform, ${isBlockType})(${varReference}),`);
                break;
            case type.isSet && !type.isSingleItem:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.listMapper(${util_1.downcaseFirst(type.innerType)}ToTerraform, ${isBlockType})(${varReference}),`);
                break;
            case type.isList && !type.isSingleItem:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.listMapper(${util_1.downcaseFirst(type.innerType)}ToTerraform, ${isBlockType})(${varReference}),`);
                break;
            case type.isMap:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.hashMapper(cdktf.${att.mapType}ToTerraform)(${varReference}),`);
                break;
            case type.isString:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.stringToTerraform(${varReference}),`);
                break;
            case type.isNumber:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.numberToTerraform(${varReference}),`);
                break;
            case type.isBoolean:
                this.code.line(`${att.terraformName}: ${defaultCheck}cdktf.booleanToTerraform(${varReference}),`);
                break;
            case type.isComplex && !((_b = type.struct) === null || _b === void 0 ? void 0 : _b.isClass) && !type.isSingleItem:
                this.code.line(`${att.terraformName}: ${defaultCheck}${util_1.downcaseFirst(type.struct.name)}ToTerraform(${varReference}),`);
                break;
            default:
                this.code.line(`${att.terraformName}: ${defaultCheck}${util_1.downcaseFirst(type.name)}ToTerraform(${varReference}),`);
                break;
        }
    }
}
exports.AttributesEmitter = AttributesEmitter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0cmlidXRlcy1lbWl0dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXR0cmlidXRlcy1lbWl0dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHNDQUEyQztBQUMzQyx3Q0FBOEQ7QUFDOUQsd0RBQXFEO0FBQ3JELDRDQUF5QztBQUV6QyxTQUFTLFNBQVMsQ0FBQyxLQUFhO0lBQzlCLE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDakQsQ0FBQztBQUVELE1BQWEsaUJBQWlCO0lBQzVCLFlBQW9CLElBQWU7UUFBZixTQUFJLEdBQUosSUFBSSxDQUFXO0lBQUcsQ0FBQztJQUVoQyxJQUFJLENBQUMsR0FBbUIsRUFBRSxXQUFvQixFQUFFLFdBQW9CO1FBQ3pFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQ1osTUFBTSxHQUFHLENBQUMsYUFBYSxnQkFBZ0IsR0FBRyxDQUFDLFFBQVEsZUFBZSxHQUFHLENBQUMsVUFBVSxlQUFlLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FDaEgsQ0FBQztRQUVGLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7UUFDOUIsTUFBTSxjQUFjLEdBQ2xCLFFBQVEsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEtBQUssTUFBTSxDQUFDO1FBQ2pFLE1BQU0sY0FBYyxHQUFHLFFBQVEsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLEtBQUssS0FBSyxNQUFNLENBQUM7UUFFbkUsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQztRQUVsQyxJQUFJLFVBQVUsQ0FBQyxLQUFLLEtBQUssY0FBYyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUNaLFdBQVcsR0FBRyxDQUFDLFdBQVcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQzdELENBQUM7U0FDSDthQUFNLElBQUksUUFBUSxFQUFFO1lBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLFdBQVcsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUM7U0FDbkU7UUFFRCxRQUFRLFVBQVUsQ0FBQyxLQUFLLEVBQUU7WUFDeEIsS0FBSyxPQUFPO2dCQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUM7Z0JBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDM0QsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDdkIsTUFBTTtZQUVSLEtBQUssTUFBTTtnQkFDVCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FDakIsVUFBVSxHQUFHLENBQUMsSUFBSSxJQUFJLFVBQVUsQ0FBQyxJQUFJLElBQ25DLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUN6RCxFQUFFLENBQ0gsQ0FBQztnQkFDRixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLFVBQVUsQ0FBQyxlQUFlLEdBQUcsQ0FBQyxDQUFDO2dCQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUN2QixNQUFNO1lBRVIsS0FBSyxjQUFjO2dCQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDO2dCQUNoRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO2dCQUNsRCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUN2QixNQUFNO1NBQ1Q7UUFFRCxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDO1FBRWxDLFFBQVEsVUFBVSxDQUFDLEtBQUssRUFBRTtZQUN4QixLQUFLLEtBQUs7Z0JBQ1IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQ2pCLGNBQWMsR0FBRyxDQUFDLElBQUksV0FBVyxVQUFVLENBQUMsSUFBSSxHQUFHLENBQ3BELENBQUM7Z0JBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsV0FBVyxXQUFXLENBQUMsQ0FBQztnQkFDbkQsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDdkIsTUFBTTtZQUVSLEtBQUssS0FBSztnQkFDUixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FDakIsYUFBYSxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLFVBQVUsQ0FBQyxJQUFJLEdBQUcsQ0FDOUQsQ0FBQztnQkFDRixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxXQUFXLFdBQVcsQ0FBQyxDQUFDO2dCQUNuRCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUN2QixNQUFNO1lBRVIsS0FBSyxjQUFjO2dCQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FDakIsYUFBYSxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLFVBQVUsQ0FBQyxJQUFJLEdBQUcsQ0FDOUQsQ0FBQztnQkFDRixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxXQUFXLHlCQUF5QixDQUFDLENBQUM7Z0JBQ2pFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ3ZCLE1BQU07U0FDVDtRQUVELElBQUksY0FBYyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUNqQixVQUFVLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsSUFBSSxDQUN2RCxDQUFDO1lBRUYsSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLGNBQWMsRUFBRTtnQkFDdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsV0FBVyw2QkFBNkIsQ0FBQyxDQUFDO2FBQ3RFO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLFdBQVcsZUFBZSxDQUFDLENBQUM7YUFDeEQ7WUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ3hCO1FBRUQsSUFBSSxjQUFjLEVBQUU7WUFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsc0RBQXNELENBQUMsQ0FBQztZQUN2RSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FDakIsY0FBYyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsSUFBSSxDQUN0RCxDQUFDO1lBRUYsSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLGNBQWMsRUFBRTtnQkFDdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxHQUFHLENBQUMsV0FBVyxpQkFBaUIsQ0FBQyxDQUFDO2FBQ2pFO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsR0FBRyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7YUFDbkQ7WUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ3hCO0lBQ0gsQ0FBQztJQUVELDBHQUEwRztJQUNsRyxlQUFlLENBQUMsR0FBbUI7UUFDekMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqRSxXQUFXO1lBQ1gsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDbkIsT0FBTyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksZUFBZSxHQUFHLENBQUMsYUFBYSxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUM7YUFDM0Y7aUJBQU07Z0JBQ0wsT0FBTyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxlQUFlLEdBQUcsQ0FBQyxhQUFhLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQzthQUNwRjtTQUNGO2FBQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUN6QixJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNuQixPQUFPLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxjQUFjLEdBQUcsQ0FBQyxhQUFhLElBQUksQ0FBQzthQUN2RTtpQkFBTTtnQkFDTCxPQUFPLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLFdBQVcsR0FBRyxDQUFDLGFBQWEsSUFBSSxDQUFDO2FBQzdEO1NBQ0Y7YUFBTTtZQUNMLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxFQUFFO2dCQUN6QyxPQUFPLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLDBCQUEwQixHQUFHLENBQUMsYUFBYSxJQUFJLENBQUM7YUFDakY7aUJBQU07Z0JBQ0wsT0FBTyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSwwQkFBMEIsR0FBRyxDQUFDLGFBQWEsSUFBSSxDQUFDO2FBQzVFO1NBQ0Y7SUFDSCxDQUFDO0lBRU0sbUJBQW1CLENBQUMsR0FBbUI7UUFDNUMsSUFBSSxHQUFHLENBQUMsVUFBVSxFQUFFO1lBQ2xCLE9BQU8sUUFBUSxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDbEM7UUFFRCxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3RCLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNqQixPQUFPLDRCQUE0QixHQUFHLENBQUMsYUFBYSxJQUFJLENBQUM7U0FDMUQ7UUFDRCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsT0FBTywwQkFBMEIsR0FBRyxDQUFDLGFBQWEsSUFBSSxDQUFDO1NBQ3hEO1FBQ0QsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JCLE9BQU8sZ0NBQWdDLEdBQUcsQ0FBQyxhQUFhLElBQUksQ0FBQztTQUM5RDtRQUNELElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNwQixPQUFPLDBDQUEwQyxHQUFHLENBQUMsYUFBYSxLQUFLLENBQUM7U0FDekU7UUFDRCxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDcEIsT0FBTyx5RUFBeUUsR0FBRyxDQUFDLGFBQWEsTUFBTSxDQUFDO1NBQ3pHO1FBQ0QsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2pCLE9BQU8sNEJBQTRCLEdBQUcsQ0FBQyxhQUFhLElBQUksQ0FBQztTQUMxRDtRQUNELElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixPQUFPLDZCQUE2QixHQUFHLENBQUMsYUFBYSxJQUFJLENBQUM7U0FDM0Q7UUFDRCxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxPQUFPLFdBQVcscUJBQWMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGlCQUMzQyxHQUFHLENBQUMsYUFDTixJQUFJLENBQUM7U0FDTjtRQUVELGVBQU0sQ0FBQyxLQUFLLENBQUMsd0NBQXdDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTVFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHNEQUFzRCxDQUFDLENBQUM7UUFDdkUsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2QsNkZBQTZGO1lBQzdGLCtGQUErRjtZQUMvRix3RUFBd0U7WUFDeEUsMEVBQTBFO1lBQzFFLHdEQUF3RDtZQUN4RCxPQUFPLHFFQUFxRSxHQUFHLENBQUMsYUFBYSxNQUFNLENBQUM7U0FDckc7UUFDRCxPQUFPLG1DQUFtQyxHQUFHLENBQUMsYUFBYSxJQUFJLENBQUM7SUFDbEUsQ0FBQztJQUVNLGdCQUFnQixDQUNyQixHQUFtQixFQUNuQixVQUE0QjtRQUU1QixPQUFPLENBQ0wsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ3BCLENBQUMsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLGFBQWEsU0FBUyxDQUFDLENBQ3RELFlBQVksdUJBQWMsQ0FDNUIsQ0FBQztJQUNKLENBQUM7SUFFTSxZQUFZLENBQUMsR0FBbUIsRUFBRSxNQUFlO1FBQ3RELElBQUksTUFBTSxFQUFFO1lBQ1YsT0FBTyxHQUFHLEdBQUcsQ0FBQyxJQUFJLFNBQVMsQ0FBQztTQUM3QjthQUFNO1lBQ0wsT0FBTyxHQUFHLEdBQUcsQ0FBQyxJQUFJLE9BQU8sQ0FBQztTQUMzQjtJQUNILENBQUM7SUFFTSxnQkFBZ0IsQ0FDckIsR0FBbUIsRUFDbkIsVUFBNEI7UUFFNUIsT0FBTyxDQUNMLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUNwQixDQUFDLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUN0RCxZQUFZLHVCQUFjLENBQzVCLENBQUM7SUFDSixDQUFDO0lBRU0sWUFBWSxDQUFDLElBQVksRUFBRSxNQUFlO1FBQy9DLElBQUksQ0FBQyxJQUFJO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFDdkIsSUFBSSxNQUFNLEVBQUU7WUFDVixPQUFPLFVBQVUsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7U0FDcEM7YUFBTTtZQUNMLE9BQU8sUUFBUSxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztTQUNsQztJQUNILENBQUM7SUFFTSxlQUFlLENBQUMsR0FBbUIsRUFBRSxRQUFpQjs7UUFDM0QsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUN0QixNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQzlDLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztRQUNuRCxNQUFNLGFBQWEsR0FBRyxpQ0FBZSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRTdELE1BQU0sWUFBWSxHQUFHLEdBQUcsT0FBTyxJQUFJLElBQUksR0FDckMsQ0FBQyxRQUFRO1lBQ1QsSUFBSSxDQUFDLFNBQVM7WUFDZCxDQUFDLEdBQUcsQ0FBQyxVQUFVO1lBQ2YsQ0FBQyxPQUFBLElBQUksQ0FBQyxNQUFNLDBDQUFFLE9BQU8sS0FBSSxHQUFHLENBQUMsVUFBVSxDQUFDLEtBQUssS0FBSyxjQUFjLENBQUM7WUFDL0QsQ0FBQyxDQUFDLGdCQUFnQjtZQUNsQixDQUFDLENBQUMsRUFDTixFQUFFLENBQUM7UUFDSCxNQUFNLFlBQVksR0FDaEIsYUFBYSxLQUFLLFNBQVM7WUFDekIsQ0FBQyxDQUFDLEdBQUcsWUFBWSxvQkFBb0IsYUFBYSxLQUFLO1lBQ3ZELENBQUMsQ0FBQyxFQUFFLENBQUM7UUFFVCxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUVyQyxRQUFRLElBQUksRUFBRTtZQUNaLEtBQUssSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSztnQkFDM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQ1osR0FBRyxHQUFHLENBQUMsYUFBYSxLQUFLLFlBQVksMkNBQTJDLEdBQUcsQ0FBQyxPQUFPLGlCQUFpQixXQUFXLEtBQUssWUFBWSxJQUFJLENBQzdJLENBQUM7Z0JBQ0YsTUFBTTtZQUNSLEtBQUssSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsS0FBSztnQkFDNUIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQ1osR0FBRyxHQUFHLENBQUMsYUFBYSxLQUFLLFlBQVksMkNBQTJDLEdBQUcsQ0FBQyxPQUFPLGlCQUFpQixXQUFXLEtBQUssWUFBWSxJQUFJLENBQzdJLENBQUM7Z0JBQ0YsTUFBTTtZQUNSLEtBQUssSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxZQUFZO2dCQUM1RCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDWixHQUNFLEdBQUcsQ0FBQyxhQUNOLEtBQUssWUFBWSwwQkFBMEIsb0JBQWEsQ0FDdEQsSUFBSSxDQUFDLFNBQVMsQ0FDZixnQkFBZ0IsV0FBVyxLQUFLLFlBQVksSUFBSSxDQUNsRCxDQUFDO2dCQUNGLE1BQU07WUFDUixLQUFLLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsYUFBYTtnQkFDL0QsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQ1osR0FDRSxHQUFHLENBQUMsYUFDTixLQUFLLFlBQVksMEJBQTBCLG9CQUFhLENBQ3RELElBQUksQ0FBQyxTQUFTLENBQ2YsZ0JBQWdCLFdBQVcsS0FBSyxZQUFZLElBQUksQ0FDbEQsQ0FBQztnQkFDRixNQUFNO1lBQ1IsS0FBSyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVk7Z0JBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUNaLEdBQ0UsR0FBRyxDQUFDLGFBQ04sS0FBSyxZQUFZLG9CQUFvQixvQkFBYSxDQUNoRCxJQUFJLENBQUMsU0FBUyxDQUNmLGdCQUFnQixXQUFXLEtBQUssWUFBWSxJQUFJLENBQ2xELENBQUM7Z0JBQ0YsTUFBTTtZQUNSLEtBQUssSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZO2dCQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDWixHQUNFLEdBQUcsQ0FBQyxhQUNOLEtBQUssWUFBWSxvQkFBb0Isb0JBQWEsQ0FDaEQsSUFBSSxDQUFDLFNBQVMsQ0FDZixnQkFBZ0IsV0FBVyxLQUFLLFlBQVksSUFBSSxDQUNsRCxDQUFDO2dCQUNGLE1BQU07WUFDUixLQUFLLElBQUksQ0FBQyxLQUFLO2dCQUNiLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUNaLEdBQUcsR0FBRyxDQUFDLGFBQWEsS0FBSyxZQUFZLDBCQUEwQixHQUFHLENBQUMsT0FBTyxnQkFBZ0IsWUFBWSxJQUFJLENBQzNHLENBQUM7Z0JBQ0YsTUFBTTtZQUNSLEtBQUssSUFBSSxDQUFDLFFBQVE7Z0JBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUNaLEdBQUcsR0FBRyxDQUFDLGFBQWEsS0FBSyxZQUFZLDJCQUEyQixZQUFZLElBQUksQ0FDakYsQ0FBQztnQkFDRixNQUFNO1lBQ1IsS0FBSyxJQUFJLENBQUMsUUFBUTtnQkFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQ1osR0FBRyxHQUFHLENBQUMsYUFBYSxLQUFLLFlBQVksMkJBQTJCLFlBQVksSUFBSSxDQUNqRixDQUFDO2dCQUNGLE1BQU07WUFDUixLQUFLLElBQUksQ0FBQyxTQUFTO2dCQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDWixHQUFHLEdBQUcsQ0FBQyxhQUFhLEtBQUssWUFBWSw0QkFBNEIsWUFBWSxJQUFJLENBQ2xGLENBQUM7Z0JBQ0YsTUFBTTtZQUNSLEtBQUssSUFBSSxDQUFDLFNBQVMsSUFBSSxRQUFDLElBQUksQ0FBQyxNQUFNLDBDQUFFLE9BQU8sQ0FBQSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVk7Z0JBQ2hFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUNaLEdBQUcsR0FBRyxDQUFDLGFBQWEsS0FBSyxZQUFZLEdBQUcsb0JBQWEsQ0FDbkQsSUFBSSxDQUFDLE1BQU8sQ0FBQyxJQUFJLENBQ2xCLGVBQWUsWUFBWSxJQUFJLENBQ2pDLENBQUM7Z0JBQ0YsTUFBTTtZQUNSO2dCQUNFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUNaLEdBQUcsR0FBRyxDQUFDLGFBQWEsS0FBSyxZQUFZLEdBQUcsb0JBQWEsQ0FDbkQsSUFBSSxDQUFDLElBQUksQ0FDVixlQUFlLFlBQVksSUFBSSxDQUNqQyxDQUFDO2dCQUNGLE1BQU07U0FDVDtJQUNILENBQUM7Q0FDRjtBQWhVRCw4Q0FnVUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb2RlTWFrZXIgfSBmcm9tIFwiY29kZW1ha2VyXCI7XG5pbXBvcnQgeyBBdHRyaWJ1dGVNb2RlbCB9IGZyb20gXCIuLi9tb2RlbHNcIjtcbmltcG9ydCB7IGRvd25jYXNlRmlyc3QsIHVwcGVyY2FzZUZpcnN0IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxcIjtcbmltcG9ydCB7IENVU1RPTV9ERUZBVUxUUyB9IGZyb20gXCIuLi9jdXN0b20tZGVmYXVsdHNcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCIuLi8uLi8uLi9jb25maWdcIjtcblxuZnVuY3Rpb24gdGl0bGVDYXNlKHZhbHVlOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHZhbHVlWzBdLnRvVXBwZXJDYXNlKCkgKyB2YWx1ZS5zbGljZSgxKTtcbn1cblxuZXhwb3J0IGNsYXNzIEF0dHJpYnV0ZXNFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb2RlOiBDb2RlTWFrZXIpIHt9XG5cbiAgcHVibGljIGVtaXQoYXR0OiBBdHRyaWJ1dGVNb2RlbCwgZXNjYXBlUmVzZXQ6IGJvb2xlYW4sIGVzY2FwZUlucHV0OiBib29sZWFuKSB7XG4gICAgdGhpcy5jb2RlLmxpbmUoKTtcbiAgICB0aGlzLmNvZGUubGluZShcbiAgICAgIGAvLyAke2F0dC50ZXJyYWZvcm1OYW1lfSAtIGNvbXB1dGVkOiAke2F0dC5jb21wdXRlZH0sIG9wdGlvbmFsOiAke2F0dC5pc09wdGlvbmFsfSwgcmVxdWlyZWQ6ICR7YXR0LmlzUmVxdWlyZWR9YFxuICAgICk7XG5cbiAgICBjb25zdCBpc1N0b3JlZCA9IGF0dC5pc1N0b3JlZDtcbiAgICBjb25zdCBoYXNSZXNldE1ldGhvZCA9XG4gICAgICBpc1N0b3JlZCAmJiAhYXR0LmlzUmVxdWlyZWQgJiYgYXR0LnNldHRlclR5cGUuX3R5cGUgIT09IFwibm9uZVwiO1xuICAgIGNvbnN0IGhhc0lucHV0TWV0aG9kID0gaXNTdG9yZWQgJiYgYXR0LnNldHRlclR5cGUuX3R5cGUgIT09IFwibm9uZVwiO1xuXG4gICAgY29uc3QgZ2V0dGVyVHlwZSA9IGF0dC5nZXR0ZXJUeXBlO1xuXG4gICAgaWYgKGdldHRlclR5cGUuX3R5cGUgPT09IFwic3RvcmVkX2NsYXNzXCIpIHtcbiAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICBgcHJpdmF0ZSAke2F0dC5zdG9yYWdlTmFtZX0gPSAke3RoaXMuc3RvcmVkQ2xhc3NJbml0KGF0dCl9O2BcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChpc1N0b3JlZCkge1xuICAgICAgdGhpcy5jb2RlLmxpbmUoYHByaXZhdGUgJHthdHQuc3RvcmFnZU5hbWV9PzogJHthdHQudHlwZS5uYW1lfTsgYCk7XG4gICAgfVxuXG4gICAgc3dpdGNoIChnZXR0ZXJUeXBlLl90eXBlKSB7XG4gICAgICBjYXNlIFwicGxhaW5cIjpcbiAgICAgICAgdGhpcy5jb2RlLm9wZW5CbG9jayhgcHVibGljIGdldCAke2F0dC5uYW1lfSgpYCk7XG4gICAgICAgIHRoaXMuY29kZS5saW5lKGByZXR1cm4gJHt0aGlzLmRldGVybWluZUdldEF0dENhbGwoYXR0KX07YCk7XG4gICAgICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIFwiYXJnc1wiOlxuICAgICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKFxuICAgICAgICAgIGBwdWJsaWMgJHthdHQubmFtZX0oJHtnZXR0ZXJUeXBlLmFyZ3N9KSR7XG4gICAgICAgICAgICBnZXR0ZXJUeXBlLnJldHVyblR5cGUgPyBcIjogXCIgKyBnZXR0ZXJUeXBlLnJldHVyblR5cGUgOiBcIlwiXG4gICAgICAgICAgfWBcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoYHJldHVybiAke2dldHRlclR5cGUucmV0dXJuU3RhdGVtZW50fTtgKTtcbiAgICAgICAgdGhpcy5jb2RlLmNsb3NlQmxvY2soKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgXCJzdG9yZWRfY2xhc3NcIjpcbiAgICAgICAgdGhpcy5jb2RlLm9wZW5CbG9jayhgcHVibGljIGdldCAke2F0dC5uYW1lfSgpYCk7XG4gICAgICAgIHRoaXMuY29kZS5saW5lKGByZXR1cm4gdGhpcy4ke2F0dC5zdG9yYWdlTmFtZX07YCk7XG4gICAgICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGNvbnN0IHNldHRlclR5cGUgPSBhdHQuc2V0dGVyVHlwZTtcblxuICAgIHN3aXRjaCAoc2V0dGVyVHlwZS5fdHlwZSkge1xuICAgICAgY2FzZSBcInNldFwiOlxuICAgICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKFxuICAgICAgICAgIGBwdWJsaWMgc2V0ICR7YXR0Lm5hbWV9KHZhbHVlOiAke3NldHRlclR5cGUudHlwZX0pYFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmNvZGUubGluZShgdGhpcy4ke2F0dC5zdG9yYWdlTmFtZX0gPSB2YWx1ZTtgKTtcbiAgICAgICAgdGhpcy5jb2RlLmNsb3NlQmxvY2soKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgXCJwdXRcIjpcbiAgICAgICAgdGhpcy5jb2RlLm9wZW5CbG9jayhcbiAgICAgICAgICBgcHVibGljIHB1dCR7dGl0bGVDYXNlKGF0dC5uYW1lKX0odmFsdWU6ICR7c2V0dGVyVHlwZS50eXBlfSlgXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuY29kZS5saW5lKGB0aGlzLiR7YXR0LnN0b3JhZ2VOYW1lfSA9IHZhbHVlO2ApO1xuICAgICAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBcInN0b3JlZF9jbGFzc1wiOlxuICAgICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKFxuICAgICAgICAgIGBwdWJsaWMgcHV0JHt0aXRsZUNhc2UoYXR0Lm5hbWUpfSh2YWx1ZTogJHtzZXR0ZXJUeXBlLnR5cGV9KWBcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoYHRoaXMuJHthdHQuc3RvcmFnZU5hbWV9LmludGVybmFsVmFsdWUgPSB2YWx1ZTtgKTtcbiAgICAgICAgdGhpcy5jb2RlLmNsb3NlQmxvY2soKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgaWYgKGhhc1Jlc2V0TWV0aG9kKSB7XG4gICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKFxuICAgICAgICBgcHVibGljICR7dGhpcy5nZXRSZXNldE5hbWUoYXR0Lm5hbWUsIGVzY2FwZVJlc2V0KX0oKWBcbiAgICAgICk7XG5cbiAgICAgIGlmIChzZXR0ZXJUeXBlLl90eXBlID09PSBcInN0b3JlZF9jbGFzc1wiKSB7XG4gICAgICAgIHRoaXMuY29kZS5saW5lKGB0aGlzLiR7YXR0LnN0b3JhZ2VOYW1lfS5pbnRlcm5hbFZhbHVlID0gdW5kZWZpbmVkO2ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoYHRoaXMuJHthdHQuc3RvcmFnZU5hbWV9ID0gdW5kZWZpbmVkO2ApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuICAgIH1cblxuICAgIGlmIChoYXNJbnB1dE1ldGhvZCkge1xuICAgICAgdGhpcy5jb2RlLmxpbmUoYC8vIFRlbXBvcmFyaWx5IGV4cG9zZSBpbnB1dCB2YWx1ZS4gVXNlIHdpdGggY2F1dGlvbi5gKTtcbiAgICAgIHRoaXMuY29kZS5vcGVuQmxvY2soXG4gICAgICAgIGBwdWJsaWMgZ2V0ICR7dGhpcy5nZXRJbnB1dE5hbWUoYXR0LCBlc2NhcGVJbnB1dCl9KClgXG4gICAgICApO1xuXG4gICAgICBpZiAoc2V0dGVyVHlwZS5fdHlwZSA9PT0gXCJzdG9yZWRfY2xhc3NcIikge1xuICAgICAgICB0aGlzLmNvZGUubGluZShgcmV0dXJuIHRoaXMuJHthdHQuc3RvcmFnZU5hbWV9LmludGVybmFsVmFsdWU7YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNvZGUubGluZShgcmV0dXJuIHRoaXMuJHthdHQuc3RvcmFnZU5hbWV9O2ApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuICAgIH1cbiAgfVxuXG4gIC8vIHJldHVybnMgYW4gaW52b2NhdGlvbiBvZiBhIHN0b3JlZCBjbGFzcywgZS5nLiAnbmV3IERlcGxvdG1lbnRNZXRhZGF0YU91dHB1dFJlZmVyZW5jZSh0aGlzLCBcIm1ldGFkYXRhXCIpJ1xuICBwcml2YXRlIHN0b3JlZENsYXNzSW5pdChhdHQ6IEF0dHJpYnV0ZU1vZGVsKSB7XG4gICAgaWYgKChhdHQudHlwZS5pc0xpc3QgfHwgYXR0LnR5cGUuaXNTZXQpICYmICFhdHQudHlwZS5pc1NpbmdsZUl0ZW0pIHtcbiAgICAgIC8vIGxpc3Qvc2V0XG4gICAgICBpZiAoYXR0LnR5cGUuc3RydWN0KSB7XG4gICAgICAgIHJldHVybiBgbmV3ICR7YXR0LnR5cGUuc3RydWN0Lm5hbWV9TGlzdCh0aGlzLCBcIiR7YXR0LnRlcnJhZm9ybU5hbWV9XCIsICR7YXR0LnR5cGUuaXNTZXR9KWA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gYG5ldyAke2F0dC50eXBlLm5hbWV9TGlzdCh0aGlzLCBcIiR7YXR0LnRlcnJhZm9ybU5hbWV9XCIsICR7YXR0LnR5cGUuaXNTZXR9KWA7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChhdHQudHlwZS5pc01hcCkge1xuICAgICAgaWYgKGF0dC50eXBlLnN0cnVjdCkge1xuICAgICAgICByZXR1cm4gYG5ldyAke2F0dC50eXBlLnN0cnVjdC5uYW1lfU1hcCh0aGlzLCBcIiR7YXR0LnRlcnJhZm9ybU5hbWV9XCIpYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBgbmV3ICR7YXR0LnR5cGUubmFtZX0odGhpcywgXCIke2F0dC50ZXJyYWZvcm1OYW1lfVwiKWA7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChhdHQudHlwZS5uYW1lLmluY2x1ZGVzKFwiSVJlc29sdmFibGVcIikpIHtcbiAgICAgICAgcmV0dXJuIGBuZXcgJHthdHQudHlwZS5pbm5lclR5cGV9T3V0cHV0UmVmZXJlbmNlKHRoaXMsIFwiJHthdHQudGVycmFmb3JtTmFtZX1cIilgO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGBuZXcgJHthdHQudHlwZS5uYW1lfU91dHB1dFJlZmVyZW5jZSh0aGlzLCBcIiR7YXR0LnRlcnJhZm9ybU5hbWV9XCIpYDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZGV0ZXJtaW5lR2V0QXR0Q2FsbChhdHQ6IEF0dHJpYnV0ZU1vZGVsKTogc3RyaW5nIHtcbiAgICBpZiAoYXR0LmlzUHJvdmlkZXIpIHtcbiAgICAgIHJldHVybiBgdGhpcy4ke2F0dC5zdG9yYWdlTmFtZX1gO1xuICAgIH1cblxuICAgIGNvbnN0IHR5cGUgPSBhdHQudHlwZTtcbiAgICBpZiAodHlwZS5pc1N0cmluZykge1xuICAgICAgcmV0dXJuIGB0aGlzLmdldFN0cmluZ0F0dHJpYnV0ZSgnJHthdHQudGVycmFmb3JtTmFtZX0nKWA7XG4gICAgfVxuICAgIGlmICh0eXBlLmlzU3RyaW5nTGlzdCkge1xuICAgICAgcmV0dXJuIGB0aGlzLmdldExpc3RBdHRyaWJ1dGUoJyR7YXR0LnRlcnJhZm9ybU5hbWV9JylgO1xuICAgIH1cbiAgICBpZiAodHlwZS5pc051bWJlckxpc3QpIHtcbiAgICAgIHJldHVybiBgdGhpcy5nZXROdW1iZXJMaXN0QXR0cmlidXRlKCcke2F0dC50ZXJyYWZvcm1OYW1lfScpYDtcbiAgICB9XG4gICAgaWYgKHR5cGUuaXNTdHJpbmdTZXQpIHtcbiAgICAgIHJldHVybiBgY2RrdGYuRm4udG9saXN0KHRoaXMuZ2V0TGlzdEF0dHJpYnV0ZSgnJHthdHQudGVycmFmb3JtTmFtZX0nKSlgO1xuICAgIH1cbiAgICBpZiAodHlwZS5pc051bWJlclNldCkge1xuICAgICAgcmV0dXJuIGBjZGt0Zi5Ub2tlbi5hc051bWJlckxpc3QoY2RrdGYuRm4udG9saXN0KHRoaXMuZ2V0TnVtYmVyTGlzdEF0dHJpYnV0ZSgnJHthdHQudGVycmFmb3JtTmFtZX0nKSkpYDtcbiAgICB9XG4gICAgaWYgKHR5cGUuaXNOdW1iZXIpIHtcbiAgICAgIHJldHVybiBgdGhpcy5nZXROdW1iZXJBdHRyaWJ1dGUoJyR7YXR0LnRlcnJhZm9ybU5hbWV9JylgO1xuICAgIH1cbiAgICBpZiAodHlwZS5pc0Jvb2xlYW4pIHtcbiAgICAgIHJldHVybiBgdGhpcy5nZXRCb29sZWFuQXR0cmlidXRlKCcke2F0dC50ZXJyYWZvcm1OYW1lfScpYDtcbiAgICB9XG4gICAgaWYgKHR5cGUuaXNNYXApIHtcbiAgICAgIHJldHVybiBgdGhpcy5nZXQke3VwcGVyY2FzZUZpcnN0KGF0dC5tYXBUeXBlKX1NYXBBdHRyaWJ1dGUoJyR7XG4gICAgICAgIGF0dC50ZXJyYWZvcm1OYW1lXG4gICAgICB9JylgO1xuICAgIH1cblxuICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIGF0dHJpYnV0ZSBpc24ndCBpbXBsZW1lbnRlZCB5ZXQ6ICR7SlNPTi5zdHJpbmdpZnkoYXR0KX1gKTtcblxuICAgIHRoaXMuY29kZS5saW5lKGAvLyBHZXR0aW5nIHRoZSBjb21wdXRlZCB2YWx1ZSBpcyBub3QgeWV0IGltcGxlbWVudGVkYCk7XG4gICAgaWYgKHR5cGUuaXNTZXQpIHtcbiAgICAgIC8vIFRva2VuLmFzQW55IGlzIHJlcXVpcmVkIGJlY2F1c2UgdG9saXN0IHJldHVybnMgYW4gQXJyYXkgZW5jb2RlZCB0b2tlbiB3aGljaCB0aGUgbGlzdE1hcHBlclxuICAgICAgLy8gd291bGQgdHJ5IHRvIG1hcCBvdmVyIHdoZW4gdGhpcyBpcyBwYXNzZWQgdG8gYW5vdGhlciByZXNvdXJjZS4gV2l0aCBUb2tlbi5hc0FueSgpIGl0IGlzIGxlZnRcbiAgICAgIC8vIGFzIGlzIGJ5IHRoZSBsaXN0TWFwcGVyIGFuZCBpcyBsYXRlciBwcm9wZXJseSByZXNvbHZlZCB0byBhIHJlZmVyZW5jZVxuICAgICAgLy8gKHRoaXMgb25seSB3b3JrcyBpbiBUeXBlU2NyaXB0IGN1cnJlbnRseSwgc2FtZSBhcyBmb3IgcmVmZXJlbmNpbmcgbGlzdHNcbiAgICAgIC8vIFtzZWUgXCJpbnRlcnBvbGF0aW9uRm9yQXR0cmlidXRlKC4uLilcIiBmdXJ0aGVyIGJlbG93XSlcbiAgICAgIHJldHVybiBgY2RrdGYuVG9rZW4uYXNBbnkoY2RrdGYuRm4udG9saXN0KHRoaXMuaW50ZXJwb2xhdGlvbkZvckF0dHJpYnV0ZSgnJHthdHQudGVycmFmb3JtTmFtZX0nKSkpYDtcbiAgICB9XG4gICAgcmV0dXJuIGB0aGlzLmludGVycG9sYXRpb25Gb3JBdHRyaWJ1dGUoJyR7YXR0LnRlcnJhZm9ybU5hbWV9JylgO1xuICB9XG5cbiAgcHVibGljIG5lZWRzSW5wdXRFc2NhcGUoXG4gICAgYXR0OiBBdHRyaWJ1dGVNb2RlbCxcbiAgICBhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVNb2RlbFtdXG4gICk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICBhdHRyaWJ1dGVzLmZpbmQoKGEpID0+XG4gICAgICAgIGEudGVycmFmb3JtTmFtZS5tYXRjaChgXiR7YXR0LnRlcnJhZm9ybU5hbWV9X2lucHV0JGApXG4gICAgICApIGluc3RhbmNlb2YgQXR0cmlidXRlTW9kZWxcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldElucHV0TmFtZShhdHQ6IEF0dHJpYnV0ZU1vZGVsLCBlc2NhcGU6IGJvb2xlYW4pIHtcbiAgICBpZiAoZXNjYXBlKSB7XG4gICAgICByZXR1cm4gYCR7YXR0Lm5hbWV9VGZJbnB1dGA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgJHthdHQubmFtZX1JbnB1dGA7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG5lZWRzUmVzZXRFc2NhcGUoXG4gICAgYXR0OiBBdHRyaWJ1dGVNb2RlbCxcbiAgICBhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVNb2RlbFtdXG4gICk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICBhdHRyaWJ1dGVzLmZpbmQoKGEpID0+XG4gICAgICAgIGEudGVycmFmb3JtTmFtZS5tYXRjaChgXnJlc2V0XyR7YXR0LnRlcnJhZm9ybU5hbWV9JGApXG4gICAgICApIGluc3RhbmNlb2YgQXR0cmlidXRlTW9kZWxcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldFJlc2V0TmFtZShuYW1lOiBzdHJpbmcsIGVzY2FwZTogYm9vbGVhbikge1xuICAgIGlmICghbmFtZSkgcmV0dXJuIG5hbWU7XG4gICAgaWYgKGVzY2FwZSkge1xuICAgICAgcmV0dXJuIGByZXNldFRmJHt0aXRsZUNhc2UobmFtZSl9YDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGByZXNldCR7dGl0bGVDYXNlKG5hbWUpfWA7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGVtaXRUb1RlcnJhZm9ybShhdHQ6IEF0dHJpYnV0ZU1vZGVsLCBpc1N0cnVjdDogYm9vbGVhbikge1xuICAgIGNvbnN0IHR5cGUgPSBhdHQudHlwZTtcbiAgICBjb25zdCBjb250ZXh0ID0gaXNTdHJ1Y3QgPyBcInN0cnVjdCFcIiA6IFwidGhpc1wiO1xuICAgIGNvbnN0IG5hbWUgPSBpc1N0cnVjdCA/IGF0dC5uYW1lIDogYXR0LnN0b3JhZ2VOYW1lO1xuICAgIGNvbnN0IGN1c3RvbURlZmF1bHQgPSBDVVNUT01fREVGQVVMVFNbYXR0LnRlcnJhZm9ybUZ1bGxOYW1lXTtcblxuICAgIGNvbnN0IHZhclJlZmVyZW5jZSA9IGAke2NvbnRleHR9LiR7bmFtZX0ke1xuICAgICAgIWlzU3RydWN0ICYmXG4gICAgICB0eXBlLmlzQ29tcGxleCAmJlxuICAgICAgIWF0dC5pc1Byb3ZpZGVyICYmXG4gICAgICAodHlwZS5zdHJ1Y3Q/LmlzQ2xhc3MgfHwgYXR0LmdldHRlclR5cGUuX3R5cGUgPT09IFwic3RvcmVkX2NsYXNzXCIpXG4gICAgICAgID8gXCIuaW50ZXJuYWxWYWx1ZVwiXG4gICAgICAgIDogXCJcIlxuICAgIH1gO1xuICAgIGNvbnN0IGRlZmF1bHRDaGVjayA9XG4gICAgICBjdXN0b21EZWZhdWx0ICE9PSB1bmRlZmluZWRcbiAgICAgICAgPyBgJHt2YXJSZWZlcmVuY2V9ID09PSB1bmRlZmluZWQgPyAke2N1c3RvbURlZmF1bHR9IDogYFxuICAgICAgICA6IFwiXCI7XG5cbiAgICBjb25zdCBpc0Jsb2NrVHlwZSA9IGF0dC50eXBlLmlzQmxvY2s7XG5cbiAgICBzd2l0Y2ggKHRydWUpIHtcbiAgICAgIGNhc2UgdHlwZS5pc1NldCAmJiB0eXBlLmlzTWFwOlxuICAgICAgICB0aGlzLmNvZGUubGluZShcbiAgICAgICAgICBgJHthdHQudGVycmFmb3JtTmFtZX06ICR7ZGVmYXVsdENoZWNrfWNka3RmLmxpc3RNYXBwZXIoY2RrdGYuaGFzaE1hcHBlcihjZGt0Zi4ke2F0dC5tYXBUeXBlfVRvVGVycmFmb3JtKSwgJHtpc0Jsb2NrVHlwZX0pKCR7dmFyUmVmZXJlbmNlfSksYFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdHlwZS5pc0xpc3QgJiYgdHlwZS5pc01hcDpcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICAgICAgYCR7YXR0LnRlcnJhZm9ybU5hbWV9OiAke2RlZmF1bHRDaGVja31jZGt0Zi5saXN0TWFwcGVyKGNka3RmLmhhc2hNYXBwZXIoY2RrdGYuJHthdHQubWFwVHlwZX1Ub1RlcnJhZm9ybSksICR7aXNCbG9ja1R5cGV9KSgke3ZhclJlZmVyZW5jZX0pLGBcbiAgICAgICAgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHR5cGUuaXNTdHJpbmdTZXQgfHwgdHlwZS5pc051bWJlclNldCB8fCB0eXBlLmlzQm9vbGVhblNldDpcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICAgICAgYCR7XG4gICAgICAgICAgICBhdHQudGVycmFmb3JtTmFtZVxuICAgICAgICAgIH06ICR7ZGVmYXVsdENoZWNrfWNka3RmLmxpc3RNYXBwZXIoY2RrdGYuJHtkb3duY2FzZUZpcnN0KFxuICAgICAgICAgICAgdHlwZS5pbm5lclR5cGVcbiAgICAgICAgICApfVRvVGVycmFmb3JtLCAke2lzQmxvY2tUeXBlfSkoJHt2YXJSZWZlcmVuY2V9KSxgXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSB0eXBlLmlzU3RyaW5nTGlzdCB8fCB0eXBlLmlzTnVtYmVyTGlzdCB8fCB0eXBlLmlzQm9vbGVhbkxpc3Q6XG4gICAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICAgIGAke1xuICAgICAgICAgICAgYXR0LnRlcnJhZm9ybU5hbWVcbiAgICAgICAgICB9OiAke2RlZmF1bHRDaGVja31jZGt0Zi5saXN0TWFwcGVyKGNka3RmLiR7ZG93bmNhc2VGaXJzdChcbiAgICAgICAgICAgIHR5cGUuaW5uZXJUeXBlXG4gICAgICAgICAgKX1Ub1RlcnJhZm9ybSwgJHtpc0Jsb2NrVHlwZX0pKCR7dmFyUmVmZXJlbmNlfSksYFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdHlwZS5pc1NldCAmJiAhdHlwZS5pc1NpbmdsZUl0ZW06XG4gICAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICAgIGAke1xuICAgICAgICAgICAgYXR0LnRlcnJhZm9ybU5hbWVcbiAgICAgICAgICB9OiAke2RlZmF1bHRDaGVja31jZGt0Zi5saXN0TWFwcGVyKCR7ZG93bmNhc2VGaXJzdChcbiAgICAgICAgICAgIHR5cGUuaW5uZXJUeXBlXG4gICAgICAgICAgKX1Ub1RlcnJhZm9ybSwgJHtpc0Jsb2NrVHlwZX0pKCR7dmFyUmVmZXJlbmNlfSksYFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdHlwZS5pc0xpc3QgJiYgIXR5cGUuaXNTaW5nbGVJdGVtOlxuICAgICAgICB0aGlzLmNvZGUubGluZShcbiAgICAgICAgICBgJHtcbiAgICAgICAgICAgIGF0dC50ZXJyYWZvcm1OYW1lXG4gICAgICAgICAgfTogJHtkZWZhdWx0Q2hlY2t9Y2RrdGYubGlzdE1hcHBlcigke2Rvd25jYXNlRmlyc3QoXG4gICAgICAgICAgICB0eXBlLmlubmVyVHlwZVxuICAgICAgICAgICl9VG9UZXJyYWZvcm0sICR7aXNCbG9ja1R5cGV9KSgke3ZhclJlZmVyZW5jZX0pLGBcbiAgICAgICAgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHR5cGUuaXNNYXA6XG4gICAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICAgIGAke2F0dC50ZXJyYWZvcm1OYW1lfTogJHtkZWZhdWx0Q2hlY2t9Y2RrdGYuaGFzaE1hcHBlcihjZGt0Zi4ke2F0dC5tYXBUeXBlfVRvVGVycmFmb3JtKSgke3ZhclJlZmVyZW5jZX0pLGBcbiAgICAgICAgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHR5cGUuaXNTdHJpbmc6XG4gICAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICAgIGAke2F0dC50ZXJyYWZvcm1OYW1lfTogJHtkZWZhdWx0Q2hlY2t9Y2RrdGYuc3RyaW5nVG9UZXJyYWZvcm0oJHt2YXJSZWZlcmVuY2V9KSxgXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSB0eXBlLmlzTnVtYmVyOlxuICAgICAgICB0aGlzLmNvZGUubGluZShcbiAgICAgICAgICBgJHthdHQudGVycmFmb3JtTmFtZX06ICR7ZGVmYXVsdENoZWNrfWNka3RmLm51bWJlclRvVGVycmFmb3JtKCR7dmFyUmVmZXJlbmNlfSksYFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdHlwZS5pc0Jvb2xlYW46XG4gICAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICAgIGAke2F0dC50ZXJyYWZvcm1OYW1lfTogJHtkZWZhdWx0Q2hlY2t9Y2RrdGYuYm9vbGVhblRvVGVycmFmb3JtKCR7dmFyUmVmZXJlbmNlfSksYFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdHlwZS5pc0NvbXBsZXggJiYgIXR5cGUuc3RydWN0Py5pc0NsYXNzICYmICF0eXBlLmlzU2luZ2xlSXRlbTpcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICAgICAgYCR7YXR0LnRlcnJhZm9ybU5hbWV9OiAke2RlZmF1bHRDaGVja30ke2Rvd25jYXNlRmlyc3QoXG4gICAgICAgICAgICB0eXBlLnN0cnVjdCEubmFtZVxuICAgICAgICAgICl9VG9UZXJyYWZvcm0oJHt2YXJSZWZlcmVuY2V9KSxgXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICAgICAgYCR7YXR0LnRlcnJhZm9ybU5hbWV9OiAke2RlZmF1bHRDaGVja30ke2Rvd25jYXNlRmlyc3QoXG4gICAgICAgICAgICB0eXBlLm5hbWVcbiAgICAgICAgICApfVRvVGVycmFmb3JtKCR7dmFyUmVmZXJlbmNlfSksYFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cbn1cbiJdfQ==