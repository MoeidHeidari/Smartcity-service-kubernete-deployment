"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isListExpression = exports.findUsedReferences = exports.extractDynamicBlocks = exports.referencesToAst = exports.referenceToAst = exports.constructAst = exports.variableName = exports.referenceToVariableName = exports.extractReferencesFromExpression = void 0;
const t = __importStar(require("@babel/types"));
const reserved_words_1 = __importDefault(require("reserved-words"));
const utils_1 = require("./utils");
const provider_generator_1 = require("@cdktf/provider-generator");
const hcl2json_1 = require("@cdktf/hcl2json");
const provider_1 = require("./provider");
const DOLLAR_REGEX = /\$/g;
async function extractReferencesFromExpression(input, nodeIds, scopedIds = [] // dynamics introduce new scoped variables that are not the globally accessible ids
) {
    utils_1.logger.debug(`extractReferencesFromExpression(${input})`);
    const possibleVariableSpots = await hcl2json_1.getReferencesInExpression("main.tf", input);
    utils_1.logger.debug(`found possible variable spots: ${JSON.stringify(possibleVariableSpots)}`);
    return possibleVariableSpots.reduce((carry, spot) => {
        const { value, startPosition, endPosition } = spot;
        // no reference
        if (!value.includes(".") || // just a literal
            value.startsWith(".") || // dangling property access
            value.endsWith("...") || // spread (likely in for loop)
            value.startsWith("count.") || // count variable
            value.startsWith("each.") || // each variable
            // https://www.terraform.io/docs/language/expressions/references.html#filesystem-and-workspace-info
            value.startsWith("path.module") ||
            value.startsWith("path.root") ||
            value.startsWith("path.cwd") ||
            value.startsWith("terraform.workspace") ||
            value.startsWith("self.") // block local value
        ) {
            utils_1.logger.debug(`skipping ${value}`);
            return carry;
        }
        const referenceParts = value.split(".");
        utils_1.logger.debug(`Searching for node id '${value}' in ${JSON.stringify(nodeIds)}`);
        const corespondingNodeId = [...nodeIds, ...scopedIds].find((id) => {
            const parts = id.split(".");
            const matchesFirst = parts[0] === referenceParts[0];
            const matchesFirstTwo = matchesFirst &&
                (parts[1] === referenceParts[1] || referenceParts.length === 1);
            return (matchesFirstTwo &&
                (parts[0] === "data" ? parts[2] === referenceParts[2] : true));
        });
        if (!corespondingNodeId) {
            // This is most likely a false positive, so we just ignore it
            // We include the log below to help debugging
            utils_1.logger.error(`Found a reference that is unknown: ${input} has reference "${value}". The id was not found in ${JSON.stringify(nodeIds)} with temporary values ${JSON.stringify(scopedIds)}.
        Please leave a comment at https://cdk.tf/bugs/convert-expressions if you run into this issue.`);
            return carry;
        }
        if (scopedIds.includes(corespondingNodeId)) {
            utils_1.logger.debug(`skipping '${value}' since it's a scoped variable`);
            return carry;
        }
        utils_1.logger.debug(`Found node id '${corespondingNodeId}'`);
        const spotParts = value.split(".");
        let isThereANumericAccessor = false;
        const referenceSpotParts = spotParts.filter((part) => {
            if (!Number.isNaN(parseInt(part, 10))) {
                isThereANumericAccessor = true;
                return false;
            }
            return !isThereANumericAccessor;
        });
        const fullReference = isThereANumericAccessor
            ? referenceSpotParts.slice(0, 2).join(".")
            : value;
        const isVariable = value.startsWith("var.");
        const useFqn = 
        // Can not use FQN on vars
        !isVariable &&
            // Can not use FQN on locals
            !value.startsWith("local.") &&
            // If the following character is
            (input.substr(endPosition + 1, 1) === "*" || // a * (splat) we need to use the FQN
                input.substr(endPosition, 1) === "[" || // a property access
                isThereANumericAccessor || // a numeric access
                fullReference.split(".").length < 3);
        const ref = {
            start: startPosition,
            end: endPosition,
            referencee: {
                id: corespondingNodeId,
                full: fullReference,
            },
            useFqn,
            isVariable,
        };
        utils_1.logger.debug(`Found reference ${JSON.stringify(ref)}`);
        return [...carry, ref];
    }, []);
}
exports.extractReferencesFromExpression = extractReferencesFromExpression;
function referenceToVariableName(scope, ref) {
    const parts = ref.referencee.id.split(".");
    const resource = parts[0] === "data" ? `${parts[0]}.${parts[1]}` : parts[0];
    const name = parts[0] === "data" ? parts[2] : parts[1];
    return variableName(scope, resource, name);
}
exports.referenceToVariableName = referenceToVariableName;
function validVarName(name) {
    if (reserved_words_1.default.check(name)) {
        return `${name}Var`;
    }
    if (!Number.isNaN(parseInt(name[0], 10))) {
        return `d${name}`;
    }
    return name;
}
function variableName(scope, resource, name) {
    // name collision, we need to prefix the name
    if (scope.variables[name]) {
        if (resource === scope.variables[name].resource) {
            return scope.variables[name].variableName;
        }
        // we only cache one per name
        return validVarName(utils_1.camelCase([resource, name].join("_")));
    }
    const variableName = validVarName(utils_1.camelCase(["var", "local", "module"].includes(resource)
        ? name
        : [resource, name].join("_")));
    scope.variables[name] = { variableName, resource };
    return variableName;
}
exports.variableName = variableName;
function constructAst(scope, type, isModuleImport) {
    if (isModuleImport) {
        return t.memberExpression(t.identifier(type), t.identifier(type));
    }
    function getUniqueName(provider, type) {
        var _a;
        // early abort on cdktf
        if (provider === "cdktf") {
            return utils_1.pascalCase(type.replace("cdktf_", ""));
        }
        if (provider === "NullProvider") {
            return utils_1.pascalCase(type.replace("NullProvider_", ""));
        }
        // Special handling for provider blocks, e.g. aws_AwsProvider
        if (type === `${utils_1.pascalCase(provider)}Provider`) {
            return type;
        }
        const fullProviderName = provider_1.getFullProviderName(scope.providerSchema, provider);
        if (fullProviderName && scope.providerGenerator[fullProviderName]) {
            return (_a = scope.providerGenerator[fullProviderName]) === null || _a === void 0 ? void 0 : _a.getClassNameForResource(type);
        }
        else {
            // If we can not find the class name for a resource the caller needs to find a sensible default
            return null;
        }
    }
    // resources or data sources
    if (!type.includes("./") && type.includes(".")) {
        const parts = type.split(".");
        if (parts[0] === "data") {
            const [, provider, resource] = parts;
            const namespace = provider_generator_1.getResourceNamespace(provider, resource);
            const resourceName = getUniqueName(provider, parts.join("_")) ||
                utils_1.pascalCase(`data_${provider}_${resource}`);
            if (namespace) {
                return t.memberExpression(t.memberExpression(t.identifier(provider), // e.g. aws
                t.identifier(namespace.name) // e.g. EC2
                ), t.identifier(resourceName) // e.g. DataAwsInstance
                );
            }
            return t.memberExpression(t.identifier(provider), // e.g. aws
            t.identifier(resourceName) // e.g. DataAwsNatGateway
            );
        }
        const [provider, resource] = parts;
        const namespace = provider_generator_1.getResourceNamespace(provider, resource);
        const resourceName = getUniqueName(provider, parts.join("_")) || utils_1.pascalCase(resource);
        if (namespace) {
            return t.memberExpression(t.memberExpression(t.identifier(provider), // e.g. aws
            t.identifier(namespace.name) // e.g. EC2
            ), t.identifier(resourceName) // e.g. Instance
            );
        }
        return t.memberExpression(t.identifier(provider), // e.g. google
        t.identifier(resourceName) // e.g. BigQueryTable
        );
    }
    return t.identifier(utils_1.pascalCase(type));
}
exports.constructAst = constructAst;
function referenceToAst(scope, ref) {
    const [resource, , ...selector] = ref.referencee.full.split(".");
    const variableReference = t.identifier(utils_1.camelCase(referenceToVariableName(scope, ref)));
    if (resource === "data") {
        selector.shift(); // remove the data part so that the name is not used in the selector
    }
    const accessor = selector.reduce((carry, member, index) => t.memberExpression(carry, t.identifier(index === 0 && resource === "module"
        ? utils_1.camelCase(member + "Output")
        : utils_1.camelCase(member))), variableReference);
    if (ref.useFqn) {
        return t.memberExpression(accessor, t.identifier("fqn"));
    }
    if (ref.isVariable) {
        return t.memberExpression(accessor, t.identifier("value"));
    }
    return accessor;
}
exports.referenceToAst = referenceToAst;
function referencesToAst(scope, input, refs, scopedIds = [] // dynamics introduce new scoped variables that are not the globally accessible ids
) {
    utils_1.logger.debug(`Transforming string '${input}' with references ${JSON.stringify(refs)} to AST`);
    if (refs.length === 0) {
        return t.stringLiteral(input);
    }
    const refAsts = refs
        .sort((a, b) => a.start - b.start)
        .filter((ref) => !scopedIds.includes(ref.referencee.id))
        .map((ref) => ({ ref, ast: referenceToAst(scope, ref) }));
    if (refAsts.length === 1 &&
        refAsts[0].ref.start === "${".length &&
        refAsts[0].ref.end === input.length - "}".length &&
        !refAsts[0].ref.useFqn) {
        return refAsts[0].ast;
    }
    // string parts in the template string
    const quasis = [];
    // dynamic values in the template string
    const expressions = [];
    let lastEnd = 0;
    refAsts.forEach(({ ref, ast }) => {
        // leading quasi
        if (ref.start !== lastEnd) {
            quasis.push(t.templateElement({
                raw: input.substring(lastEnd, ref.start).replace(DOLLAR_REGEX, "\\$"),
            }));
        }
        expressions.push(ast);
        lastEnd = ref.end;
    });
    // trailing quasi
    quasis.push(t.templateElement({
        raw: input
            .substring(lastEnd, input.length)
            .replace(DOLLAR_REGEX, "\\$"),
    }, true));
    return t.templateLiteral(quasis, expressions);
}
exports.referencesToAst = referencesToAst;
exports.extractDynamicBlocks = (config, path = "") => {
    if (typeof config !== "object") {
        return [];
    }
    if (!config) {
        return [];
    }
    if (Array.isArray(config)) {
        return config.reduce((carry, item, index) => [
            ...carry,
            ...exports.extractDynamicBlocks(item, `${path}.${index}`),
        ], []);
    }
    if ("dynamic" in config) {
        const dynamic = config.dynamic;
        const scopedVar = Object.keys(dynamic)[0];
        const { for_each, content } = dynamic[scopedVar][0];
        return [
            {
                path: `${path}.${scopedVar}`,
                for_each,
                content,
                scopedVar,
            },
        ];
    }
    return Object.entries(config).reduce((carry, [key, value]) => {
        return [...carry, ...exports.extractDynamicBlocks(value, `${path}.${key}`)];
    }, []);
};
async function findUsedReferences(nodeIds, item) {
    utils_1.logger.debug(`findUsedReferences(${nodeIds}, ${item})`);
    if (typeof item === "string") {
        return await extractReferencesFromExpression(item, nodeIds, []);
    }
    if (typeof item !== "object" || item === null || item === undefined) {
        return [];
    }
    if (Array.isArray(item)) {
        return (await Promise.all(item.map((i) => findUsedReferences(nodeIds, i)))).flat();
    }
    if (item && "dynamic" in item) {
        const dyn = item["dynamic"];
        const { for_each, ...others } = dyn;
        const dynamicRef = Object.keys(others)[0];
        return await findUsedReferences([...nodeIds, dynamicRef], dyn);
    }
    return (await Promise.all(Object.values(item).map((i) => findUsedReferences(nodeIds, i)))).flat();
}
exports.findUsedReferences = findUsedReferences;
// This only guesses if the type of an expression is list, it should be replaced by something that understands
// the type of the expression, solved by https://github.com/hashicorp/terraform-cdk/issues/842
function isListExpression(item) {
    const hasListExtension = item.includes("[") &&
        item.includes("for ") &&
        item.includes(" in ") &&
        item.includes("]");
    if (!hasListExtension) {
        return false;
    }
    // We might have wrapped it in a function that collapses the list
    return !["element", "index", "length", "lookup", "one", "join"].some((collapsingTfFunction) => item.includes(`${collapsingTfFunction}(`) &&
        item.indexOf(`${collapsingTfFunction}(`) < item.indexOf("for"));
}
exports.isListExpression = isListExpression;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJleHByZXNzaW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsZ0RBQWtDO0FBQ2xDLG9FQUEyQztBQUMzQyxtQ0FBd0Q7QUFFeEQsa0VBQWlFO0FBQ2pFLDhDQUE0RDtBQUM1RCx5Q0FBaUQ7QUFVakQsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDO0FBRXBCLEtBQUssVUFBVSwrQkFBK0IsQ0FDbkQsS0FBYSxFQUNiLE9BQTBCLEVBQzFCLFlBQStCLEVBQUUsQ0FBQyxtRkFBbUY7O0lBRXJILGNBQU0sQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDMUQsTUFBTSxxQkFBcUIsR0FBRyxNQUFNLG9DQUF5QixDQUMzRCxTQUFTLEVBQ1QsS0FBSyxDQUNOLENBQUM7SUFFRixjQUFNLENBQUMsS0FBSyxDQUNWLGtDQUFrQyxJQUFJLENBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDLEVBQUUsQ0FDMUUsQ0FBQztJQUVGLE9BQU8scUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ2xELE1BQU0sRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQztRQUNuRCxlQUFlO1FBQ2YsSUFDRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksaUJBQWlCO1lBQ3pDLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksMkJBQTJCO1lBQ3BELEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksOEJBQThCO1lBQ3ZELEtBQUssQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksaUJBQWlCO1lBQy9DLEtBQUssQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksZ0JBQWdCO1lBQzdD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QixDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FDL0IsQ0FDRixDQUNGLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDWCxDQUFDO0FBakNELGdEQWlDQztBQUVELDhHQUE4RztBQUM5Ryw4RkFBOEY7QUFDOUYsU0FBZ0IsZ0JBQWdCLENBQUMsSUFBWTtJQUMzQyxNQUFNLGdCQUFnQixHQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztRQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRXJCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtRQUNyQixPQUFPLEtBQUssQ0FBQztLQUNkO0lBRUQsaUVBQWlFO0lBQ2pFLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUNsRSxDQUFDLG9CQUFvQixFQUFFLEVBQUUsQ0FDdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLG9CQUFvQixHQUFHLENBQUM7UUFDekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLG9CQUFvQixHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUNqRSxDQUFDO0FBQ0osQ0FBQztBQWpCRCw0Q0FpQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB0IGZyb20gXCJAYmFiZWwvdHlwZXNcIjtcbmltcG9ydCByZXNlcnZlZFdvcmRzIGZyb20gXCJyZXNlcnZlZC13b3Jkc1wiO1xuaW1wb3J0IHsgY2FtZWxDYXNlLCBsb2dnZXIsIHBhc2NhbENhc2UgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHsgVGVycmFmb3JtUmVzb3VyY2VCbG9jaywgU2NvcGUgfSBmcm9tIFwiLi90eXBlc1wiO1xuaW1wb3J0IHsgZ2V0UmVzb3VyY2VOYW1lc3BhY2UgfSBmcm9tIFwiQGNka3RmL3Byb3ZpZGVyLWdlbmVyYXRvclwiO1xuaW1wb3J0IHsgZ2V0UmVmZXJlbmNlc0luRXhwcmVzc2lvbiB9IGZyb20gXCJAY2RrdGYvaGNsMmpzb25cIjtcbmltcG9ydCB7IGdldEZ1bGxQcm92aWRlck5hbWUgfSBmcm9tIFwiLi9wcm92aWRlclwiO1xuXG5leHBvcnQgdHlwZSBSZWZlcmVuY2UgPSB7XG4gIHN0YXJ0OiBudW1iZXI7XG4gIGVuZDogbnVtYmVyO1xuICByZWZlcmVuY2VlOiB7IGlkOiBzdHJpbmc7IGZ1bGw6IHN0cmluZyB9OyAvLyBpZGVudGlmaWVyIGZvciByZXNvdXJjZVxuICB1c2VGcW4/OiBib29sZWFuO1xuICBpc1ZhcmlhYmxlPzogYm9vbGVhbjtcbn07XG5cbmNvbnN0IERPTExBUl9SRUdFWCA9IC9cXCQvZztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RSZWZlcmVuY2VzRnJvbUV4cHJlc3Npb24oXG4gIGlucHV0OiBzdHJpbmcsXG4gIG5vZGVJZHM6IHJlYWRvbmx5IHN0cmluZ1tdLFxuICBzY29wZWRJZHM6IHJlYWRvbmx5IHN0cmluZ1tdID0gW10gLy8gZHluYW1pY3MgaW50cm9kdWNlIG5ldyBzY29wZWQgdmFyaWFibGVzIHRoYXQgYXJlIG5vdCB0aGUgZ2xvYmFsbHkgYWNjZXNzaWJsZSBpZHNcbik6IFByb21pc2U8UmVmZXJlbmNlW10+IHtcbiAgbG9nZ2VyLmRlYnVnKGBleHRyYWN0UmVmZXJlbmNlc0Zyb21FeHByZXNzaW9uKCR7aW5wdXR9KWApO1xuICBjb25zdCBwb3NzaWJsZVZhcmlhYmxlU3BvdHMgPSBhd2FpdCBnZXRSZWZlcmVuY2VzSW5FeHByZXNzaW9uKFxuICAgIFwibWFpbi50ZlwiLFxuICAgIGlucHV0XG4gICk7XG5cbiAgbG9nZ2VyLmRlYnVnKFxuICAgIGBmb3VuZCBwb3NzaWJsZSB2YXJpYWJsZSBzcG90czogJHtKU09OLnN0cmluZ2lmeShwb3NzaWJsZVZhcmlhYmxlU3BvdHMpfWBcbiAgKTtcblxuICByZXR1cm4gcG9zc2libGVWYXJpYWJsZVNwb3RzLnJlZHVjZSgoY2FycnksIHNwb3QpID0+IHtcbiAgICBjb25zdCB7IHZhbHVlLCBzdGFydFBvc2l0aW9uLCBlbmRQb3NpdGlvbiB9ID0gc3BvdDtcbiAgICAvLyBubyByZWZlcmVuY2VcbiAgICBpZiAoXG4gICAgICAhdmFsdWUuaW5jbHVkZXMoXCIuXCIpIHx8IC8vIGp1c3QgYSBsaXRlcmFsXG4gICAgICB2YWx1ZS5zdGFydHNXaXRoKFwiLlwiKSB8fCAvLyBkYW5nbGluZyBwcm9wZXJ0eSBhY2Nlc3NcbiAgICAgIHZhbHVlLmVuZHNXaXRoKFwiLi4uXCIpIHx8IC8vIHNwcmVhZCAobGlrZWx5IGluIGZvciBsb29wKVxuICAgICAgdmFsdWUuc3RhcnRzV2l0aChcImNvdW50LlwiKSB8fCAvLyBjb3VudCB2YXJpYWJsZVxuICAgICAgdmFsdWUuc3RhcnRzV2l0aChcImVhY2guXCIpIHx8IC8vIGVhY2ggdmFyaWFibGVcbiAgICAgIC8vIGh0dHBzOi8vd3d3LnRlcnJhZm9ybS5pby9kb2NzL2xhbmd1YWdlL2V4cHJlc3Npb25zL3JlZmVyZW5jZXMuaHRtbCNmaWxlc3lzdGVtLWFuZC13b3Jrc3BhY2UtaW5mb1xuICAgICAgdmFsdWUuc3RhcnRzV2l0aChcInBhdGgubW9kdWxlXCIpIHx8XG4gICAgICB2YWx1ZS5zdGFydHNXaXRoKFwicGF0aC5yb290XCIpIHx8XG4gICAgICB2YWx1ZS5zdGFydHNXaXRoKFwicGF0aC5jd2RcIikgfHxcbiAgICAgIHZhbHVlLnN0YXJ0c1dpdGgoXCJ0ZXJyYWZvcm0ud29ya3NwYWNlXCIpIHx8XG4gICAgICB2YWx1ZS5zdGFydHNXaXRoKFwic2VsZi5cIikgLy8gYmxvY2sgbG9jYWwgdmFsdWVcbiAgICApIHtcbiAgICAgIGxvZ2dlci5kZWJ1Zyhgc2tpcHBpbmcgJHt2YWx1ZX1gKTtcbiAgICAgIHJldHVybiBjYXJyeTtcbiAgICB9XG5cbiAgICBjb25zdCByZWZlcmVuY2VQYXJ0cyA9IHZhbHVlLnNwbGl0KFwiLlwiKTtcblxuICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBTZWFyY2hpbmcgZm9yIG5vZGUgaWQgJyR7dmFsdWV9JyBpbiAke0pTT04uc3RyaW5naWZ5KG5vZGVJZHMpfWBcbiAgICApO1xuICAgIGNvbnN0IGNvcmVzcG9uZGluZ05vZGVJZCA9IFsuLi5ub2RlSWRzLCAuLi5zY29wZWRJZHNdLmZpbmQoKGlkKSA9PiB7XG4gICAgICBjb25zdCBwYXJ0cyA9IGlkLnNwbGl0KFwiLlwiKTtcbiAgICAgIGNvbnN0IG1hdGNoZXNGaXJzdCA9IHBhcnRzWzBdID09PSByZWZlcmVuY2VQYXJ0c1swXTtcbiAgICAgIGNvbnN0IG1hdGNoZXNGaXJzdFR3byA9XG4gICAgICAgIG1hdGNoZXNGaXJzdCAmJlxuICAgICAgICAocGFydHNbMV0gPT09IHJlZmVyZW5jZVBhcnRzWzFdIHx8IHJlZmVyZW5jZVBhcnRzLmxlbmd0aCA9PT0gMSk7XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIG1hdGNoZXNGaXJzdFR3byAmJlxuICAgICAgICAocGFydHNbMF0gPT09IFwiZGF0YVwiID8gcGFydHNbMl0gPT09IHJlZmVyZW5jZVBhcnRzWzJdIDogdHJ1ZSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpZiAoIWNvcmVzcG9uZGluZ05vZGVJZCkge1xuICAgICAgLy8gVGhpcyBpcyBtb3N0IGxpa2VseSBhIGZhbHNlIHBvc2l0aXZlLCBzbyB3ZSBqdXN0IGlnbm9yZSBpdFxuICAgICAgLy8gV2UgaW5jbHVkZSB0aGUgbG9nIGJlbG93IHRvIGhlbHAgZGVidWdnaW5nXG4gICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgIGBGb3VuZCBhIHJlZmVyZW5jZSB0aGF0IGlzIHVua25vd246ICR7aW5wdXR9IGhhcyByZWZlcmVuY2UgXCIke3ZhbHVlfVwiLiBUaGUgaWQgd2FzIG5vdCBmb3VuZCBpbiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgIG5vZGVJZHNcbiAgICAgICAgKX0gd2l0aCB0ZW1wb3JhcnkgdmFsdWVzICR7SlNPTi5zdHJpbmdpZnkoc2NvcGVkSWRzKX0uXG4gICAgICAgIFBsZWFzZSBsZWF2ZSBhIGNvbW1lbnQgYXQgaHR0cHM6Ly9jZGsudGYvYnVncy9jb252ZXJ0LWV4cHJlc3Npb25zIGlmIHlvdSBydW4gaW50byB0aGlzIGlzc3VlLmBcbiAgICAgICk7XG4gICAgICByZXR1cm4gY2Fycnk7XG4gICAgfVxuXG4gICAgaWYgKHNjb3BlZElkcy5pbmNsdWRlcyhjb3Jlc3BvbmRpbmdOb2RlSWQpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYHNraXBwaW5nICcke3ZhbHVlfScgc2luY2UgaXQncyBhIHNjb3BlZCB2YXJpYWJsZWApO1xuICAgICAgcmV0dXJuIGNhcnJ5O1xuICAgIH1cbiAgICBsb2dnZXIuZGVidWcoYEZvdW5kIG5vZGUgaWQgJyR7Y29yZXNwb25kaW5nTm9kZUlkfSdgKTtcblxuICAgIGNvbnN0IHNwb3RQYXJ0cyA9IHZhbHVlLnNwbGl0KFwiLlwiKTtcbiAgICBsZXQgaXNUaGVyZUFOdW1lcmljQWNjZXNzb3IgPSBmYWxzZTtcbiAgICBjb25zdCByZWZlcmVuY2VTcG90UGFydHMgPSBzcG90UGFydHMuZmlsdGVyKChwYXJ0KSA9PiB7XG4gICAgICBpZiAoIU51bWJlci5pc05hTihwYXJzZUludChwYXJ0LCAxMCkpKSB7XG4gICAgICAgIGlzVGhlcmVBTnVtZXJpY0FjY2Vzc29yID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gIWlzVGhlcmVBTnVtZXJpY0FjY2Vzc29yO1xuICAgIH0pO1xuICAgIGNvbnN0IGZ1bGxSZWZlcmVuY2UgPSBpc1RoZXJlQU51bWVyaWNBY2Nlc3NvclxuICAgICAgPyByZWZlcmVuY2VTcG90UGFydHMuc2xpY2UoMCwgMikuam9pbihcIi5cIilcbiAgICAgIDogdmFsdWU7XG5cbiAgICBjb25zdCBpc1ZhcmlhYmxlID0gdmFsdWUuc3RhcnRzV2l0aChcInZhci5cIik7XG4gICAgY29uc3QgdXNlRnFuID1cbiAgICAgIC8vIENhbiBub3QgdXNlIEZRTiBvbiB2YXJzXG4gICAgICAhaXNWYXJpYWJsZSAmJlxuICAgICAgLy8gQ2FuIG5vdCB1c2UgRlFOIG9uIGxvY2Fsc1xuICAgICAgIXZhbHVlLnN0YXJ0c1dpdGgoXCJsb2NhbC5cIikgJiZcbiAgICAgIC8vIElmIHRoZSBmb2xsb3dpbmcgY2hhcmFjdGVyIGlzXG4gICAgICAoaW5wdXQuc3Vic3RyKGVuZFBvc2l0aW9uICsgMSwgMSkgPT09IFwiKlwiIHx8IC8vIGEgKiAoc3BsYXQpIHdlIG5lZWQgdG8gdXNlIHRoZSBGUU5cbiAgICAgICAgaW5wdXQuc3Vic3RyKGVuZFBvc2l0aW9uLCAxKSA9PT0gXCJbXCIgfHwgLy8gYSBwcm9wZXJ0eSBhY2Nlc3NcbiAgICAgICAgaXNUaGVyZUFOdW1lcmljQWNjZXNzb3IgfHwgLy8gYSBudW1lcmljIGFjY2Vzc1xuICAgICAgICBmdWxsUmVmZXJlbmNlLnNwbGl0KFwiLlwiKS5sZW5ndGggPCAzKTtcblxuICAgIGNvbnN0IHJlZjogUmVmZXJlbmNlID0ge1xuICAgICAgc3RhcnQ6IHN0YXJ0UG9zaXRpb24sXG4gICAgICBlbmQ6IGVuZFBvc2l0aW9uLFxuICAgICAgcmVmZXJlbmNlZToge1xuICAgICAgICBpZDogY29yZXNwb25kaW5nTm9kZUlkLFxuICAgICAgICBmdWxsOiBmdWxsUmVmZXJlbmNlLFxuICAgICAgfSxcbiAgICAgIHVzZUZxbixcbiAgICAgIGlzVmFyaWFibGUsXG4gICAgfTtcbiAgICBsb2dnZXIuZGVidWcoYEZvdW5kIHJlZmVyZW5jZSAke0pTT04uc3RyaW5naWZ5KHJlZil9YCk7XG4gICAgcmV0dXJuIFsuLi5jYXJyeSwgcmVmXTtcbiAgfSwgW10gYXMgUmVmZXJlbmNlW10pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVmZXJlbmNlVG9WYXJpYWJsZU5hbWUoc2NvcGU6IFNjb3BlLCByZWY6IFJlZmVyZW5jZSk6IHN0cmluZyB7XG4gIGNvbnN0IHBhcnRzID0gcmVmLnJlZmVyZW5jZWUuaWQuc3BsaXQoXCIuXCIpO1xuICBjb25zdCByZXNvdXJjZSA9IHBhcnRzWzBdID09PSBcImRhdGFcIiA/IGAke3BhcnRzWzBdfS4ke3BhcnRzWzFdfWAgOiBwYXJ0c1swXTtcbiAgY29uc3QgbmFtZSA9IHBhcnRzWzBdID09PSBcImRhdGFcIiA/IHBhcnRzWzJdIDogcGFydHNbMV07XG4gIHJldHVybiB2YXJpYWJsZU5hbWUoc2NvcGUsIHJlc291cmNlLCBuYW1lKTtcbn1cblxuZnVuY3Rpb24gdmFsaWRWYXJOYW1lKG5hbWU6IHN0cmluZykge1xuICBpZiAocmVzZXJ2ZWRXb3Jkcy5jaGVjayhuYW1lKSkge1xuICAgIHJldHVybiBgJHtuYW1lfVZhcmA7XG4gIH1cblxuICBpZiAoIU51bWJlci5pc05hTihwYXJzZUludChuYW1lWzBdLCAxMCkpKSB7XG4gICAgcmV0dXJuIGBkJHtuYW1lfWA7XG4gIH1cblxuICByZXR1cm4gbmFtZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhcmlhYmxlTmFtZShcbiAgc2NvcGU6IFNjb3BlLFxuICByZXNvdXJjZTogc3RyaW5nLFxuICBuYW1lOiBzdHJpbmdcbik6IHN0cmluZyB7XG4gIC8vIG5hbWUgY29sbGlzaW9uLCB3ZSBuZWVkIHRvIHByZWZpeCB0aGUgbmFtZVxuICBpZiAoc2NvcGUudmFyaWFibGVzW25hbWVdKSB7XG4gICAgaWYgKHJlc291cmNlID09PSBzY29wZS52YXJpYWJsZXNbbmFtZV0ucmVzb3VyY2UpIHtcbiAgICAgIHJldHVybiBzY29wZS52YXJpYWJsZXNbbmFtZV0udmFyaWFibGVOYW1lO1xuICAgIH1cblxuICAgIC8vIHdlIG9ubHkgY2FjaGUgb25lIHBlciBuYW1lXG4gICAgcmV0dXJuIHZhbGlkVmFyTmFtZShjYW1lbENhc2UoW3Jlc291cmNlLCBuYW1lXS5qb2luKFwiX1wiKSkpO1xuICB9XG5cbiAgY29uc3QgdmFyaWFibGVOYW1lID0gdmFsaWRWYXJOYW1lKFxuICAgIGNhbWVsQ2FzZShcbiAgICAgIFtcInZhclwiLCBcImxvY2FsXCIsIFwibW9kdWxlXCJdLmluY2x1ZGVzKHJlc291cmNlKVxuICAgICAgICA/IG5hbWVcbiAgICAgICAgOiBbcmVzb3VyY2UsIG5hbWVdLmpvaW4oXCJfXCIpXG4gICAgKVxuICApO1xuXG4gIHNjb3BlLnZhcmlhYmxlc1tuYW1lXSA9IHsgdmFyaWFibGVOYW1lLCByZXNvdXJjZSB9O1xuICByZXR1cm4gdmFyaWFibGVOYW1lO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3RydWN0QXN0KFxuICBzY29wZTogU2NvcGUsXG4gIHR5cGU6IHN0cmluZyxcbiAgaXNNb2R1bGVJbXBvcnQ6IGJvb2xlYW5cbikge1xuICBpZiAoaXNNb2R1bGVJbXBvcnQpIHtcbiAgICByZXR1cm4gdC5tZW1iZXJFeHByZXNzaW9uKHQuaWRlbnRpZmllcih0eXBlKSwgdC5pZGVudGlmaWVyKHR5cGUpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldFVuaXF1ZU5hbWUocHJvdmlkZXI6IHN0cmluZywgdHlwZTogc3RyaW5nKSB7XG4gICAgLy8gZWFybHkgYWJvcnQgb24gY2RrdGZcbiAgICBpZiAocHJvdmlkZXIgPT09IFwiY2RrdGZcIikge1xuICAgICAgcmV0dXJuIHBhc2NhbENhc2UodHlwZS5yZXBsYWNlKFwiY2RrdGZfXCIsIFwiXCIpKTtcbiAgICB9XG5cbiAgICBpZiAocHJvdmlkZXIgPT09IFwiTnVsbFByb3ZpZGVyXCIpIHtcbiAgICAgIHJldHVybiBwYXNjYWxDYXNlKHR5cGUucmVwbGFjZShcIk51bGxQcm92aWRlcl9cIiwgXCJcIikpO1xuICAgIH1cblxuICAgIC8vIFNwZWNpYWwgaGFuZGxpbmcgZm9yIHByb3ZpZGVyIGJsb2NrcywgZS5nLiBhd3NfQXdzUHJvdmlkZXJcbiAgICBpZiAodHlwZSA9PT0gYCR7cGFzY2FsQ2FzZShwcm92aWRlcil9UHJvdmlkZXJgKSB7XG4gICAgICByZXR1cm4gdHlwZTtcbiAgICB9XG5cbiAgICBjb25zdCBmdWxsUHJvdmlkZXJOYW1lID0gZ2V0RnVsbFByb3ZpZGVyTmFtZShcbiAgICAgIHNjb3BlLnByb3ZpZGVyU2NoZW1hLFxuICAgICAgcHJvdmlkZXJcbiAgICApO1xuICAgIGlmIChmdWxsUHJvdmlkZXJOYW1lICYmIHNjb3BlLnByb3ZpZGVyR2VuZXJhdG9yW2Z1bGxQcm92aWRlck5hbWVdKSB7XG4gICAgICByZXR1cm4gc2NvcGUucHJvdmlkZXJHZW5lcmF0b3JbZnVsbFByb3ZpZGVyTmFtZV0/LmdldENsYXNzTmFtZUZvclJlc291cmNlKFxuICAgICAgICB0eXBlXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBJZiB3ZSBjYW4gbm90IGZpbmQgdGhlIGNsYXNzIG5hbWUgZm9yIGEgcmVzb3VyY2UgdGhlIGNhbGxlciBuZWVkcyB0byBmaW5kIGEgc2Vuc2libGUgZGVmYXVsdFxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLy8gcmVzb3VyY2VzIG9yIGRhdGEgc291cmNlc1xuICBpZiAoIXR5cGUuaW5jbHVkZXMoXCIuL1wiKSAmJiB0eXBlLmluY2x1ZGVzKFwiLlwiKSkge1xuICAgIGNvbnN0IHBhcnRzID0gdHlwZS5zcGxpdChcIi5cIik7XG4gICAgaWYgKHBhcnRzWzBdID09PSBcImRhdGFcIikge1xuICAgICAgY29uc3QgWywgcHJvdmlkZXIsIHJlc291cmNlXSA9IHBhcnRzO1xuXG4gICAgICBjb25zdCBuYW1lc3BhY2UgPSBnZXRSZXNvdXJjZU5hbWVzcGFjZShwcm92aWRlciwgcmVzb3VyY2UpO1xuICAgICAgY29uc3QgcmVzb3VyY2VOYW1lID1cbiAgICAgICAgZ2V0VW5pcXVlTmFtZShwcm92aWRlciwgcGFydHMuam9pbihcIl9cIikpIHx8XG4gICAgICAgIHBhc2NhbENhc2UoYGRhdGFfJHtwcm92aWRlcn1fJHtyZXNvdXJjZX1gKTtcblxuICAgICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgICByZXR1cm4gdC5tZW1iZXJFeHByZXNzaW9uKFxuICAgICAgICAgIHQubWVtYmVyRXhwcmVzc2lvbihcbiAgICAgICAgICAgIHQuaWRlbnRpZmllcihwcm92aWRlciksIC8vIGUuZy4gYXdzXG4gICAgICAgICAgICB0LmlkZW50aWZpZXIobmFtZXNwYWNlLm5hbWUpIC8vIGUuZy4gRUMyXG4gICAgICAgICAgKSxcbiAgICAgICAgICB0LmlkZW50aWZpZXIocmVzb3VyY2VOYW1lKSAvLyBlLmcuIERhdGFBd3NJbnN0YW5jZVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdC5tZW1iZXJFeHByZXNzaW9uKFxuICAgICAgICB0LmlkZW50aWZpZXIocHJvdmlkZXIpLCAvLyBlLmcuIGF3c1xuICAgICAgICB0LmlkZW50aWZpZXIocmVzb3VyY2VOYW1lKSAvLyBlLmcuIERhdGFBd3NOYXRHYXRld2F5XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IFtwcm92aWRlciwgcmVzb3VyY2VdID0gcGFydHM7XG4gICAgY29uc3QgbmFtZXNwYWNlID0gZ2V0UmVzb3VyY2VOYW1lc3BhY2UocHJvdmlkZXIsIHJlc291cmNlKTtcbiAgICBjb25zdCByZXNvdXJjZU5hbWUgPVxuICAgICAgZ2V0VW5pcXVlTmFtZShwcm92aWRlciwgcGFydHMuam9pbihcIl9cIikpIHx8IHBhc2NhbENhc2UocmVzb3VyY2UpO1xuXG4gICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgcmV0dXJuIHQubWVtYmVyRXhwcmVzc2lvbihcbiAgICAgICAgdC5tZW1iZXJFeHByZXNzaW9uKFxuICAgICAgICAgIHQuaWRlbnRpZmllcihwcm92aWRlciksIC8vIGUuZy4gYXdzXG4gICAgICAgICAgdC5pZGVudGlmaWVyKG5hbWVzcGFjZS5uYW1lKSAvLyBlLmcuIEVDMlxuICAgICAgICApLFxuICAgICAgICB0LmlkZW50aWZpZXIocmVzb3VyY2VOYW1lKSAvLyBlLmcuIEluc3RhbmNlXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdC5tZW1iZXJFeHByZXNzaW9uKFxuICAgICAgdC5pZGVudGlmaWVyKHByb3ZpZGVyKSwgLy8gZS5nLiBnb29nbGVcbiAgICAgIHQuaWRlbnRpZmllcihyZXNvdXJjZU5hbWUpIC8vIGUuZy4gQmlnUXVlcnlUYWJsZVxuICAgICk7XG4gIH1cblxuICByZXR1cm4gdC5pZGVudGlmaWVyKHBhc2NhbENhc2UodHlwZSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVmZXJlbmNlVG9Bc3Qoc2NvcGU6IFNjb3BlLCByZWY6IFJlZmVyZW5jZSkge1xuICBjb25zdCBbcmVzb3VyY2UsICwgLi4uc2VsZWN0b3JdID0gcmVmLnJlZmVyZW5jZWUuZnVsbC5zcGxpdChcIi5cIik7XG5cbiAgY29uc3QgdmFyaWFibGVSZWZlcmVuY2UgPSB0LmlkZW50aWZpZXIoXG4gICAgY2FtZWxDYXNlKHJlZmVyZW5jZVRvVmFyaWFibGVOYW1lKHNjb3BlLCByZWYpKVxuICApO1xuXG4gIGlmIChyZXNvdXJjZSA9PT0gXCJkYXRhXCIpIHtcbiAgICBzZWxlY3Rvci5zaGlmdCgpOyAvLyByZW1vdmUgdGhlIGRhdGEgcGFydCBzbyB0aGF0IHRoZSBuYW1lIGlzIG5vdCB1c2VkIGluIHRoZSBzZWxlY3RvclxuICB9XG5cbiAgY29uc3QgYWNjZXNzb3IgPSBzZWxlY3Rvci5yZWR1Y2UoXG4gICAgKGNhcnJ5LCBtZW1iZXIsIGluZGV4KSA9PlxuICAgICAgdC5tZW1iZXJFeHByZXNzaW9uKFxuICAgICAgICBjYXJyeSxcbiAgICAgICAgdC5pZGVudGlmaWVyKFxuICAgICAgICAgIGluZGV4ID09PSAwICYmIHJlc291cmNlID09PSBcIm1vZHVsZVwiXG4gICAgICAgICAgICA/IGNhbWVsQ2FzZShtZW1iZXIgKyBcIk91dHB1dFwiKVxuICAgICAgICAgICAgOiBjYW1lbENhc2UobWVtYmVyKVxuICAgICAgICApXG4gICAgICApLFxuICAgIHZhcmlhYmxlUmVmZXJlbmNlIGFzIHQuRXhwcmVzc2lvblxuICApO1xuXG4gIGlmIChyZWYudXNlRnFuKSB7XG4gICAgcmV0dXJuIHQubWVtYmVyRXhwcmVzc2lvbihhY2Nlc3NvciwgdC5pZGVudGlmaWVyKFwiZnFuXCIpKTtcbiAgfVxuXG4gIGlmIChyZWYuaXNWYXJpYWJsZSkge1xuICAgIHJldHVybiB0Lm1lbWJlckV4cHJlc3Npb24oYWNjZXNzb3IsIHQuaWRlbnRpZmllcihcInZhbHVlXCIpKTtcbiAgfVxuICByZXR1cm4gYWNjZXNzb3I7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWZlcmVuY2VzVG9Bc3QoXG4gIHNjb3BlOiBTY29wZSxcbiAgaW5wdXQ6IHN0cmluZyxcbiAgcmVmczogUmVmZXJlbmNlW10sXG4gIHNjb3BlZElkczogcmVhZG9ubHkgc3RyaW5nW10gPSBbXSAvLyBkeW5hbWljcyBpbnRyb2R1Y2UgbmV3IHNjb3BlZCB2YXJpYWJsZXMgdGhhdCBhcmUgbm90IHRoZSBnbG9iYWxseSBhY2Nlc3NpYmxlIGlkc1xuKTogdC5FeHByZXNzaW9uIHtcbiAgbG9nZ2VyLmRlYnVnKFxuICAgIGBUcmFuc2Zvcm1pbmcgc3RyaW5nICcke2lucHV0fScgd2l0aCByZWZlcmVuY2VzICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICByZWZzXG4gICAgKX0gdG8gQVNUYFxuICApO1xuXG4gIGlmIChyZWZzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB0LnN0cmluZ0xpdGVyYWwoaW5wdXQpO1xuICB9XG5cbiAgY29uc3QgcmVmQXN0cyA9IHJlZnNcbiAgICAuc29ydCgoYSwgYikgPT4gYS5zdGFydCAtIGIuc3RhcnQpXG4gICAgLmZpbHRlcigocmVmKSA9PiAhc2NvcGVkSWRzLmluY2x1ZGVzKHJlZi5yZWZlcmVuY2VlLmlkKSlcbiAgICAubWFwKChyZWYpID0+ICh7IHJlZiwgYXN0OiByZWZlcmVuY2VUb0FzdChzY29wZSwgcmVmKSB9KSk7XG5cbiAgaWYgKFxuICAgIHJlZkFzdHMubGVuZ3RoID09PSAxICYmXG4gICAgcmVmQXN0c1swXS5yZWYuc3RhcnQgPT09IFwiJHtcIi5sZW5ndGggJiZcbiAgICByZWZBc3RzWzBdLnJlZi5lbmQgPT09IGlucHV0Lmxlbmd0aCAtIFwifVwiLmxlbmd0aCAmJlxuICAgICFyZWZBc3RzWzBdLnJlZi51c2VGcW5cbiAgKSB7XG4gICAgcmV0dXJuIHJlZkFzdHNbMF0uYXN0O1xuICB9XG5cbiAgLy8gc3RyaW5nIHBhcnRzIGluIHRoZSB0ZW1wbGF0ZSBzdHJpbmdcbiAgY29uc3QgcXVhc2lzOiB0LlRlbXBsYXRlRWxlbWVudFtdID0gW107XG4gIC8vIGR5bmFtaWMgdmFsdWVzIGluIHRoZSB0ZW1wbGF0ZSBzdHJpbmdcbiAgY29uc3QgZXhwcmVzc2lvbnM6IHQuRXhwcmVzc2lvbltdID0gW107XG5cbiAgbGV0IGxhc3RFbmQgPSAwO1xuXG4gIHJlZkFzdHMuZm9yRWFjaCgoeyByZWYsIGFzdCB9KSA9PiB7XG4gICAgLy8gbGVhZGluZyBxdWFzaVxuICAgIGlmIChyZWYuc3RhcnQgIT09IGxhc3RFbmQpIHtcbiAgICAgIHF1YXNpcy5wdXNoKFxuICAgICAgICB0LnRlbXBsYXRlRWxlbWVudCh7XG4gICAgICAgICAgcmF3OiBpbnB1dC5zdWJzdHJpbmcobGFzdEVuZCwgcmVmLnN0YXJ0KS5yZXBsYWNlKERPTExBUl9SRUdFWCwgXCJcXFxcJFwiKSxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgZXhwcmVzc2lvbnMucHVzaChhc3QpO1xuXG4gICAgbGFzdEVuZCA9IHJlZi5lbmQ7XG4gIH0pO1xuXG4gIC8vIHRyYWlsaW5nIHF1YXNpXG4gIHF1YXNpcy5wdXNoKFxuICAgIHQudGVtcGxhdGVFbGVtZW50KFxuICAgICAge1xuICAgICAgICByYXc6IGlucHV0XG4gICAgICAgICAgLnN1YnN0cmluZyhsYXN0RW5kLCBpbnB1dC5sZW5ndGgpXG4gICAgICAgICAgLnJlcGxhY2UoRE9MTEFSX1JFR0VYLCBcIlxcXFwkXCIpLFxuICAgICAgfSxcbiAgICAgIHRydWVcbiAgICApXG4gICk7XG5cbiAgcmV0dXJuIHQudGVtcGxhdGVMaXRlcmFsKHF1YXNpcywgZXhwcmVzc2lvbnMpO1xufVxuXG5leHBvcnQgdHlwZSBEeW5hbWljQmxvY2sgPSB7XG4gIHBhdGg6IHN0cmluZztcbiAgZm9yX2VhY2g6IHN0cmluZztcbiAgY29udGVudDogVGVycmFmb3JtUmVzb3VyY2VCbG9jaztcbiAgc2NvcGVkVmFyOiBzdHJpbmc7XG59O1xuZXhwb3J0IGNvbnN0IGV4dHJhY3REeW5hbWljQmxvY2tzID0gKFxuICBjb25maWc6IFRlcnJhZm9ybVJlc291cmNlQmxvY2ssXG4gIHBhdGggPSBcIlwiXG4pOiBEeW5hbWljQmxvY2tbXSA9PiB7XG4gIGlmICh0eXBlb2YgY29uZmlnICE9PSBcIm9iamVjdFwiKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgaWYgKCFjb25maWcpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBpZiAoQXJyYXkuaXNBcnJheShjb25maWcpKSB7XG4gICAgcmV0dXJuIGNvbmZpZy5yZWR1Y2UoXG4gICAgICAoY2FycnksIGl0ZW0sIGluZGV4KSA9PiBbXG4gICAgICAgIC4uLmNhcnJ5LFxuICAgICAgICAuLi5leHRyYWN0RHluYW1pY0Jsb2NrcyhpdGVtLCBgJHtwYXRofS4ke2luZGV4fWApLFxuICAgICAgXSxcbiAgICAgIFtdXG4gICAgKTtcbiAgfVxuXG4gIGlmIChcImR5bmFtaWNcIiBpbiBjb25maWcpIHtcbiAgICBjb25zdCBkeW5hbWljID0gKGNvbmZpZyBhcyBhbnkpLmR5bmFtaWM7XG4gICAgY29uc3Qgc2NvcGVkVmFyID0gT2JqZWN0LmtleXMoZHluYW1pYylbMF07XG4gICAgY29uc3QgeyBmb3JfZWFjaCwgY29udGVudCB9ID0gZHluYW1pY1tzY29wZWRWYXJdWzBdO1xuXG4gICAgcmV0dXJuIFtcbiAgICAgIHtcbiAgICAgICAgcGF0aDogYCR7cGF0aH0uJHtzY29wZWRWYXJ9YCxcbiAgICAgICAgZm9yX2VhY2gsXG4gICAgICAgIGNvbnRlbnQsXG4gICAgICAgIHNjb3BlZFZhcixcbiAgICAgIH0sXG4gICAgXTtcbiAgfVxuXG4gIHJldHVybiBPYmplY3QuZW50cmllcyhjb25maWcpLnJlZHVjZSgoY2FycnksIFtrZXksIHZhbHVlXSkgPT4ge1xuICAgIHJldHVybiBbLi4uY2FycnksIC4uLmV4dHJhY3REeW5hbWljQmxvY2tzKHZhbHVlIGFzIGFueSwgYCR7cGF0aH0uJHtrZXl9YCldO1xuICB9LCBbXSBhcyBEeW5hbWljQmxvY2tbXSk7XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmluZFVzZWRSZWZlcmVuY2VzKFxuICBub2RlSWRzOiBzdHJpbmdbXSxcbiAgaXRlbTogVGVycmFmb3JtUmVzb3VyY2VCbG9ja1xuKTogUHJvbWlzZTxSZWZlcmVuY2VbXT4ge1xuICBsb2dnZXIuZGVidWcoYGZpbmRVc2VkUmVmZXJlbmNlcygke25vZGVJZHN9LCAke2l0ZW19KWApO1xuICBpZiAodHlwZW9mIGl0ZW0gPT09IFwic3RyaW5nXCIpIHtcbiAgICByZXR1cm4gYXdhaXQgZXh0cmFjdFJlZmVyZW5jZXNGcm9tRXhwcmVzc2lvbihpdGVtLCBub2RlSWRzLCBbXSk7XG4gIH1cblxuICBpZiAodHlwZW9mIGl0ZW0gIT09IFwib2JqZWN0XCIgfHwgaXRlbSA9PT0gbnVsbCB8fCBpdGVtID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBpZiAoQXJyYXkuaXNBcnJheShpdGVtKSkge1xuICAgIHJldHVybiAoXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChpdGVtLm1hcCgoaSkgPT4gZmluZFVzZWRSZWZlcmVuY2VzKG5vZGVJZHMsIGkpKSlcbiAgICApLmZsYXQoKTtcbiAgfVxuXG4gIGlmIChpdGVtICYmIFwiZHluYW1pY1wiIGluIGl0ZW0pIHtcbiAgICBjb25zdCBkeW4gPSAoaXRlbSBhcyBhbnkpW1wiZHluYW1pY1wiXTtcbiAgICBjb25zdCB7IGZvcl9lYWNoLCAuLi5vdGhlcnMgfSA9IGR5bjtcbiAgICBjb25zdCBkeW5hbWljUmVmID0gT2JqZWN0LmtleXMob3RoZXJzKVswXTtcbiAgICByZXR1cm4gYXdhaXQgZmluZFVzZWRSZWZlcmVuY2VzKFsuLi5ub2RlSWRzLCBkeW5hbWljUmVmXSwgZHluKTtcbiAgfVxuXG4gIHJldHVybiAoXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBPYmplY3QudmFsdWVzKGl0ZW0gYXMgUmVjb3JkPHN0cmluZywgYW55PikubWFwKChpKSA9PlxuICAgICAgICBmaW5kVXNlZFJlZmVyZW5jZXMobm9kZUlkcywgaSlcbiAgICAgIClcbiAgICApXG4gICkuZmxhdCgpO1xufVxuXG4vLyBUaGlzIG9ubHkgZ3Vlc3NlcyBpZiB0aGUgdHlwZSBvZiBhbiBleHByZXNzaW9uIGlzIGxpc3QsIGl0IHNob3VsZCBiZSByZXBsYWNlZCBieSBzb21ldGhpbmcgdGhhdCB1bmRlcnN0YW5kc1xuLy8gdGhlIHR5cGUgb2YgdGhlIGV4cHJlc3Npb24sIHNvbHZlZCBieSBodHRwczovL2dpdGh1Yi5jb20vaGFzaGljb3JwL3RlcnJhZm9ybS1jZGsvaXNzdWVzLzg0MlxuZXhwb3J0IGZ1bmN0aW9uIGlzTGlzdEV4cHJlc3Npb24oaXRlbTogc3RyaW5nKSB7XG4gIGNvbnN0IGhhc0xpc3RFeHRlbnNpb24gPVxuICAgIGl0ZW0uaW5jbHVkZXMoXCJbXCIpICYmXG4gICAgaXRlbS5pbmNsdWRlcyhcImZvciBcIikgJiZcbiAgICBpdGVtLmluY2x1ZGVzKFwiIGluIFwiKSAmJlxuICAgIGl0ZW0uaW5jbHVkZXMoXCJdXCIpO1xuXG4gIGlmICghaGFzTGlzdEV4dGVuc2lvbikge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIFdlIG1pZ2h0IGhhdmUgd3JhcHBlZCBpdCBpbiBhIGZ1bmN0aW9uIHRoYXQgY29sbGFwc2VzIHRoZSBsaXN0XG4gIHJldHVybiAhW1wiZWxlbWVudFwiLCBcImluZGV4XCIsIFwibGVuZ3RoXCIsIFwibG9va3VwXCIsIFwib25lXCIsIFwiam9pblwiXS5zb21lKFxuICAgIChjb2xsYXBzaW5nVGZGdW5jdGlvbikgPT5cbiAgICAgIGl0ZW0uaW5jbHVkZXMoYCR7Y29sbGFwc2luZ1RmRnVuY3Rpb259KGApICYmXG4gICAgICBpdGVtLmluZGV4T2YoYCR7Y29sbGFwc2luZ1RmRnVuY3Rpb259KGApIDwgaXRlbS5pbmRleE9mKFwiZm9yXCIpXG4gICk7XG59XG4iXX0=