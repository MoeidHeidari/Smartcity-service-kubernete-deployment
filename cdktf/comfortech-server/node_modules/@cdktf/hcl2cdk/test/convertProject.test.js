"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const os = __importStar(require("os"));
const child_process_1 = require("child_process");
const lib_1 = require("../lib");
const provider_generator_1 = require("@cdktf/provider-generator");
const providerRequirements = ["kreuzwerker/docker@ ~>2.15.0"];
const createFiles = (cwd, files) => {
    files.forEach(([p, content]) => {
        fs.writeFileSync(path.resolve(cwd, p), content, "utf8");
    });
};
const createTSCdkProject = (cwd) => createFiles(cwd, [
    [
        "cdktf.json",
        `{
"language": "typescript",
"app": "npm run --silent compile && node main.js",
"terraformProviders": [],
"terraformModules": [],
"context": {}}`,
    ],
    [
        "main.ts",
        `import { Construct } from "constructs";
import { App, TerraformStack } from "cdktf";


class MyStack extends TerraformStack {
    constructor(scope: Construct, name: string) {
    super(scope, name);

    // define resources here
    }
}

const app = new App();
new MyStack(app, "converted");
app.synth();`,
    ],
    [
        "package.json",
        `{
        "name": "converted",
        "version": "1.0.0",
        "main": "main.js",
        "types": "main.ts",
        "license": "MPL-2.0",
        "private": true,
        "scripts": {
          "get": "cdktf get",
          "build": "tsc",
          "synth": "cdktf synth",
          "compile": "tsc --pretty",
          "watch": "tsc -w",
          "test": "echo ok",
          "upgrade": "npm i cdktf@latest cdktf-cli@latest",
          "upgrade:next": "npm i cdktf@next cdktf-cli@next"
        },
        "engines": {
          "node": ">=14.0"
        },
        "dependencies": {
          "cdktf": "0.11.0-pre.53",
          "constructs": "^10.0.5"
        },
        "devDependencies": {
          "@types/node": "^14.0.26",
          "typescript": "^3.9.7",
          "cdktf-cli": "0.11.0-pre.53"
        }
      }`,
    ],
    [
        "tsconfig.json",
        `{
        "compilerOptions": {
          "alwaysStrict": true,
          "charset": "utf8",
          "declaration": true,
          "experimentalDecorators": true,
          "inlineSourceMap": true,
          "inlineSources": true,
          "lib": [
            "es2018"
          ],
          "module": "CommonJS",
          "noEmitOnError": true,
          "noFallthroughCasesInSwitch": true,
          "noImplicitAny": true,
          "noImplicitReturns": true,
          "noImplicitThis": true,
          "noUnusedLocals": true,
          "noUnusedParameters": true,
          "resolveJsonModule": true,
          "strict": true,
          "strictNullChecks": true,
          "strictPropertyInitialization": true,
          "stripInternal": true,
          "target": "ES2018"
        },
        "include": [
          "**/*.ts"
        ],
        "exclude": [
          "node_modules"
        ]
      }`,
    ],
]);
const terraformProject = (files) => {
    const dir = fs.mkdtempSync(path.join(os.tmpdir(), "cdktf-convert."));
    createFiles(dir, files);
    return {
        importPath: dir,
        targetPath: fs.mkdtempSync(path.join(os.tmpdir(), "cdktf-converted.")),
    };
};
const exec = (command, cwd) => child_process_1.execSync(command, {
    cwd,
    ...(process.env.VERBOSE === "true" ? { stdio: "inherit" } : {}),
});
const getTerraformPlan = (cwd) => {
    exec(`terraform init`, cwd);
    exec(`terraform plan -out planfile`, cwd);
    exec(`terraform show -json planfile > plan.json`, cwd);
    return JSON.parse(fs.readFileSync(path.resolve(cwd, "plan.json"), "utf8"));
};
const getCdkPlan = (cwd) => {
    exec(`npm install`, cwd);
    exec(`npm run get`, cwd);
    exec(`npm run synth`, cwd);
    return getTerraformPlan(path.resolve(cwd, "cdktf.out/stacks/converted/"));
};
function resources(plan) {
    return plan.planned_values.root_module.resources.map((item) => ({
        type: item.type,
        provider_name: item.provider_name,
        values: item.values,
    }));
}
let cachedProviderSchema;
describe("convertProject", () => {
    beforeAll(async () => {
        // Get all the provider schemas
        const { providerSchema } = await provider_generator_1.readSchema(providerRequirements.map((spec) => provider_generator_1.ConstructsMakerProviderTarget.from(new provider_generator_1.config.TerraformProviderConstraint(spec), provider_generator_1.LANGUAGES[0])));
        cachedProviderSchema = providerSchema;
    });
    it("has a similar plan", async () => {
        const { importPath, targetPath } = terraformProject([
            [
                "main.tf",
                `terraform {
        required_providers {
          docker = {
            source  = "kreuzwerker/docker"
            version = "2.14.0"
          }
        }
      }
      
      provider "docker" {
        host = "unix:///var/run/docker.sock"
      }`,
            ],
            [
                "container.tf",
                `resource "docker_image" "ubuntu" {
            name = "ubuntu:latest"
          }
          
          resource "docker_container" "foo" {
            image = docker_image.ubuntu.latest
            name  = "foo"
          }`,
            ],
            [
                "cluster.tf",
                `module "k3s" {
        source  = "camptocamp/k3s/docker"
        version = "0.11.0"
        
        cluster_endpoint = ""
        cluster_name = "cdktf"
        network_name = ""
      }`,
            ],
        ]);
        const previousPlan = getTerraformPlan(importPath);
        createTSCdkProject(targetPath);
        const mainTs = fs.readFileSync(path.resolve(targetPath, "main.ts"), "utf8");
        const { code, cdktfJson } = await lib_1.convertProject(lib_1.getTerraformConfigFromDir(importPath), {
            language: "typescript",
            providerSchema: cachedProviderSchema,
        });
        fs.writeFileSync(path.resolve(targetPath, "main.ts"), code(mainTs), "utf8");
        fs.writeFileSync(path.resolve(targetPath, "cdktf.json"), JSON.stringify(cdktfJson(require(path.resolve(targetPath, "cdktf.json")))), "utf8");
        const currentPlan = getCdkPlan(targetPath);
        expect(resources(currentPlan)).toEqual(resources(previousPlan));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydFByb2plY3QudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnZlcnRQcm9qZWN0LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsdUNBQXlCO0FBQ3pCLDJDQUE2QjtBQUM3Qix1Q0FBeUI7QUFDekIsaURBQXlDO0FBQ3pDLGdDQUFtRTtBQUNuRSxrRUFLbUM7QUFFbkMsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLDhCQUE4QixDQUFDLENBQUM7QUFDOUQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxHQUFXLEVBQUUsS0FBeUIsRUFBRSxFQUFFO0lBQzdELEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsRUFBRSxFQUFFO1FBQzdCLEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzFELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBRUYsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQ3pDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7SUFDZjtRQUNFLFlBQVk7UUFDWjs7Ozs7ZUFLUztLQUNWO0lBQ0Q7UUFDRSxTQUFTO1FBQ1Q7Ozs7Ozs7Ozs7Ozs7O2FBY087S0FDUjtJQUNEO1FBQ0UsY0FBYztRQUNkOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztRQTZCRTtLQUNIO0lBQ0Q7UUFDRSxlQUFlO1FBQ2Y7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O1FBZ0NFO0tBQ0g7Q0FDRixDQUFDLENBQUM7QUFFTCxNQUFNLGdCQUFnQixHQUFHLENBQUMsS0FBeUIsRUFBRSxFQUFFO0lBQ3JELE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxF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dGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIG9zIGZyb20gXCJvc1wiO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuaW1wb3J0IHsgY29udmVydFByb2plY3QsIGdldFRlcnJhZm9ybUNvbmZpZ0Zyb21EaXIgfSBmcm9tIFwiLi4vbGliXCI7XG5pbXBvcnQge1xuICByZWFkU2NoZW1hLFxuICBDb25zdHJ1Y3RzTWFrZXJQcm92aWRlclRhcmdldCxcbiAgTEFOR1VBR0VTLFxuICBjb25maWcsXG59IGZyb20gXCJAY2RrdGYvcHJvdmlkZXItZ2VuZXJhdG9yXCI7XG5cbmNvbnN0IHByb3ZpZGVyUmVxdWlyZW1lbnRzID0gW1wia3JldXp3ZXJrZXIvZG9ja2VyQCB+PjIuMTUuMFwiXTtcbmNvbnN0IGNyZWF0ZUZpbGVzID0gKGN3ZDogc3RyaW5nLCBmaWxlczogW3N0cmluZywgc3RyaW5nXVtdKSA9PiB7XG4gIGZpbGVzLmZvckVhY2goKFtwLCBjb250ZW50XSkgPT4ge1xuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5yZXNvbHZlKGN3ZCwgcCksIGNvbnRlbnQsIFwidXRmOFwiKTtcbiAgfSk7XG59O1xuXG5jb25zdCBjcmVhdGVUU0Nka1Byb2plY3QgPSAoY3dkOiBzdHJpbmcpID0+XG4gIGNyZWF0ZUZpbGVzKGN3ZCwgW1xuICAgIFtcbiAgICAgIFwiY2RrdGYuanNvblwiLFxuICAgICAgYHtcblwibGFuZ3VhZ2VcIjogXCJ0eXBlc2NyaXB0XCIsXG5cImFwcFwiOiBcIm5wbSBydW4gLS1zaWxlbnQgY29tcGlsZSAmJiBub2RlIG1haW4uanNcIixcblwidGVycmFmb3JtUHJvdmlkZXJzXCI6IFtdLFxuXCJ0ZXJyYWZvcm1Nb2R1bGVzXCI6IFtdLFxuXCJjb250ZXh0XCI6IHt9fWAsXG4gICAgXSxcbiAgICBbXG4gICAgICBcIm1haW4udHNcIixcbiAgICAgIGBpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQXBwLCBUZXJyYWZvcm1TdGFjayB9IGZyb20gXCJjZGt0ZlwiO1xuXG5cbmNsYXNzIE15U3RhY2sgZXh0ZW5kcyBUZXJyYWZvcm1TdGFjayB7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgbmFtZTogc3RyaW5nKSB7XG4gICAgc3VwZXIoc2NvcGUsIG5hbWUpO1xuXG4gICAgLy8gZGVmaW5lIHJlc291cmNlcyBoZXJlXG4gICAgfVxufVxuXG5jb25zdCBhcHAgPSBuZXcgQXBwKCk7XG5uZXcgTXlTdGFjayhhcHAsIFwiY29udmVydGVkXCIpO1xuYXBwLnN5bnRoKCk7YCxcbiAgICBdLFxuICAgIFtcbiAgICAgIFwicGFja2FnZS5qc29uXCIsXG4gICAgICBge1xuICAgICAgICBcIm5hbWVcIjogXCJjb252ZXJ0ZWRcIixcbiAgICAgICAgXCJ2ZXJzaW9uXCI6IFwiMS4wLjBcIixcbiAgICAgICAgXCJtYWluXCI6IFwibWFpbi5qc1wiLFxuICAgICAgICBcInR5cGVzXCI6IFwibWFpbi50c1wiLFxuICAgICAgICBcImxpY2Vuc2VcIjogXCJNUEwtMi4wXCIsXG4gICAgICAgIFwicHJpdmF0ZVwiOiB0cnVlLFxuICAgICAgICBcInNjcmlwdHNcIjoge1xuICAgICAgICAgIFwiZ2V0XCI6IFwiY2RrdGYgZ2V0XCIsXG4gICAgICAgICAgXCJidWlsZFwiOiBcInRzY1wiLFxuICAgICAgICAgIFwic3ludGhcIjogXCJjZGt0ZiBzeW50aFwiLFxuICAgICAgICAgIFwiY29tcGlsZVwiOiBcInRzYyAtLXByZXR0eVwiLFxuICAgICAgICAgIFwid2F0Y2hcIjogXCJ0c2MgLXdcIixcbiAgICAgICAgICBcInRlc3RcIjogXCJlY2hvIG9rXCIsXG4gICAgICAgICAgXCJ1cGdyYWRlXCI6IFwibnBtIGkgY2RrdGZAbGF0ZXN0IGNka3RmLWNsaUBsYXRlc3RcIixcbiAgICAgICAgICBcInVwZ3JhZGU6bmV4dFwiOiBcIm5wbSBpIGNka3RmQG5leHQgY2RrdGYtY2xpQG5leHRcIlxuICAgICAgICB9LFxuICAgICAgICBcImVuZ2luZXNcIjoge1xuICAgICAgICAgIFwibm9kZVwiOiBcIj49MTQuMFwiXG4gICAgICAgIH0sXG4gICAgICAgIFwiZGVwZW5kZW5jaWVzXCI6IHtcbiAgICAgICAgICBcImNka3RmXCI6IFwiMC4xMS4wLXByZS41M1wiLFxuICAgICAgICAgIFwiY29uc3RydWN0c1wiOiBcIl4xMC4wLjVcIlxuICAgICAgICB9LFxuICAgICAgICBcImRldkRlcGVuZGVuY2llc1wiOiB7XG4gICAgICAgICAgXCJAdHlwZXMvbm9kZVwiOiBcIl4xNC4wLjI2XCIsXG4gICAgICAgICAgXCJ0eXBlc2NyaXB0XCI6IFwiXjMuOS43XCIsXG4gICAgICAgICAgXCJjZGt0Zi1jbGlcIjogXCIwLjExLjAtcHJlLjUzXCJcbiAgICAgICAgfVxuICAgICAgfWAsXG4gICAgXSxcbiAgICBbXG4gICAgICBcInRzY29uZmlnLmpzb25cIixcbiAgICAgIGB7XG4gICAgICAgIFwiY29tcGlsZXJPcHRpb25zXCI6IHtcbiAgICAgICAgICBcImFsd2F5c1N0cmljdFwiOiB0cnVlLFxuICAgICAgICAgIFwiY2hhcnNldFwiOiBcInV0ZjhcIixcbiAgICAgICAgICBcImRlY2xhcmF0aW9uXCI6IHRydWUsXG4gICAgICAgICAgXCJleHBlcmltZW50YWxEZWNvcmF0b3JzXCI6IHRydWUsXG4gICAgICAgICAgXCJpbmxpbmVTb3VyY2VNYXBcIjogdHJ1ZSxcbiAgICAgICAgICBcImlubGluZVNvdXJjZXNcIjogdHJ1ZSxcbiAgICAgICAgICBcImxpYlwiOiBbXG4gICAgICAgICAgICBcImVzMjAxOFwiXG4gICAgICAgICAgXSxcbiAgICAgICAgICBcIm1vZHVsZVwiOiBcIkNvbW1vbkpTXCIsXG4gICAgICAgICAgXCJub0VtaXRPbkVycm9yXCI6IHRydWUsXG4gICAgICAgICAgXCJub0ZhbGx0aHJvdWdoQ2FzZXNJblN3aXRjaFwiOiB0cnVlLFxuICAgICAgICAgIFwibm9JbXBsaWNpdEFueVwiOiB0cnVlLFxuICAgICAgICAgIFwibm9JbXBsaWNpdFJldHVybnNcIjogdHJ1ZSxcbiAgICAgICAgICBcIm5vSW1wbGljaXRUaGlzXCI6IHRydWUsXG4gICAgICAgICAgXCJub1VudXNlZExvY2Fsc1wiOiB0cnVlLFxuICAgICAgICAgIFwibm9VbnVzZWRQYXJhbWV0ZXJzXCI6IHRydWUsXG4gICAgICAgICAgXCJyZXNvbHZlSnNvbk1vZHVsZVwiOiB0cnVlLFxuICAgICAgICAgIFwic3RyaWN0XCI6IHRydWUsXG4gICAgICAgICAgXCJzdHJpY3ROdWxsQ2hlY2tzXCI6IHRydWUsXG4gICAgICAgICAgXCJzdHJpY3RQcm9wZXJ0eUluaXRpYWxpemF0aW9uXCI6IHRydWUsXG4gICAgICAgICAgXCJzdHJpcEludGVybmFsXCI6IHRydWUsXG4gICAgICAgICAgXCJ0YXJnZXRcIjogXCJFUzIwMThcIlxuICAgICAgICB9LFxuICAgICAgICBcImluY2x1ZGVcIjogW1xuICAgICAgICAgIFwiKiovKi50c1wiXG4gICAgICAgIF0sXG4gICAgICAgIFwiZXhjbHVkZVwiOiBbXG4gICAgICAgICAgXCJub2RlX21vZHVsZXNcIlxuICAgICAgICBdXG4gICAgICB9YCxcbiAgICBdLFxuICBdKTtcblxuY29uc3QgdGVycmFmb3JtUHJvamVjdCA9IChmaWxlczogW3N0cmluZywgc3RyaW5nXVtdKSA9PiB7XG4gIGNvbnN0IGRpciA9IGZzLm1rZHRlbXBTeW5jKHBhdGguam9pbihvcy50bXBkaXIoKSwgXCJjZGt0Zi1jb252ZXJ0LlwiKSk7XG4gIGNyZWF0ZUZpbGVzKGRpciwgZmlsZXMpO1xuXG4gIHJldHVybiB7XG4gICAgaW1wb3J0UGF0aDogZGlyLFxuICAgIHRhcmdldFBhdGg6IGZzLm1rZHRlbXBTeW5jKHBhdGguam9pbihvcy50bXBkaXIoKSwgXCJjZGt0Zi1jb252ZXJ0ZWQuXCIpKSxcbiAgfTtcbn07XG5cbmNvbnN0IGV4ZWMgPSAoY29tbWFuZDogc3RyaW5nLCBjd2Q6IHN0cmluZykgPT5cbiAgZXhlY1N5bmMoY29tbWFuZCwge1xuICAgIGN3ZCxcbiAgICAuLi4ocHJvY2Vzcy5lbnYuVkVSQk9TRSA9PT0gXCJ0cnVlXCIgPyB7IHN0ZGlvOiBcImluaGVyaXRcIiB9IDoge30pLFxuICB9KTtcblxuY29uc3QgZ2V0VGVycmFmb3JtUGxhbiA9IChjd2Q6IHN0cmluZykgPT4ge1xuICBleGVjKGB0ZXJyYWZvcm0gaW5pdGAsIGN3ZCk7XG4gIGV4ZWMoYHRlcnJhZm9ybSBwbGFuIC1vdXQgcGxhbmZpbGVgLCBjd2QpO1xuICBleGVjKGB0ZXJyYWZvcm0gc2hvdyAtanNvbiBwbGFuZmlsZSA+IHBsYW4uanNvbmAsIGN3ZCk7XG5cbiAgcmV0dXJuIEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShjd2QsIFwicGxhbi5qc29uXCIpLCBcInV0ZjhcIikpO1xufTtcblxuY29uc3QgZ2V0Q2RrUGxhbiA9IChjd2Q6IHN0cmluZykgPT4ge1xuICBleGVjKGBucG0gaW5zdGFsbGAsIGN3ZCk7XG4gIGV4ZWMoYG5wbSBydW4gZ2V0YCwgY3dkKTtcbiAgZXhlYyhgbnBtIHJ1biBzeW50aGAsIGN3ZCk7XG5cbiAgcmV0dXJuIGdldFRlcnJhZm9ybVBsYW4ocGF0aC5yZXNvbHZlKGN3ZCwgXCJjZGt0Zi5vdXQvc3RhY2tzL2NvbnZlcnRlZC9cIikpO1xufTtcblxuZnVuY3Rpb24gcmVzb3VyY2VzKHBsYW46IGFueSkge1xuICByZXR1cm4gcGxhbi5wbGFubmVkX3ZhbHVlcy5yb290X21vZHVsZS5yZXNvdXJjZXMubWFwKChpdGVtOiBhbnkpID0+ICh7XG4gICAgdHlwZTogaXRlbS50eXBlLFxuICAgIHByb3ZpZGVyX25hbWU6IGl0ZW0ucHJvdmlkZXJfbmFtZSxcbiAgICB2YWx1ZXM6IGl0ZW0udmFsdWVzLFxuICB9KSk7XG59XG5cbmxldCBjYWNoZWRQcm92aWRlclNjaGVtYTogYW55O1xuZGVzY3JpYmUoXCJjb252ZXJ0UHJvamVjdFwiLCAoKSA9PiB7XG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgLy8gR2V0IGFsbCB0aGUgcHJvdmlkZXIgc2NoZW1hc1xuICAgIGNvbnN0IHsgcHJvdmlkZXJTY2hlbWEgfSA9IGF3YWl0IHJlYWRTY2hlbWEoXG4gICAgICBwcm92aWRlclJlcXVpcmVtZW50cy5tYXAoKHNwZWMpID0+XG4gICAgICAgIENvbnN0cnVjdHNNYWtlclByb3ZpZGVyVGFyZ2V0LmZyb20oXG4gICAgICAgICAgbmV3IGNvbmZpZy5UZXJyYWZvcm1Qcm92aWRlckNvbnN0cmFpbnQoc3BlYyksXG4gICAgICAgICAgTEFOR1VBR0VTWzBdXG4gICAgICAgIClcbiAgICAgIClcbiAgICApO1xuICAgIGNhY2hlZFByb3ZpZGVyU2NoZW1hID0gcHJvdmlkZXJTY2hlbWE7XG4gIH0pO1xuICBpdChcImhhcyBhIHNpbWlsYXIgcGxhblwiLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgeyBpbXBvcnRQYXRoLCB0YXJnZXRQYXRoIH0gPSB0ZXJyYWZvcm1Qcm9qZWN0KFtcbiAgICAgIFtcbiAgICAgICAgXCJtYWluLnRmXCIsXG4gICAgICAgIGB0ZXJyYWZvcm0ge1xuICAgICAgICByZXF1aXJlZF9wcm92aWRlcnMge1xuICAgICAgICAgIGRvY2tlciA9IHtcbiAgICAgICAgICAgIHNvdXJjZSAgPSBcImtyZXV6d2Vya2VyL2RvY2tlclwiXG4gICAgICAgICAgICB2ZXJzaW9uID0gXCIyLjE0LjBcIlxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICBwcm92aWRlciBcImRvY2tlclwiIHtcbiAgICAgICAgaG9zdCA9IFwidW5peDovLy92YXIvcnVuL2RvY2tlci5zb2NrXCJcbiAgICAgIH1gLFxuICAgICAgXSxcbiAgICAgIFtcbiAgICAgICAgXCJjb250YWluZXIudGZcIixcbiAgICAgICAgYHJlc291cmNlIFwiZG9ja2VyX2ltYWdlXCIgXCJ1YnVudHVcIiB7XG4gICAgICAgICAgICBuYW1lID0gXCJ1YnVudHU6bGF0ZXN0XCJcbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgcmVzb3VyY2UgXCJkb2NrZXJfY29udGFpbmVyXCIgXCJmb29cIiB7XG4gICAgICAgICAgICBpbWFnZSA9IGRvY2tlcl9pbWFnZS51YnVudHUubGF0ZXN0XG4gICAgICAgICAgICBuYW1lICA9IFwiZm9vXCJcbiAgICAgICAgICB9YCxcbiAgICAgIF0sXG4gICAgICBbXG4gICAgICAgIFwiY2x1c3Rlci50ZlwiLFxuICAgICAgICBgbW9kdWxlIFwiazNzXCIge1xuICAgICAgICBzb3VyY2UgID0gXCJjYW1wdG9jYW1wL2szcy9kb2NrZXJcIlxuICAgICAgICB2ZXJzaW9uID0gXCIwLjExLjBcIlxuICAgICAgICBcbiAgICAgICAgY2x1c3Rlcl9lbmRwb2ludCA9IFwiXCJcbiAgICAgICAgY2x1c3Rlcl9uYW1lID0gXCJjZGt0ZlwiXG4gICAgICAgIG5ldHdvcmtfbmFtZSA9IFwiXCJcbiAgICAgIH1gLFxuICAgICAgXSxcbiAgICBdKTtcblxuICAgIGNvbnN0IHByZXZpb3VzUGxhbiA9IGdldFRlcnJhZm9ybVBsYW4oaW1wb3J0UGF0aCk7XG4gICAgY3JlYXRlVFNDZGtQcm9qZWN0KHRhcmdldFBhdGgpO1xuICAgIGNvbnN0IG1haW5UcyA9IGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUodGFyZ2V0UGF0aCwgXCJtYWluLnRzXCIpLCBcInV0ZjhcIik7XG5cbiAgICBjb25zdCB7IGNvZGUsIGNka3RmSnNvbiB9ID0gYXdhaXQgY29udmVydFByb2plY3QoXG4gICAgICBnZXRUZXJyYWZvcm1Db25maWdGcm9tRGlyKGltcG9ydFBhdGgpLFxuICAgICAge1xuICAgICAgICBsYW5ndWFnZTogXCJ0eXBlc2NyaXB0XCIsXG4gICAgICAgIHByb3ZpZGVyU2NoZW1hOiBjYWNoZWRQcm92aWRlclNjaGVtYSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLnJlc29sdmUodGFyZ2V0UGF0aCwgXCJtYWluLnRzXCIpLCBjb2RlKG1haW5UcyksIFwidXRmOFwiKTtcbiAgICBmcy53cml0ZUZpbGVTeW5jKFxuICAgICAgcGF0aC5yZXNvbHZlKHRhcmdldFBhdGgsIFwiY2RrdGYuanNvblwiKSxcbiAgICAgIEpTT04uc3RyaW5naWZ5KFxuICAgICAgICBjZGt0Zkpzb24ocmVxdWlyZShwYXRoLnJlc29sdmUodGFyZ2V0UGF0aCwgXCJjZGt0Zi5qc29uXCIpKSlcbiAgICAgICksXG4gICAgICBcInV0ZjhcIlxuICAgICk7XG5cbiAgICBjb25zdCBjdXJyZW50UGxhbiA9IGdldENka1BsYW4odGFyZ2V0UGF0aCk7XG5cbiAgICBleHBlY3QocmVzb3VyY2VzKGN1cnJlbnRQbGFuKSkudG9FcXVhbChyZXNvdXJjZXMocHJldmlvdXNQbGFuKSk7XG4gIH0pO1xufSk7XG4iXX0=