"use strict";
// eslint-disable-next-line @typescript-eslint/triple-slash-reference
/// <reference lib="dom" />
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getReferencesInExpression = exports.convertFiles = exports.parse = void 0;
// Inspired by
// https://github.com/ts-terraform/ts-terraform
// https://github.com/aaronpowell/webpack-golang-wasm-async-loader
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const deepmerge_1 = require("./deepmerge");
const zlib_1 = require("zlib");
// eslint-disable-next-line @typescript-eslint/ban-types
const jsRoot = {};
function sleep() {
    return new Promise((resolve) => {
        setTimeout(resolve, 0);
    });
}
function goBridge(getBytes) {
    let ready = false;
    async function init() {
        await Promise.resolve().then(() => __importStar(require(`../wasm/wasm_exec.js`)));
        const go = new global.Go();
        const bytes = await getBytes;
        const result = await WebAssembly.instantiate(bytes, go.importObject);
        global.__parse_terraform_config_wasm__ = jsRoot;
        void go.run(result.instance);
        ready = true;
    }
    init().catch((error) => {
        throw error;
    });
    const proxy = new Proxy({}, {
        get: (_, key) => {
            return async (...args) => {
                while (!ready) {
                    await sleep();
                }
                if (!(key in jsRoot)) {
                    throw new Error(`There is nothing defined with the name "${key.toString()}"`);
                }
                if (typeof jsRoot[key] !== "function") {
                    return jsRoot[key];
                }
                return new Promise((resolve, reject) => {
                    const cb = (err, ...msg) => 
                    // @ts-ignore
                    err ? reject(new Error(err)) : resolve(...msg);
                    const run = () => {
                        jsRoot[key].apply(undefined, [...args, cb]);
                    };
                    run();
                });
            };
        },
    });
    return proxy;
}
const loadWasm = async () => {
    return zlib_1.gunzipSync(await fs_extra_1.default.readFile(path_1.default.join(__dirname, "..", "main.wasm.gz")));
};
const wasm = goBridge(loadWasm());
async function parse(filename, contents) {
    const res = await wasm.parse(filename, contents);
    return JSON.parse(res);
}
exports.parse = parse;
async function convertFiles(workingDirectory) {
    let tfFileContents = "";
    const tfJSONFileContents = [];
    for (const file of fs_extra_1.default.readdirSync(workingDirectory)) {
        const filePath = path_1.default.resolve(workingDirectory, file);
        if (!fs_extra_1.default.lstatSync(filePath).isDirectory()) {
            if (file.match(/\.tf$/)) {
                tfFileContents += fs_extra_1.default.readFileSync(filePath, "utf-8");
                tfFileContents += "\n";
            }
            else if (file.match(/\.tf\.json$/)) {
                tfJSONFileContents.push(JSON.parse(fs_extra_1.default.readFileSync(filePath, "utf-8")));
            }
        }
    }
    if (tfFileContents === "" && tfJSONFileContents === []) {
        console.error(`No '.tf' or '.tf.json' files found in ${workingDirectory}`);
        return;
    }
    return deepmerge_1.deepMerge(await parse("hcl2json.tf", tfFileContents), ...tfJSONFileContents);
}
exports.convertFiles = convertFiles;
function traversalToReference(input, traversal) {
    const lines = input.split("\n");
    const lineLength = lines.map((line) => line.length);
    function position(marker) {
        const newlineChar = 1;
        return (lineLength
            .slice(0, marker.Line)
            .reduce((a, b) => a + b + newlineChar, lines.length === 1 ? 0 : -1) +
            marker.Column);
    }
    // We do not want to include property access through brackets here
    // although it is technically a traversal / reference
    function onlyTakeTraversalPartsUntilFirstBracketPropertyAccess(traversals) {
        let filtered = [];
        for (const traversal of traversals) {
            if ("Name" in traversal) {
                filtered.push(traversal);
            }
            else {
                // We reached a bracket, stop
                return filtered;
            }
        }
        return filtered;
    }
    const filteredParts = onlyTakeTraversalPartsUntilFirstBracketPropertyAccess(traversal.Traversal);
    const startPosition = position(filteredParts[0].SrcRange.Start);
    const endPosition = position(filteredParts[filteredParts.length - 1].SrcRange.End);
    return {
        value: input.slice(startPosition, endPosition),
        startPosition,
        endPosition,
    };
}
function findAllReferencesInAst(input, entry) {
    if (!entry) {
        return [];
    }
    // This traversal is accessing a function call e.g. element(var.foo, 0).id
    // Or this is a splat operation var.foo.*
    if ("Source" in entry) {
        return findAllReferencesInAst(input, entry.Source);
    }
    // a.b.c.d is a traversal
    if ("Traversal" in entry) {
        return [traversalToReference(input, entry)];
    }
    // Multiple terraform parts in an expression
    if ("Parts" in entry) {
        return entry.Parts.flatMap((part) => findAllReferencesInAst(input, part));
    }
    // ${} is an embedded expression
    if ("Wrapped" in entry) {
        return findAllReferencesInAst(input, entry.Wrapped);
    }
    // element(var.foo, 0) is a function call
    if ("Args" in entry) {
        return entry.Args.flatMap((arg) => findAllReferencesInAst(input, arg));
    }
    // var.foo + var.bar is an arithmetic expression
    if ("LHS" in entry) {
        return [
            ...findAllReferencesInAst(input, entry.LHS),
            ...findAllReferencesInAst(input, entry.RHS),
        ];
    }
    // var.foo > 3 ? var.bar : var.baz is a condition expression
    if ("Condition" in entry) {
        return [
            ...findAllReferencesInAst(input, entry.Condition),
            ...findAllReferencesInAst(input, entry.TrueResult),
            ...findAllReferencesInAst(input, entry.FalseResult),
        ];
    }
    // for name, user in var.users : user.role => name... is a for expression
    if ("CondExpr" in entry) {
        return [
            ...findAllReferencesInAst(input, entry.CollExpr),
            ...findAllReferencesInAst(input, entry.CondExpr),
        ];
    }
    // var.foo["bar"] is a bracket property access expression
    if ("Key" in entry) {
        return [
            ...findAllReferencesInAst(input, entry.Collection),
            ...findAllReferencesInAst(input, entry.Key),
        ];
    }
    // [var.foo, var.bar] is a list expression
    if ("Exprs" in entry) {
        return (entry.Exprs || []).flatMap((expr) => findAllReferencesInAst(input, expr));
    }
    return [];
}
async function getReferencesInExpression(filename, expression) {
    const res = await wasm.getReferencesInExpression(filename, JSON.stringify(expression));
    const ast = JSON.parse(res);
    if (!ast) {
        return [];
    }
    return findAllReferencesInAst(expression, ast);
}
exports.getReferencesInExpression = getReferencesInExpression;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUVBQXFFO0FBQ3JFLDJCQUEyQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUUzQixjQUFjO0FBQ2QsK0NBQStDO0FBQy9DLGtFQUFrRTtBQUVsRSx3REFBMEI7QUFDMUIsZ0RBQXdCO0FBQ3hCLDJDQUF3QztBQUN4QywrQkFBa0M7QUFPbEMsd0RBQXdEO0FBQ3hELE1BQU0sTUFBTSxHQUE2QixFQUFFLENBQUM7QUFFNUMsU0FBUyxLQUFLO0lBQ1osT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzdCLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDekIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsUUFBeUI7SUFDekMsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBRWxCLEtBQUssVUFBVSxJQUFJO1FBQ2pCLHdEQUFhLHNCQUFzQixHQUFDLENBQUM7UUFDckMsTUFBTSxFQUFFLEdBQUcsSUFBSyxNQUFjLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDcEMsTUFBTSxLQUFLLEdBQUcsTUFBTSxRQUFRLENBQUM7UUFDN0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxXQUFXLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDcEUsTUFBYyxDQUFDLCtCQUErQixHQUFHLE1BQU0sQ0FBQztRQUN6RCxLQUFLLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdCLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDZixDQUFDO0lBRUQsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7UUFDckIsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDLENBQUMs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QUUsS0FBSyxDQUFDLFFBQVEsQ0FBQztZQUNoRCxHQUFHLHNCQUFzQixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDO1NBQ2pELENBQUM7S0FDSDtJQUVELHlEQUF5RDtJQUN6RCxJQUFJLEtBQUssSUFBSSxLQUFLLEVBQUU7UUFDbEIsT0FBTztZQUNMLEdBQUcsc0JBQXNCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUM7WUFDbEQsR0FBRyxzQkFBc0IsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQztTQUM1QyxDQUFDO0tBQ0g7SUFFRCwwQ0FBMEM7SUFDMUMsSUFBSSxPQUFPLElBQUksS0FBSyxFQUFFO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQzFDLHNCQUFzQixDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FDcEMsQ0FBQztLQUNIO0lBRUQsT0FBTyxFQUFFLENBQUM7QUFDWixDQUFDO0FBRU0sS0FBSyxVQUFVLHlCQUF5QixDQUM3QyxRQUFnQixFQUNoQixVQUFrQjtJQUVsQixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FDOUMsUUFBUSxFQUNSLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQzNCLENBQUM7SUFDRixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBNEIsQ0FBQztJQUV2RCxJQUFJLENBQUMsR0FBRyxFQUFFO1FBQ1IsT0FBTyxFQUFFLENBQUM7S0FDWDtJQUVELE9BQU8sc0JBQXNCLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ2pELENBQUM7QUFmRCw4REFlQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvdHJpcGxlLXNsYXNoLXJlZmVyZW5jZVxuLy8vIDxyZWZlcmVuY2UgbGliPVwiZG9tXCIgLz5cblxuLy8gSW5zcGlyZWQgYnlcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS90cy10ZXJyYWZvcm0vdHMtdGVycmFmb3JtXG4vLyBodHRwczovL2dpdGh1Yi5jb20vYWFyb25wb3dlbGwvd2VicGFjay1nb2xhbmctd2FzbS1hc3luYy1sb2FkZXJcblxuaW1wb3J0IGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IGRlZXBNZXJnZSB9IGZyb20gXCIuL2RlZXBtZXJnZVwiO1xuaW1wb3J0IHsgZ3VuemlwU3luYyB9IGZyb20gXCJ6bGliXCI7XG5cbmludGVyZmFjZSBHb0JyaWRnZSB7XG4gIHBhcnNlOiAoZmlsZW5hbWU6IHN0cmluZywgaGNsOiBzdHJpbmcpID0+IFByb21pc2U8c3RyaW5nPjtcbiAgZ2V0UmVmZXJlbmNlc0luRXhwcmVzc2lvbjogKGZpbGVuYW1lOiBzdHJpbmcsIGhjbDogc3RyaW5nKSA9PiBQcm9taXNlPHN0cmluZz47XG59XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXR5cGVzXG5jb25zdCBqc1Jvb3Q6IFJlY29yZDxzdHJpbmcsIEZ1bmN0aW9uPiA9IHt9O1xuXG5mdW5jdGlvbiBzbGVlcCgpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgc2V0VGltZW91dChyZXNvbHZlLCAwKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdvQnJpZGdlKGdldEJ5dGVzOiBQcm9taXNlPEJ1ZmZlcj4pIHtcbiAgbGV0IHJlYWR5ID0gZmFsc2U7XG5cbiAgYXN5bmMgZnVuY3Rpb24gaW5pdCgpIHtcbiAgICBhd2FpdCBpbXBvcnQoYC4uL3dhc20vd2FzbV9leGVjLmpzYCk7XG4gICAgY29uc3QgZ28gPSBuZXcgKGdsb2JhbCBhcyBhbnkpLkdvKCk7XG4gICAgY29uc3QgYnl0ZXMgPSBhd2FpdCBnZXRCeXRlcztcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZShieXRlcywgZ28uaW1wb3J0T2JqZWN0KTtcbiAgICAoZ2xvYmFsIGFzIGFueSkuX19wYXJzZV90ZXJyYWZvcm1fY29uZmlnX3dhc21fXyA9IGpzUm9vdDtcbiAgICB2b2lkIGdvLnJ1bihyZXN1bHQuaW5zdGFuY2UpO1xuICAgIHJlYWR5ID0gdHJ1ZTtcbiAgfVxuXG4gIGluaXQoKS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfSk7XG5cbiAgY29uc3QgcHJveHkgPSBuZXcgUHJveHkoe30gYXMgR29CcmlkZ2UsIHtcbiAgICBnZXQ6IChfLCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgcmV0dXJuIGFzeW5jICguLi5hcmdzOiB1bmtub3duW10pID0+IHtcbiAgICAgICAgd2hpbGUgKCFyZWFkeSkge1xuICAgICAgICAgIGF3YWl0IHNsZWVwKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIShrZXkgaW4ganNSb290KSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBUaGVyZSBpcyBub3RoaW5nIGRlZmluZWQgd2l0aCB0aGUgbmFtZSBcIiR7a2V5LnRvU3RyaW5nKCl9XCJgXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YganNSb290W2tleV0gIT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIHJldHVybiBqc1Jvb3Rba2V5XTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgY29uc3QgY2IgPSAoZXJyOiBzdHJpbmcsIC4uLm1zZzogc3RyaW5nW10pID0+XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBlcnIgPyByZWplY3QobmV3IEVycm9yKGVycikpIDogcmVzb2x2ZSguLi5tc2cpO1xuXG4gICAgICAgICAgY29uc3QgcnVuID0gKCkgPT4ge1xuICAgICAgICAgICAganNSb290W2tleV0uYXBwbHkodW5kZWZpbmVkLCBbLi4uYXJncywgY2JdKTtcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgcnVuKCk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICB9LFxuICB9KTtcblxuICByZXR1cm4gcHJveHk7XG59XG5cbmNvbnN0IGxvYWRXYXNtID0gYXN5bmMgKCkgPT4ge1xuICByZXR1cm4gZ3VuemlwU3luYyhcbiAgICBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uXCIsIFwibWFpbi53YXNtLmd6XCIpKVxuICApO1xufTtcblxuY29uc3Qgd2FzbSA9IGdvQnJpZGdlKGxvYWRXYXNtKCkpO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGFyc2UoXG4gIGZpbGVuYW1lOiBzdHJpbmcsXG4gIGNvbnRlbnRzOiBzdHJpbmdcbik6IFByb21pc2U8UmVjb3JkPHN0cmluZywgYW55Pj4ge1xuICBjb25zdCByZXMgPSBhd2FpdCB3YXNtLnBhcnNlKGZpbGVuYW1lLCBjb250ZW50cyk7XG4gIHJldHVybiBKU09OLnBhcnNlKHJlcyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb252ZXJ0RmlsZXMoXG4gIHdvcmtpbmdEaXJlY3Rvcnk6IHN0cmluZ1xuKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdm9pZD4ge1xuICBsZXQgdGZGaWxlQ29udGVudHMgPSBcIlwiO1xuICBjb25zdCB0ZkpTT05GaWxlQ29udGVudHM6IFJlY29yZDxzdHJpbmcsIGFueT5bXSA9IFtdO1xuXG4gIGZvciAoY29uc3QgZmlsZSBvZiBmcy5yZWFkZGlyU3luYyh3b3JraW5nRGlyZWN0b3J5KSkge1xuICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHdvcmtpbmdEaXJlY3RvcnksIGZpbGUpO1xuICAgIGlmICghZnMubHN0YXRTeW5jKGZpbGVQYXRoKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICBpZiAoZmlsZS5tYXRjaCgvXFwudGYkLykpIHtcbiAgICAgICAgdGZGaWxlQ29udGVudHMgKz0gZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCBcInV0Zi04XCIpO1xuICAgICAgICB0ZkZpbGVDb250ZW50cyArPSBcIlxcblwiO1xuICAgICAgfSBlbHNlIGlmIChmaWxlLm1hdGNoKC9cXC50ZlxcLmpzb24kLykpIHtcbiAgICAgICAgdGZKU09ORmlsZUNvbnRlbnRzLnB1c2goSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsIFwidXRmLThcIikpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZiAodGZGaWxlQ29udGVudHMgPT09IFwiXCIgJiYgdGZKU09ORmlsZUNvbnRlbnRzID09PSBbXSkge1xuICAgIGNvbnNvbGUuZXJyb3IoYE5vICcudGYnIG9yICcudGYuanNvbicgZmlsZXMgZm91bmQgaW4gJHt3b3JraW5nRGlyZWN0b3J5fWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJldHVybiBkZWVwTWVyZ2UoXG4gICAgYXdhaXQgcGFyc2UoXCJoY2wyanNvbi50ZlwiLCB0ZkZpbGVDb250ZW50cyksXG4gICAgLi4udGZKU09ORmlsZUNvbnRlbnRzXG4gICk7XG59XG5cbnR5cGUgQ29kZU1hcmtlciA9IHtcbiAgQnl0ZTogbnVtYmVyO1xuICBMaW5lOiBudW1iZXI7XG4gIENvbHVtbjogbnVtYmVyO1xufTtcbnR5cGUgUmFuZ2UgPSB7XG4gIEVuZDogQ29kZU1hcmtlcjtcbiAgU3RhcnQ6IENvZGVNYXJrZXI7XG59O1xudHlwZSBUZXJyYWZvcm1UcmF2ZXJzYWxQYXJ0ID0ge1xuICBOYW1lOiBzdHJpbmc7XG4gIFNyY1JhbmdlOiBSYW5nZTtcbn07XG4vLyBSZWZlcmVuY2UgdG8gYSB2YXJpYWJsZSAvIG1vZHVsZSAvIHJlc291cmNlXG50eXBlIFRlcnJhZm9ybVRyYXZlcnNhbCA9IHsgVHJhdmVyc2FsOiBUZXJyYWZvcm1UcmF2ZXJzYWxQYXJ0W10gfTtcbnR5cGUgUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uID0gVGVycmFmb3JtVHJhdmVyc2FsICYge1xuICBTb3VyY2U6IFRlcnJhZm9ybU9iamVjdDsgLy8gaXQncyBwcm9iYWJseSBtb3JlIHJlc3RyaWN0ZWQsIGJ1dCBpbiB0aGlzIGNvbnRleHQgd2UgZG9uJ3QgY2FyZVxufTtcbnR5cGUgVGVycmFmb3JtRnVuY3Rpb25DYWxsID0ge1xuICBBcmdzOiBUZXJyYWZvcm1PYmplY3RbXTtcbiAgTmFtZTogc3RyaW5nO1xuICBFeHBhbmRGaW5hbDogYm9vbGVhbjtcbiAgTmFtZVJhbmdlOiBSYW5nZTtcbiAgT3BlblBhcmVuUmFuZ2U6IFJhbmdlO1xuICBDbG9zZVBhcmVuUmFuZ2U6IFJhbmdlO1xufTtcbnR5cGUgVGVycmFmb3JtTGl0ZXJhbCA9IHtcbiAgU3JjUmFuZ2U6IFJhbmdlO1xuICBWYWw6IHVua25vd247IC8vIE5vIHZhbHVlIGlzIHBhc3NlZCBkb3duLCB3ZSBpZ25vcmUgdGhlbVxufTtcbnR5cGUgVGVycmFmb3JtRW1iZWRkZWRFeHByZXNzaW9uID0ge1xuICBXcmFwcGVkOiBUZXJyYWZvcm1PYmplY3Q7XG59O1xudHlwZSBUZXJyYWZvcm1FeHByZXNzaW9uID0ge1xuICBQYXJ0czogVGVycmFmb3JtT2JqZWN0W107XG59O1xudHlwZSBBcml0aG1ldGljRXhwcmVzc2lvbiA9IHtcbiAgTEhTOiBUZXJyYWZvcm1PYmplY3Q7XG4gIFJIUzogVGVycmFmb3JtT2JqZWN0O1xufTtcbnR5cGUgQ29uZGl0aW9uRXhwcmVzc2lvbiA9IHtcbiAgQ29uZGl0aW9uOiBUZXJyYWZvcm1PYmplY3Q7XG4gIFRydWVSZXN1bHQ6IFRlcnJhZm9ybU9iamVjdDtcbiAgRmFsc2VSZXN1bHQ6IFRlcnJhZm9ybU9iamVjdDtcbn07XG50eXBlIEZvckV4cHJlc3Npb24gPSB7XG4gIEtleVZhcjogc3RyaW5nO1xuICBWYWxWYXI6IHN0cmluZztcbiAgQ29sbEV4cHI6IFRlcnJhZm9ybU9iamVjdDtcbiAgS2V5RXhwcjogVGVycmFmb3JtT2JqZWN0O1xuICBWYWxFeHByOiBUZXJyYWZvcm1PYmplY3Q7XG4gIENvbmRFeHByOiBUZXJyYWZvcm1PYmplY3Q7XG59O1xudHlwZSBCcmFja2V0UHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uID0ge1xuICBDb2xsZWN0aW9uOiBUZXJyYWZvcm1PYmplY3Q7XG4gIEtleTogVGVycmFmb3JtT2JqZWN0OyAvLyBpdCdzIHByb2JhYmx5IG1vcmUgcmVzdHJpY3RlZCwgYnV0IGluIHRoaXMgY29udGV4dCB3ZSBkb24ndCBjYXJlXG59O1xudHlwZSBMaXN0RXhwcmVzc2lvbiA9IHtcbiAgRXhwcnM/OiBUZXJyYWZvcm1PYmplY3RbXSB8IG51bGw7XG59O1xuXG50eXBlIFRlcnJhZm9ybU9iamVjdCA9XG4gIHwgQXJpdGhtZXRpY0V4cHJlc3Npb25cbiAgfCBCcmFja2V0UHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uXG4gIHwgQ29uZGl0aW9uRXhwcmVzc2lvblxuICB8IEZvckV4cHJlc3Npb25cbiAgfCBMaXN0RXhwcmVzc2lvblxuICB8IFByb3BlcnR5QWNjZXNzRXhwcmVzc2lvblxuICB8IFRlcnJhZm9ybUVtYmVkZGVkRXhwcmVzc2lvblxuICB8IFRlcnJhZm9ybUV4cHJlc3Npb25cbiAgfCBUZXJyYWZvcm1GdW5jdGlvbkNhbGxcbiAgfCBUZXJyYWZvcm1MaXRlcmFsXG4gIHwgVGVycmFmb3JtVHJhdmVyc2FsO1xuXG50eXBlIEdvRXhwcmVzc2lvblBhcnNlUmVzdWx0ID0gbnVsbCB8IFRlcnJhZm9ybU9iamVjdDtcblxudHlwZSBSZWZlcmVuY2UgPSB7IHZhbHVlOiBzdHJpbmc7IHN0YXJ0UG9zaXRpb246IG51bWJlcjsgZW5kUG9zaXRpb246IG51bWJlciB9O1xuXG5mdW5jdGlvbiB0cmF2ZXJzYWxUb1JlZmVyZW5jZShcbiAgaW5wdXQ6IHN0cmluZyxcbiAgdHJhdmVyc2FsOiBUZXJyYWZvcm1UcmF2ZXJzYWxcbik6IFJlZmVyZW5jZSB7XG4gIGNvbnN0IGxpbmVzID0gaW5wdXQuc3BsaXQoXCJcXG5cIik7XG4gIGNvbnN0IGxpbmVMZW5ndGggPSBsaW5lcy5tYXAoKGxpbmUpID0+IGxpbmUubGVuZ3RoKTtcblxuICBmdW5jdGlvbiBwb3NpdGlvbihtYXJrZXI6IENvZGVNYXJrZXIpIHtcbiAgICBjb25zdCBuZXdsaW5lQ2hhciA9IDE7XG4gICAgcmV0dXJuIChcbiAgICAgIGxpbmVMZW5ndGhcbiAgICAgICAgLnNsaWNlKDAsIG1hcmtlci5MaW5lKVxuICAgICAgICAucmVkdWNlKChhLCBiKSA9PiBhICsgYiArIG5ld2xpbmVDaGFyLCBsaW5lcy5sZW5ndGggPT09IDEgPyAwIDogLTEpICtcbiAgICAgIG1hcmtlci5Db2x1bW5cbiAgICApO1xuICB9XG5cbiAgLy8gV2UgZG8gbm90IHdhbnQgdG8gaW5jbHVkZSBwcm9wZXJ0eSBhY2Nlc3MgdGhyb3VnaCBicmFja2V0cyBoZXJlXG4gIC8vIGFsdGhvdWdoIGl0IGlzIHRlY2huaWNhbGx5IGEgdHJhdmVyc2FsIC8gcmVmZXJlbmNlXG4gIGZ1bmN0aW9uIG9ubHlUYWtlVHJhdmVyc2FsUGFydHNVbnRpbEZpcnN0QnJhY2tldFByb3BlcnR5QWNjZXNzKFxuICAgIHRyYXZlcnNhbHM6IFRlcnJhZm9ybVRyYXZlcnNhbFBhcnRbXVxuICApIHtcbiAgICBsZXQgZmlsdGVyZWQgPSBbXTtcblxuICAgIGZvciAoY29uc3QgdHJhdmVyc2FsIG9mIHRyYXZlcnNhbHMpIHtcbiAgICAgIGlmIChcIk5hbWVcIiBpbiB0cmF2ZXJzYWwpIHtcbiAgICAgICAgZmlsdGVyZWQucHVzaCh0cmF2ZXJzYWwpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gV2UgcmVhY2hlZCBhIGJyYWNrZXQsIHN0b3BcbiAgICAgICAgcmV0dXJuIGZpbHRlcmVkO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmaWx0ZXJlZDtcbiAgfVxuICBjb25zdCBmaWx0ZXJlZFBhcnRzID0gb25seVRha2VUcmF2ZXJzYWxQYXJ0c1VudGlsRmlyc3RCcmFja2V0UHJvcGVydHlBY2Nlc3MoXG4gICAgdHJhdmVyc2FsLlRyYXZlcnNhbFxuICApO1xuXG4gIGNvbnN0IHN0YXJ0UG9zaXRpb24gPSBwb3NpdGlvbihmaWx0ZXJlZFBhcnRzWzBdLlNyY1JhbmdlLlN0YXJ0KTtcbiAgY29uc3QgZW5kUG9zaXRpb24gPSBwb3NpdGlvbihcbiAgICBmaWx0ZXJlZFBhcnRzW2ZpbHRlcmVkUGFydHMubGVuZ3RoIC0gMV0uU3JjUmFuZ2UuRW5kXG4gICk7XG5cbiAgcmV0dXJuIHtcbiAgICB2YWx1ZTogaW5wdXQuc2xpY2Uoc3RhcnRQb3NpdGlvbiwgZW5kUG9zaXRpb24pLFxuICAgIHN0YXJ0UG9zaXRpb24sXG4gICAgZW5kUG9zaXRpb24sXG4gIH07XG59XG5cbmZ1bmN0aW9uIGZpbmRBbGxSZWZlcmVuY2VzSW5Bc3QoXG4gIGlucHV0OiBzdHJpbmcsXG4gIGVudHJ5OiBUZXJyYWZvcm1PYmplY3QgfCB1bmRlZmluZWQgfCBudWxsXG4pOiBSZWZlcmVuY2VbXSB7XG4gIGlmICghZW50cnkpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICAvLyBUaGlzIHRyYXZlcnNhbCBpcyBhY2Nlc3NpbmcgYSBmdW5jdGlvbiBjYWxsIGUuZy4gZWxlbWVudCh2YXIuZm9vLCAwKS5pZFxuICAvLyBPciB0aGlzIGlzIGEgc3BsYXQgb3BlcmF0aW9uIHZhci5mb28uKlxuICBpZiAoXCJTb3VyY2VcIiBpbiBlbnRyeSkge1xuICAgIHJldHVybiBmaW5kQWxsUmVmZXJlbmNlc0luQXN0KGlucHV0LCBlbnRyeS5Tb3VyY2UpO1xuICB9XG5cbiAgLy8gYS5iLmMuZCBpcyBhIHRyYXZlcnNhbFxuICBpZiAoXCJUcmF2ZXJzYWxcIiBpbiBlbnRyeSkge1xuICAgIHJldHVybiBbdHJhdmVyc2FsVG9SZWZlcmVuY2UoaW5wdXQsIGVudHJ5KV07XG4gIH1cblxuICAvLyBNdWx0aXBsZSB0ZXJyYWZvcm0gcGFydHMgaW4gYW4gZXhwcmVzc2lvblxuICBpZiAoXCJQYXJ0c1wiIGluIGVudHJ5KSB7XG4gICAgcmV0dXJuIGVudHJ5LlBhcnRzLmZsYXRNYXAoKHBhcnQpID0+IGZpbmRBbGxSZWZlcmVuY2VzSW5Bc3QoaW5wdXQsIHBhcnQpKTtcbiAgfVxuXG4gIC8vICR7fSBpcyBhbiBlbWJlZGRlZCBleHByZXNzaW9uXG4gIGlmIChcIldyYXBwZWRcIiBpbiBlbnRyeSkge1xuICAgIHJldHVybiBmaW5kQWxsUmVmZXJlbmNlc0luQXN0KGlucHV0LCBlbnRyeS5XcmFwcGVkKTtcbiAgfVxuXG4gIC8vIGVsZW1lbnQodmFyLmZvbywgMCkgaXMgYSBmdW5jdGlvbiBjYWxsXG4gIGlmIChcIkFyZ3NcIiBpbiBlbnRyeSkge1xuICAgIHJldHVybiBlbnRyeS5BcmdzLmZsYXRNYXAoKGFyZykgPT4gZmluZEFsbFJlZmVyZW5jZXNJbkFzdChpbnB1dCwgYXJnKSk7XG4gIH1cblxuICAvLyB2YXIuZm9vICsgdmFyLmJhciBpcyBhbiBhcml0aG1ldGljIGV4cHJlc3Npb25cbiAgaWYgKFwiTEhTXCIgaW4gZW50cnkpIHtcbiAgICByZXR1cm4gW1xuICAgICAgLi4uZmluZEFsbFJlZmVyZW5jZXNJbkFzdChpbnB1dCwgZW50cnkuTEhTKSxcbiAgICAgIC4uLmZpbmRBbGxSZWZlcmVuY2VzSW5Bc3QoaW5wdXQsIGVudHJ5LlJIUyksXG4gICAgXTtcbiAgfVxuXG4gIC8vIHZhci5mb28gPiAzID8gdmFyLmJhciA6IHZhci5iYXogaXMgYSBjb25kaXRpb24gZXhwcmVzc2lvblxuICBpZiAoXCJDb25kaXRpb25cIiBpbiBlbnRyeSkge1xuICAgIHJldHVybiBbXG4gICAgICAuLi5maW5kQWxsUmVmZXJlbmNlc0luQXN0KGlucHV0LCBlbnRyeS5Db25kaXRpb24pLFxuICAgICAgLi4uZmluZEFsbFJlZmVyZW5jZXNJbkFzdChpbnB1dCwgZW50cnkuVHJ1ZVJlc3VsdCksXG4gICAgICAuLi5maW5kQWxsUmVmZXJlbmNlc0luQXN0KGlucHV0LCBlbnRyeS5GYWxzZVJlc3VsdCksXG4gICAgXTtcbiAgfVxuXG4gIC8vIGZvciBuYW1lLCB1c2VyIGluIHZhci51c2VycyA6IHVzZXIucm9sZSA9PiBuYW1lLi4uIGlzIGEgZm9yIGV4cHJlc3Npb25cbiAgaWYgKFwiQ29uZEV4cHJcIiBpbiBlbnRyeSkge1xuICAgIHJldHVybiBbXG4gICAgICAuLi5maW5kQWxsUmVmZXJlbmNlc0luQXN0KGlucHV0LCBlbnRyeS5Db2xsRXhwciksXG4gICAgICAuLi5maW5kQWxsUmVmZXJlbmNlc0luQXN0KGlucHV0LCBlbnRyeS5Db25kRXhwciksXG4gICAgXTtcbiAgfVxuXG4gIC8vIHZhci5mb29bXCJiYXJcIl0gaXMgYSBicmFja2V0IHByb3BlcnR5IGFjY2VzcyBleHByZXNzaW9uXG4gIGlmIChcIktleVwiIGluIGVudHJ5KSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIC4uLmZpbmRBbGxSZWZlcmVuY2VzSW5Bc3QoaW5wdXQsIGVudHJ5LkNvbGxlY3Rpb24pLFxuICAgICAgLi4uZmluZEFsbFJlZmVyZW5jZXNJbkFzdChpbnB1dCwgZW50cnkuS2V5KSxcbiAgICBdO1xuICB9XG5cbiAgLy8gW3Zhci5mb28sIHZhci5iYXJdIGlzIGEgbGlzdCBleHByZXNzaW9uXG4gIGlmIChcIkV4cHJzXCIgaW4gZW50cnkpIHtcbiAgICByZXR1cm4gKGVudHJ5LkV4cHJzIHx8IFtdKS5mbGF0TWFwKChleHByKSA9PlxuICAgICAgZmluZEFsbFJlZmVyZW5jZXNJbkFzdChpbnB1dCwgZXhwcilcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIFtdO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UmVmZXJlbmNlc0luRXhwcmVzc2lvbihcbiAgZmlsZW5hbWU6IHN0cmluZyxcbiAgZXhwcmVzc2lvbjogc3RyaW5nXG4pOiBQcm9taXNlPFJlZmVyZW5jZVtdPiB7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IHdhc20uZ2V0UmVmZXJlbmNlc0luRXhwcmVzc2lvbihcbiAgICBmaWxlbmFtZSxcbiAgICBKU09OLnN0cmluZ2lmeShleHByZXNzaW9uKVxuICApO1xuICBjb25zdCBhc3QgPSBKU09OLnBhcnNlKHJlcykgYXMgR29FeHByZXNzaW9uUGFyc2VSZXN1bHQ7XG5cbiAgaWYgKCFhc3QpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICByZXR1cm4gZmluZEFsbFJlZmVyZW5jZXNJbkFzdChleHByZXNzaW9uLCBhc3QpO1xufVxuIl19