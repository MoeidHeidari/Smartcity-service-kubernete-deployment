"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TerraformLogin = void 0;
const fs = __importStar(require("fs"));
const inquirer = __importStar(require("inquirer"));
const open = __importStar(require("open"));
const chalk = __importStar(require("chalk"));
const terraformCloudClient = __importStar(require("./terraform-cloud-client"));
const logging_1 = require("../../../lib/logging");
const chalkColour = new chalk.Instance();
const homedir = require("os").homedir();
const terraformCredentialsFilePath = `${homedir}/.terraform.d/credentials.tfrc.json`;
class TerraformLogin {
    constructor(tfeHostname) {
        this.tfeHostname = tfeHostname;
    }
    get terraformLoginURL() {
        return `https://${this.tfeHostname}/app/settings/tokens?source=terraform-login`;
    }
    async askToContinue() {
        // Describe the command
        console.log(chalkColour `{greenBright Welcome to CDK for Terraform!}

By default, cdktf allows you to manage the state of your stacks using Terraform Cloud for free.
cdktf will request an API token for ${this.tfeHostname} using your browser.

If login is successful, cdktf will store the token in plain text in
the following file for use by subsequent Terraform commands:
    {whiteBright ${terraformCredentialsFilePath}}

{yellow Note: The local storage mode isn't recommended for storing the state of your stacks.}
`);
        let isLogin = false;
        const { tfCloud } = await inquirer.prompt([
            {
                name: "tfCloud",
                type: "confirm",
                message: "Do you want to continue with Terraform Cloud remote state management?",
            },
        ]);
        if (tfCloud) {
            isLogin = true;
            this.openBrowser();
        }
        return isLogin;
    }
    openBrowser() {
        console.log(`\nopening webpage using your browser.....\n`);
        console.log(chalkColour `If the web browser didn't open the window automatically, you can go to the following url:
        {whiteBright ${this.terraformLoginURL}}\n`);
        return open.default(this.terraformLoginURL);
    }
    async askForToken() {
        const { token } = await inquirer.prompt([
            {
                name: "token",
                message: `Token for ${this.tfeHostname} ðŸ”‘`,
                type: "password",
            },
        ]);
        return token;
    }
    async saveTerraformCredentials(token) {
        const terraformCredentials = await this.getTerraformCredentialsFile();
        const credentialsFileJSON = JSON.stringify({
            ...terraformCredentials,
            credentials: {
                ...terraformCredentials.credentials,
                [this.tfeHostname]: { token: token },
            },
        }, undefined, 2);
        fs.writeFileSync(terraformCredentialsFilePath, credentialsFileJSON);
    }
    async checkIfTerraformCredentialsExist() {
        if (fs.existsSync(terraformCredentialsFilePath)) {
            const token = await this.getTokenFromTerraformCredentialsFile();
            if (token != "") {
                return true;
            }
        }
        return false;
    }
    async getTokenFromTerraformCredentialsFile() {
        const terraformCredentials = await this.getTerraformCredentialsFile();
        if (this.tfeHostname in terraformCredentials.credentials) {
            return terraformCredentials.credentials[this.tfeHostname].token;
        }
        return "";
    }
    async getTerraformCredentialsFile() {
        try {
            const credentialsFile = JSON.parse(fs.readFileSync(terraformCredentialsFilePath).toString());
            const terraformCredentials = credentialsFile;
            return terraformCredentials;
        }
        catch (e) {
            logging_1.logger.debug(`Could not find terraform credentials file at ${terraformCredentialsFilePath}`);
            return { credentials: {} };
        }
    }
    async isTokenValid(token) {
        try {
            await terraformCloudClient.getAccountDetails(this.tfeHostname, token);
            return true;
        }
        catch (e) {
            if (e.statusCode === 401) {
                return false;
            }
            throw e;
        }
    }
    async askToLogin() {
        const hasToken = await this.checkIfTerraformCredentialsExist();
        const token = hasToken
            ? await this.getTokenFromTerraformCredentialsFile()
            : null;
        if (token && (await this.isTokenValid(token))) {
            return token;
        }
        // we either have no token or not a valid one
        const shouldContinue = await this.askToContinue();
        if (shouldContinue) {
            const token = await this.askForToken();
            if (token == "") {
                console.error(`\nERROR: failed to gather token.\n`);
                process.exit(1);
            }
            this.saveTerraformCredentials(token);
            return token;
        }
        return ""; // cancel
    }
}
exports.TerraformLogin = TerraformLogin;
// Note: we might want to look into using 'readline' instead for async reading of input.
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFmb3JtLWxvZ2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVycmFmb3JtLWxvZ2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1Q0FBeUI7QUFDekIsbURBQXFDO0FBQ3JDLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFDL0IsK0VBQWlFO0FBQ2pFLGtEQUE4QztBQUU5QyxNQUFNLFdBQVcsR0FBRyxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUN6QyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDeEMsTUFBTSw0QkFBNEIsR0FBRyxHQUFHLE9BQU8scUNBQXFDLENBQUM7QUFjckYsTUFBYSxjQUFjO0lBQ3pCLFlBQTZCLFdBQW1CO1FBQW5CLGdCQUFXLEdBQVgsV0FBVyxDQUFRO0lBQUcsQ0FBQztJQUVwRCxJQUFZLGlCQUFpQjtRQUMzQixPQUFPLFdBQVcsSUFBSSxDQUFDLFdBQVcsNkNBQTZDLENBQUM7SUFDbEYsQ0FBQztJQUNNLEtBQUssQ0FBQyxhQUFhO1FBQ3hCLHVCQUF1QjtRQUN2QixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQTs7O3NDQUdXLElBQUksQ0FBQyxXQUFXOzs7O21CQUluQyw0QkFBNEI7OztDQUc5QyxDQUFDLENBQUM7UUFFQyxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFFcEIsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLE1BQU0sUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUN4QztnQkFDRSxJQUFJLEVBQUUsU0FBUztnQkFDZixJQUFJLEVBQUUsU0FBUztnQkFDZixPQUFPLEVBQ0wsdUVBQXVFO2FBQzFFO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxPQUFPLEVBQUU7WUFDWCxPQUFPLEdBQUcsSUFBSSxDQUFDO1lBQ2YsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3BCO1FB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QUNELE1BQU0sQ0FBQyxDQUFDO1NBQ1Q7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLFVBQVU7UUFDckIsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQztRQUMvRCxNQUFNLEtBQUssR0FBa0IsUUFBUTtZQUNuQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsb0NBQW9DLEVBQUU7WUFDbkQsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUVULElBQUksS0FBSyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDN0MsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELDZDQUE2QztRQUM3QyxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNsRCxJQUFJLGNBQWMsRUFBRTtZQUNsQixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUN2QyxJQUFJLEtBQUssSUFBSSxFQUFFLEVBQUU7Z0JBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO2dCQUNwRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2pCO1lBQ0QsSUFBSSxDQUFDLHdCQUF3QixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3JDLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPLEVBQUUsQ0FBQyxDQUFDLFNBQVM7SUFDdEIsQ0FBQztDQUNGO0FBaEpELHdDQWdKQztBQUVELHdGQUF3RiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgaW5xdWlyZXIgZnJvbSBcImlucXVpcmVyXCI7XG5pbXBvcnQgKiBhcyBvcGVuIGZyb20gXCJvcGVuXCI7XG5pbXBvcnQgKiBhcyBjaGFsayBmcm9tIFwiY2hhbGtcIjtcbmltcG9ydCAqIGFzIHRlcnJhZm9ybUNsb3VkQ2xpZW50IGZyb20gXCIuL3RlcnJhZm9ybS1jbG91ZC1jbGllbnRcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCIuLi8uLi8uLi9saWIvbG9nZ2luZ1wiO1xuXG5jb25zdCBjaGFsa0NvbG91ciA9IG5ldyBjaGFsay5JbnN0YW5jZSgpO1xuY29uc3QgaG9tZWRpciA9IHJlcXVpcmUoXCJvc1wiKS5ob21lZGlyKCk7XG5jb25zdCB0ZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGVQYXRoID0gYCR7aG9tZWRpcn0vLnRlcnJhZm9ybS5kL2NyZWRlbnRpYWxzLnRmcmMuanNvbmA7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSG9zdG5hbWUge1xuICB0b2tlbjogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENyZWRlbnRpYWxzIHtcbiAgW3RmZUhvc3RuYW1lOiBzdHJpbmddOiBIb3N0bmFtZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGUge1xuICBjcmVkZW50aWFsczogQ3JlZGVudGlhbHM7XG59XG5cbmV4cG9ydCBjbGFzcyBUZXJyYWZvcm1Mb2dpbiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgdGZlSG9zdG5hbWU6IHN0cmluZykge31cblxuICBwcml2YXRlIGdldCB0ZXJyYWZvcm1Mb2dpblVSTCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgaHR0cHM6Ly8ke3RoaXMudGZlSG9zdG5hbWV9L2FwcC9zZXR0aW5ncy90b2tlbnM/c291cmNlPXRlcnJhZm9ybS1sb2dpbmA7XG4gIH1cbiAgcHVibGljIGFzeW5jIGFza1RvQ29udGludWUoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gRGVzY3JpYmUgdGhlIGNvbW1hbmRcbiAgICBjb25zb2xlLmxvZyhjaGFsa0NvbG91cmB7Z3JlZW5CcmlnaHQgV2VsY29tZSB0byBDREsgZm9yIFRlcnJhZm9ybSF9XG5cbkJ5IGRlZmF1bHQsIGNka3RmIGFsbG93cyB5b3UgdG8gbWFuYWdlIHRoZSBzdGF0ZSBvZiB5b3VyIHN0YWNrcyB1c2luZyBUZXJyYWZvcm0gQ2xvdWQgZm9yIGZyZWUuXG5jZGt0ZiB3aWxsIHJlcXVlc3QgYW4gQVBJIHRva2VuIGZvciAke3RoaXMudGZlSG9zdG5hbWV9IHVzaW5nIHlvdXIgYnJvd3Nlci5cblxuSWYgbG9naW4gaXMgc3VjY2Vzc2Z1bCwgY2RrdGYgd2lsbCBzdG9yZSB0aGUgdG9rZW4gaW4gcGxhaW4gdGV4dCBpblxudGhlIGZvbGxvd2luZyBmaWxlIGZvciB1c2UgYnkgc3Vic2VxdWVudCBUZXJyYWZvcm0gY29tbWFuZHM6XG4gICAge3doaXRlQnJpZ2h0ICR7dGVycmFmb3JtQ3JlZGVudGlhbHNGaWxlUGF0aH19XG5cbnt5ZWxsb3cgTm90ZTogVGhlIGxvY2FsIHN0b3JhZ2UgbW9kZSBpc24ndCByZWNvbW1lbmRlZCBmb3Igc3RvcmluZyB0aGUgc3RhdGUgb2YgeW91ciBzdGFja3MufVxuYCk7XG5cbiAgICBsZXQgaXNMb2dpbiA9IGZhbHNlO1xuXG4gICAgY29uc3QgeyB0ZkNsb3VkIH0gPSBhd2FpdCBpbnF1aXJlci5wcm9tcHQoW1xuICAgICAge1xuICAgICAgICBuYW1lOiBcInRmQ2xvdWRcIixcbiAgICAgICAgdHlwZTogXCJjb25maXJtXCIsXG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgXCJEbyB5b3Ugd2FudCB0byBjb250aW51ZSB3aXRoIFRlcnJhZm9ybSBDbG91ZCByZW1vdGUgc3RhdGUgbWFuYWdlbWVudD9cIixcbiAgICAgIH0sXG4gICAgXSk7XG5cbiAgICBpZiAodGZDbG91ZCkge1xuICAgICAgaXNMb2dpbiA9IHRydWU7XG4gICAgICB0aGlzLm9wZW5Ccm93c2VyKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGlzTG9naW47XG4gIH1cblxuICBvcGVuQnJvd3NlcigpIHtcbiAgICBjb25zb2xlLmxvZyhgXFxub3BlbmluZyB3ZWJwYWdlIHVzaW5nIHlvdXIgYnJvd3Nlci4uLi4uXFxuYCk7XG4gICAgY29uc29sZS5sb2coY2hhbGtDb2xvdXJgSWYgdGhlIHdlYiBicm93c2VyIGRpZG4ndCBvcGVuIHRoZSB3aW5kb3cgYXV0b21hdGljYWxseSwgeW91IGNhbiBnbyB0byB0aGUgZm9sbG93aW5nIHVybDpcbiAgICAgICAge3doaXRlQnJpZ2h0ICR7dGhpcy50ZXJyYWZvcm1Mb2dpblVSTH19XFxuYCk7XG4gICAgcmV0dXJuIG9wZW4uZGVmYXVsdCh0aGlzLnRlcnJhZm9ybUxvZ2luVVJMKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhc2tGb3JUb2tlbigpIHtcbiAgICBjb25zdCB7IHRva2VuIH0gPSBhd2FpdCBpbnF1aXJlci5wcm9tcHQoW1xuICAgICAge1xuICAgICAgICBuYW1lOiBcInRva2VuXCIsXG4gICAgICAgIG1lc3NhZ2U6IGBUb2tlbiBmb3IgJHt0aGlzLnRmZUhvc3RuYW1lfSDwn5SRYCxcbiAgICAgICAgdHlwZTogXCJwYXNzd29yZFwiLFxuICAgICAgfSxcbiAgICBdKTtcbiAgICByZXR1cm4gdG9rZW47XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2F2ZVRlcnJhZm9ybUNyZWRlbnRpYWxzKHRva2VuOiBzdHJpbmcpIHtcbiAgICBjb25zdCB0ZXJyYWZvcm1DcmVkZW50aWFscyA9IGF3YWl0IHRoaXMuZ2V0VGVycmFmb3JtQ3JlZGVudGlhbHNGaWxlKCk7XG4gICAgY29uc3QgY3JlZGVudGlhbHNGaWxlSlNPTiA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAge1xuICAgICAgICAuLi50ZXJyYWZvcm1DcmVkZW50aWFscyxcbiAgICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgICAuLi50ZXJyYWZvcm1DcmVkZW50aWFscy5jcmVkZW50aWFscyxcbiAgICAgICAgICBbdGhpcy50ZmVIb3N0bmFtZV06IHsgdG9rZW46IHRva2VuIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgMlxuICAgICk7XG4gICAgZnMud3JpdGVGaWxlU3luYyh0ZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGVQYXRoLCBjcmVkZW50aWFsc0ZpbGVKU09OKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjaGVja0lmVGVycmFmb3JtQ3JlZGVudGlhbHNFeGlzdCgpIHtcbiAgICBpZiAoZnMuZXhpc3RzU3luYyh0ZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGVQYXRoKSkge1xuICAgICAgY29uc3QgdG9rZW4gPSBhd2FpdCB0aGlzLmdldFRva2VuRnJvbVRlcnJhZm9ybUNyZWRlbnRpYWxzRmlsZSgpO1xuICAgICAgaWYgKHRva2VuICE9IFwiXCIpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFRva2VuRnJvbVRlcnJhZm9ybUNyZWRlbnRpYWxzRmlsZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHRlcnJhZm9ybUNyZWRlbnRpYWxzID0gYXdhaXQgdGhpcy5nZXRUZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGUoKTtcbiAgICBpZiAodGhpcy50ZmVIb3N0bmFtZSBpbiB0ZXJyYWZvcm1DcmVkZW50aWFscy5jcmVkZW50aWFscykge1xuICAgICAgcmV0dXJuIHRlcnJhZm9ybUNyZWRlbnRpYWxzLmNyZWRlbnRpYWxzW3RoaXMudGZlSG9zdG5hbWVdLnRva2VuO1xuICAgIH1cblxuICAgIHJldHVybiBcIlwiO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFRlcnJhZm9ybUNyZWRlbnRpYWxzRmlsZSgpOiBQcm9taXNlPFRlcnJhZm9ybUNyZWRlbnRpYWxzRmlsZT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjcmVkZW50aWFsc0ZpbGUgPSBKU09OLnBhcnNlKFxuICAgICAgICBmcy5yZWFkRmlsZVN5bmModGVycmFmb3JtQ3JlZGVudGlhbHNGaWxlUGF0aCkudG9TdHJpbmcoKVxuICAgICAgKTtcbiAgICAgIGNvbnN0IHRlcnJhZm9ybUNyZWRlbnRpYWxzOiBUZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGUgPSBjcmVkZW50aWFsc0ZpbGU7XG5cbiAgICAgIHJldHVybiB0ZXJyYWZvcm1DcmVkZW50aWFscztcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgIGBDb3VsZCBub3QgZmluZCB0ZXJyYWZvcm0gY3JlZGVudGlhbHMgZmlsZSBhdCAke3RlcnJhZm9ybUNyZWRlbnRpYWxzRmlsZVBhdGh9YFxuICAgICAgKTtcbiAgICAgIHJldHVybiB7IGNyZWRlbnRpYWxzOiB7fSB9O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBpc1Rva2VuVmFsaWQodG9rZW46IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0ZXJyYWZvcm1DbG91ZENsaWVudC5nZXRBY2NvdW50RGV0YWlscyh0aGlzLnRmZUhvc3RuYW1lLCB0b2tlbik7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoKGUgYXMgYW55KS5zdGF0dXNDb2RlID09PSA0MDEpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYXNrVG9Mb2dpbigpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGhhc1Rva2VuID0gYXdhaXQgdGhpcy5jaGVja0lmVGVycmFmb3JtQ3JlZGVudGlhbHNFeGlzdCgpO1xuICAgIGNvbnN0IHRva2VuOiBzdHJpbmcgfCBudWxsID0gaGFzVG9rZW5cbiAgICAgID8gYXdhaXQgdGhpcy5nZXRUb2tlbkZyb21UZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGUoKVxuICAgICAgOiBudWxsO1xuXG4gICAgaWYgKHRva2VuICYmIChhd2FpdCB0aGlzLmlzVG9rZW5WYWxpZCh0b2tlbikpKSB7XG4gICAgICByZXR1cm4gdG9rZW47XG4gICAgfVxuXG4gICAgLy8gd2UgZWl0aGVyIGhhdmUgbm8gdG9rZW4gb3Igbm90IGEgdmFsaWQgb25lXG4gICAgY29uc3Qgc2hvdWxkQ29udGludWUgPSBhd2FpdCB0aGlzLmFza1RvQ29udGludWUoKTtcbiAgICBpZiAoc2hvdWxkQ29udGludWUpIHtcbiAgICAgIGNvbnN0IHRva2VuID0gYXdhaXQgdGhpcy5hc2tGb3JUb2tlbigpO1xuICAgICAgaWYgKHRva2VuID09IFwiXCIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgXFxuRVJST1I6IGZhaWxlZCB0byBnYXRoZXIgdG9rZW4uXFxuYCk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2F2ZVRlcnJhZm9ybUNyZWRlbnRpYWxzKHRva2VuKTtcbiAgICAgIHJldHVybiB0b2tlbjtcbiAgICB9XG4gICAgcmV0dXJuIFwiXCI7IC8vIGNhbmNlbFxuICB9XG59XG5cbi8vIE5vdGU6IHdlIG1pZ2h0IHdhbnQgdG8gbG9vayBpbnRvIHVzaW5nICdyZWFkbGluZScgaW5zdGVhZCBmb3IgYXN5bmMgcmVhZGluZyBvZiBpbnB1dC5cbiJdfQ==