"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getOrganizationNames = exports.createWorkspace = exports.getAccountDetails = void 0;
const https = require("https");
const url_1 = require("url");
const SUCCESS_STATUS_CODES = [200, 201];
async function get(url, token) {
    return new Promise((ok, ko) => {
        const req = https.request(url_1.format(url), { headers: { Authorization: `Bearer ${token}` } }, (res) => {
            if (res.statusCode !== 200) {
                if (res.statusCode === 401) {
                    console.log("ERROR: Your existing token for Terraform Cloud is invalid.");
                }
                const error = new Error(res.statusMessage);
                error.statusCode = res.statusCode;
                return ko(error);
            }
            const data = new Array();
            res.on("data", (chunk) => data.push(chunk));
            res.once("error", (err) => ko(err));
            res.once("end", () => {
                const response = JSON.parse(Buffer.concat(data).toString("utf-8"));
                return ok(response);
            });
        });
        req.end();
    });
}
async function post(url, token, data) {
    return new Promise((ok, ko) => {
        const req = https.request(url_1.format(url), {
            headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/vnd.api+json",
                "Content-Length": data.length,
            },
            method: "POST",
        }, (res) => {
            const data = new Array();
            res.on("data", (chunk) => data.push(chunk));
            res.once("error", (err) => ko(err));
            res.once("end", () => {
                const response = JSON.parse(Buffer.concat(data).toString("utf-8"));
                if (res.statusCode) {
                    const statusCode = res.statusCode;
                    if (!SUCCESS_STATUS_CODES.includes(statusCode)) {
                        const { errors } = response;
                        const message = errors
                            .map((error) => error.detail)
                            .join(", ");
                        return ko(new Error(message));
                    }
                }
                return ok(response);
            });
        });
        req.write(data);
        req.end();
    });
}
async function getAccountDetails(tfeHostname, token) {
    return (await get(`https://${tfeHostname}/api/v2//account/details`, token));
}
exports.getAccountDetails = getAccountDetails;
async function createWorkspace(tfeHostname, organizationName, workspaceName, token) {
    await post(`https://${tfeHostname}/api/v2//organizations/${organizationName}/workspaces`, token, JSON.stringify({
        data: {
            attributes: {
                name: workspaceName,
                operations: false,
            },
            type: "workspaces",
        },
    }));
}
exports.createWorkspace = createWorkspace;
async function getOrganizationNames(tfeHostname, token) {
    return (await get(`https://${tfeHostname}/api/v2//organizations`, token));
}
exports.getOrganizationNames = getOrganizationNames;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFmb3JtLWNsb3VkLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlcnJhZm9ybS1jbG91ZC1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQWdDO0FBQ2hDLDZCQUE2QjtBQUU3QixNQUFNLG9CQUFvQixHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBMkJ4QyxLQUFLLFVBQVUsR0FBRyxDQUFDLEdBQVcsRUFBRSxLQUFhO0lBQzNDLE9BQU8sSUFBSSxPQUFPLENBQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUU7UUFDakMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FDdkIsWUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUNYLEVBQUUsT0FBTyxFQUFFLEVBQUUsYUFBYSxFQUFFLFVBQVUsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUNqRCxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ04sSUFBSSxHQUFHLENBQUMsVUFBVSxLQUFLLEdBQUcsRUFBRTtnQkFDMUIsSUFBSSxHQUFHLENBQUMsVUFBVSxLQUFLLEdBQUcsRUFBRTtvQkFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FDVCw0REFBNEQsQ0FDN0QsQ0FBQztpQkFDSDtnQkFDRCxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQzFDLEtBQWEsQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQztnQkFDM0MsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDbEI7WUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFDO1lBQ2pDLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFFNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRTtnQkFDbkIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNuRSxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FDRixDQUFDO1FBRUYsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ1osQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsS0FBSyxVQUFVLElBQUksQ0FBQyxHQUFXLEVBQUUsS0FBYSxFQUFFLElBQVk7SUFDMUQsT0FBTyxJQUFJLE9BQU8sQ0FBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRTtRQUNqQyxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUN2QixZQUFNLENBQUMsR0FBRyxDQUFDLEVBQ1g7WUFDRSxPQUFPLEVBQUU7Z0JBQ1AsYUFBYSxFQUFFLFVBQVUsS0FBSyxFQUFFO2dCQUNoQyxjQUFjLEVBQUUsMEJBQTBCO2dCQUMxQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsTUFBTTthQUM5QjtZQUNELE1BQU0sRUFBRSxNQUFNO1NBQ2YsRUFDRCxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ04sTUFBTSxJQUFJLEdBQUcsSUFBSSxLQUFLLEVBQVUsQ0FBQztZQUNqQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQzVDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNwQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUU7Z0JBQ25CLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFFbkUsSUFBSSxHQUFHLENBQUMsVUFBVSxFQUFFO29CQUNsQixNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDO29CQUNsQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFO3dCQUM5QyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDO3dCQUM1QixNQUFNLE9BQU8sR0FBRyxNQUFNOzZCQUNuQixHQUFHLENBQUMsQ0FBQyxLQUF5QixFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDOzZCQUNoRCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7d0JBRWQsT0FBTyxFQUFFLENBQUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztxQkFDL0I7aUJBQ0Y7Z0JBQ0QsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdEIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQ0YsQ0FBQztRQUVGLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFaEIsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ1osQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRU0sS0FBSyxVQUFVLGlCQUFpQixDQUFDLFdBQW1CLEVBQUUsS0FBYTtJQUN4RSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQ2YsV0FBVyxXQUFXLDBCQUEwQixFQUNoRCxLQUFLLENBQ04sQ0FBWSxDQUFDO0FBQ2hCLENBQUM7QUFMRCw4Q0FLQztBQUVNLEtBQUssVUFBVSxlQUFlLENBQ25DLFdBQW1CLEVBQ25CLGdCQUF3QixFQUN4QixhQUFxQixFQUNyQixLQUFhO0lBRWIsTUFBTSxJQUFJLENBQ1IsV0FBVyxXQUFXLDBCQUEwQixnQkFBZ0IsYUFBYSxFQUM3RSxLQUFLLEVBQ0wsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNiLElBQUksRUFBRTtZQUNKLFVBQVUsRUFBRTtnQkFDVixJQUFJLEVBQUUsYUFBYTtnQkFDbkIsVUFBVSxFQUFFLEtBQUs7YUFDbEI7WUFDRCxJQUFJLEVBQUUsWUFBWTtTQUNuQjtLQUNGLENBQUMsQ0FDSCxDQUFDO0FBQ0osQ0FBQztBQW5CRCwwQ0FtQkM7QUFFTSxLQUFLLFVBQVUsb0JBQW9CLENBQUMsV0FBbUIsRUFBRSxLQUFhO0lBQzNFLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FDZixXQUFXLFdBQVcsd0JBQXdCLEVBQzlDLEtBQUssQ0FDTixDQUFpQixDQUFDO0FBQ3JCLENBQUM7QUFMRCxvREFLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBodHRwcyA9IHJlcXVpcmUoXCJodHRwc1wiKTtcbmltcG9ydCB7IGZvcm1hdCB9IGZyb20gXCJ1cmxcIjtcblxuY29uc3QgU1VDQ0VTU19TVEFUVVNfQ09ERVMgPSBbMjAwLCAyMDFdO1xuXG5leHBvcnQgaW50ZXJmYWNlIEF0dHJpYnV0ZXMge1xuICB1c2VybmFtZTogc3RyaW5nO1xuICBcImF2YXRhci11cmxcIjogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERhdGEge1xuICBpZDogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWNjb3VudCB7XG4gIGRhdGE6IERhdGE7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3JnYW5pemF0aW9uRGF0YSB7XG4gIGlkOiBzdHJpbmc7XG4gIHR5cGU6IHN0cmluZztcbiAgYXR0cmlidXRlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3JnYW5pemF0aW9uIHtcbiAgZGF0YTogT3JnYW5pemF0aW9uRGF0YVtdO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXQodXJsOiBzdHJpbmcsIHRva2VuOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKG9rLCBrbykgPT4ge1xuICAgIGNvbnN0IHJlcSA9IGh0dHBzLnJlcXVlc3QoXG4gICAgICBmb3JtYXQodXJsKSxcbiAgICAgIHsgaGVhZGVyczogeyBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCB9IH0sXG4gICAgICAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSAhPT0gMjAwKSB7XG4gICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09PSA0MDEpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICBcIkVSUk9SOiBZb3VyIGV4aXN0aW5nIHRva2VuIGZvciBUZXJyYWZvcm0gQ2xvdWQgaXMgaW52YWxpZC5cIlxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IocmVzLnN0YXR1c01lc3NhZ2UpO1xuICAgICAgICAgIChlcnJvciBhcyBhbnkpLnN0YXR1c0NvZGUgPSByZXMuc3RhdHVzQ29kZTtcbiAgICAgICAgICByZXR1cm4ga28oZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRhdGEgPSBuZXcgQXJyYXk8QnVmZmVyPigpO1xuICAgICAgICByZXMub24oXCJkYXRhXCIsIChjaHVuaykgPT4gZGF0YS5wdXNoKGNodW5rKSk7XG5cbiAgICAgICAgcmVzLm9uY2UoXCJlcnJvclwiLCAoZXJyKSA9PiBrbyhlcnIpKTtcbiAgICAgICAgcmVzLm9uY2UoXCJlbmRcIiwgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gSlNPTi5wYXJzZShCdWZmZXIuY29uY2F0KGRhdGEpLnRvU3RyaW5nKFwidXRmLThcIikpO1xuICAgICAgICAgIHJldHVybiBvayhyZXNwb25zZSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICk7XG5cbiAgICByZXEuZW5kKCk7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwb3N0KHVybDogc3RyaW5nLCB0b2tlbjogc3RyaW5nLCBkYXRhOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKG9rLCBrbykgPT4ge1xuICAgIGNvbnN0IHJlcSA9IGh0dHBzLnJlcXVlc3QoXG4gICAgICBmb3JtYXQodXJsKSxcbiAgICAgIHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0b2tlbn1gLFxuICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vdm5kLmFwaStqc29uXCIsXG4gICAgICAgICAgXCJDb250ZW50LUxlbmd0aFwiOiBkYXRhLmxlbmd0aCxcbiAgICAgICAgfSxcbiAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgIH0sXG4gICAgICAocmVzKSA9PiB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBuZXcgQXJyYXk8QnVmZmVyPigpO1xuICAgICAgICByZXMub24oXCJkYXRhXCIsIChjaHVuaykgPT4gZGF0YS5wdXNoKGNodW5rKSk7XG4gICAgICAgIHJlcy5vbmNlKFwiZXJyb3JcIiwgKGVycikgPT4ga28oZXJyKSk7XG4gICAgICAgIHJlcy5vbmNlKFwiZW5kXCIsICgpID0+IHtcbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IEpTT04ucGFyc2UoQnVmZmVyLmNvbmNhdChkYXRhKS50b1N0cmluZyhcInV0Zi04XCIpKTtcblxuICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSkge1xuICAgICAgICAgICAgY29uc3Qgc3RhdHVzQ29kZSA9IHJlcy5zdGF0dXNDb2RlO1xuICAgICAgICAgICAgaWYgKCFTVUNDRVNTX1NUQVRVU19DT0RFUy5pbmNsdWRlcyhzdGF0dXNDb2RlKSkge1xuICAgICAgICAgICAgICBjb25zdCB7IGVycm9ycyB9ID0gcmVzcG9uc2U7XG4gICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnJvcnNcbiAgICAgICAgICAgICAgICAubWFwKChlcnJvcjogeyBkZXRhaWw6IHN0cmluZyB9KSA9PiBlcnJvci5kZXRhaWwpXG4gICAgICAgICAgICAgICAgLmpvaW4oXCIsIFwiKTtcblxuICAgICAgICAgICAgICByZXR1cm4ga28obmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIG9rKHJlc3BvbnNlKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgKTtcblxuICAgIHJlcS53cml0ZShkYXRhKTtcblxuICAgIHJlcS5lbmQoKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBY2NvdW50RGV0YWlscyh0ZmVIb3N0bmFtZTogc3RyaW5nLCB0b2tlbjogc3RyaW5nKSB7XG4gIHJldHVybiAoYXdhaXQgZ2V0KFxuICAgIGBodHRwczovLyR7dGZlSG9zdG5hbWV9L2FwaS92Mi8vYWNjb3VudC9kZXRhaWxzYCxcbiAgICB0b2tlblxuICApKSBhcyBBY2NvdW50O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlV29ya3NwYWNlKFxuICB0ZmVIb3N0bmFtZTogc3RyaW5nLFxuICBvcmdhbml6YXRpb25OYW1lOiBzdHJpbmcsXG4gIHdvcmtzcGFjZU5hbWU6IHN0cmluZyxcbiAgdG9rZW46IHN0cmluZ1xuKSB7XG4gIGF3YWl0IHBvc3QoXG4gICAgYGh0dHBzOi8vJHt0ZmVIb3N0bmFtZX0vYXBpL3YyLy9vcmdhbml6YXRpb25zLyR7b3JnYW5pemF0aW9uTmFtZX0vd29ya3NwYWNlc2AsXG4gICAgdG9rZW4sXG4gICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgZGF0YToge1xuICAgICAgICBhdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgbmFtZTogd29ya3NwYWNlTmFtZSxcbiAgICAgICAgICBvcGVyYXRpb25zOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgICAgdHlwZTogXCJ3b3Jrc3BhY2VzXCIsXG4gICAgICB9LFxuICAgIH0pXG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRPcmdhbml6YXRpb25OYW1lcyh0ZmVIb3N0bmFtZTogc3RyaW5nLCB0b2tlbjogc3RyaW5nKSB7XG4gIHJldHVybiAoYXdhaXQgZ2V0KFxuICAgIGBodHRwczovLyR7dGZlSG9zdG5hbWV9L2FwaS92Mi8vb3JnYW5pemF0aW9uc2AsXG4gICAgdG9rZW5cbiAgKSkgYXMgT3JnYW5pemF0aW9uO1xufVxuIl19