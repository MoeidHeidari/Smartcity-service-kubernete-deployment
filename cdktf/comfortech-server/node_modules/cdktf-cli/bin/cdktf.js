"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
process.env.NODE_ENV = process.env.NODE_ENV || "production";
const yargs = __importStar(require("yargs"));
const path = __importStar(require("path"));
const os = __importStar(require("os"));
const fs = __importStar(require("fs-extra"));
const util_1 = require("../lib/util");
const errors_1 = require("../lib/errors");
const debug_1 = require("../lib/debug");
const environment_1 = require("../lib/environment");
const Sentry = __importStar(require("@sentry/node"));
const ensurePluginCache = () => {
    const pluginCachePath = process.env.TF_PLUGIN_CACHE_DIR ||
        path.join(os.homedir(), ".terraform.d", "plugin-cache");
    if (!fs.existsSync(pluginCachePath)) {
        fs.mkdirpSync(pluginCachePath);
    }
    return pluginCachePath;
};
if (!environment_1.CDKTF_DISABLE_PLUGIN_CACHE_ENV) {
    process.env.TF_PLUGIN_CACHE_DIR = ensurePluginCache();
}
const customCompletion = function (_current, argv, completionsFilter, done) {
    // The completion function gets called when bash completion is invoked and
    // we have very little context there. So when debugging via logs use e.g.
    // fs.appendFileSync("/Users/ansgar/cdktf-completions.log", `hello log\n`);
    // complete positional arg for stack for diff / deploy (and their aliases plan / apply)
    if (argv._.includes("diff") ||
        argv._.includes("deploy") ||
        argv._.includes("plan") ||
        argv._.includes("apply")) {
        completionsFilter(async (_err, defaults) => {
            const stacks = [];
            try {
                const manifest = await util_1.readCDKTFManifest();
                stacks.push(...Object.values(manifest.stacks).map((stack) => `${stack.name}:target stack "${stack.name}"`));
            }
            finally {
                done([...defaults, ...stacks]);
            }
        });
    }
    else {
        completionsFilter();
    }
    // return done([current]);
};
// ^ we need to fake the type here as yargs internally checks whether four
// arguments are present but does not expose the types correctly to typescript
// for the possible overload (which supports falling back to default completions)
// https://github.com/yargs/yargs/blob/d33e9972291406490cd8fdad0b3589be234e0f12/lib/completion.ts#L202
yargs
    .command(require("./cmds/init"))
    .command(require("./cmds/get"))
    .command(require("./cmds/convert"))
    .command(require("./cmds/deploy"))
    .command(require("./cmds/destroy"))
    .command(require("./cmds/diff"))
    .command(require("./cmds/list"))
    .command(require("./cmds/login"))
    .command(require("./cmds/synth"))
    .command(require("./cmds/watch"))
    .command(require("./cmds/output"))
    .command(require("./cmds/debug"))
    .command(require("./cmds/provider"))
    .recommendCommands()
    .exitProcess(false)
    .wrap(yargs.terminalWidth())
    .showHelpOnFail(false)
    .env("CDKTF")
    .epilogue(`Options can be specified via environment variables with the "CDKTF_" prefix (e.g. "CDKTF_OUTPUT")`)
    .help()
    .alias("h", "help")
    .option("disable-plugin-cache-env", {
    type: "boolean",
    default: false,
    required: false,
    desc: "Dont set TF_PLUGIN_CACHE_DIR automatically. This is useful when the plugin cache is configured differently. Supported using the env CDKTF_DISABLE_PLUGIN_CACHE_ENV.",
})
    .option("log-level", {
    type: "string",
    required: false,
    desc: "Which log level should be written. Only supported via setting the env CDKTF_LOG_LEVEL",
})
    .option("context-json", {
    required: false,
    hidden: true,
    desc: "Used internally for env variable",
})
    .completion("completion", customCompletion) // outputs completion script on "cdktf completion"
    .command({
    command: "*",
    handler: (argv) => {
        const cmd = argv._[0];
        if (cmd === "completion") {
            // Yargs seems to also run the catch all command in case the completion command is run
            return;
        }
        console.error(cmd
            ? `Could not find command "${cmd}", here are all available ones:`
            : `Please pass a command to cdktf, here are all available ones:`);
        yargs.showHelp();
        process.exit(1);
    },
})
    .fail(async (message, error) => {
    // will not stop the process, but stops further execution of the handler function
    // this is called first because yargs is not waiting for this async function
    yargs.exit(1, error);
    // set if e.g. the validation of command arguments failed
    if (message) {
        console.log(message);
    }
    // set if e.g. an handler threw an error while being invoked
    if (errors_1.IsErrorType(error, "Usage")) {
        console.error(error.message);
    }
    else if (error) {
        console.error(error.stack);
        console.error("Collecting Debug Information...");
        const debugOutput = await debug_1.collectDebugInformation();
        console.error("Debug Information:");
        Object.entries(debugOutput).forEach(([key, value]) => {
            console.log(`${key}: ${value === null ? "null" : value}`);
        });
    }
    await Sentry.close(4000);
    process.exit(1);
}).argv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrdGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjZGt0Zi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxZQUFZLENBQUM7QUFFNUQsNkNBQStCO0FBQy9CLDJDQUE2QjtBQUM3Qix1Q0FBeUI7QUFDekIsNkNBQStCO0FBQy9CLHNDQUFnRDtBQUNoRCwwQ0FBNEM7QUFDNUMsd0NBQXVEO0FBQ3ZELG9EQUFvRTtBQUNwRSxxREFBdUM7QUFFdkMsTUFBTSxpQkFBaUIsR0FBRyxHQUFXLEVBQUU7SUFDckMsTUFBTSxlQUFlLEdBQ25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFLGNBQWMsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUMxRCxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsRUFBRTtRQUNuQyxFQUFFLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0tBQ2hDO0lBQ0QsT0FBTyxlQUFlLENBQUM7QUFDekIsQ0FBQyxDQUFDO0FBRUYsSUFBSSxDQUFDLDRDQUE4QixFQUFFO0lBQ25DLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQztDQUN2RDtBQUVELE1BQU0sZ0JBQWdCLEdBQUcsVUFDdkIsUUFBZ0IsRUFDaEIsSUFBUyxFQUNULGlCQUVTLEVBQ1QsSUFBcUM7SUFFckMsMEVBQTBFO0lBQzFFLHlFQUF5RTtJQUN6RSwyRUFBMkU7SUFFM0UsdUZBQXVGO0lBQ3ZGLElBQ0UsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FB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QUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUU7WUFDbkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsS0FBSyxLQUFLLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDNUQsQ0FBQyxDQUFDLENBQUM7S0FDSjtJQUVELE1BQU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbInByb2Nlc3MuZW52Lk5PREVfRU5WID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgfHwgXCJwcm9kdWN0aW9uXCI7XG5cbmltcG9ydCAqIGFzIHlhcmdzIGZyb20gXCJ5YXJnc1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgb3MgZnJvbSBcIm9zXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCB7IHJlYWRDREtURk1hbmlmZXN0IH0gZnJvbSBcIi4uL2xpYi91dGlsXCI7XG5pbXBvcnQgeyBJc0Vycm9yVHlwZSB9IGZyb20gXCIuLi9saWIvZXJyb3JzXCI7XG5pbXBvcnQgeyBjb2xsZWN0RGVidWdJbmZvcm1hdGlvbiB9IGZyb20gXCIuLi9saWIvZGVidWdcIjtcbmltcG9ydCB7IENES1RGX0RJU0FCTEVfUExVR0lOX0NBQ0hFX0VOViB9IGZyb20gXCIuLi9saWIvZW52aXJvbm1lbnRcIjtcbmltcG9ydCAqIGFzIFNlbnRyeSBmcm9tIFwiQHNlbnRyeS9ub2RlXCI7XG5cbmNvbnN0IGVuc3VyZVBsdWdpbkNhY2hlID0gKCk6IHN0cmluZyA9PiB7XG4gIGNvbnN0IHBsdWdpbkNhY2hlUGF0aCA9XG4gICAgcHJvY2Vzcy5lbnYuVEZfUExVR0lOX0NBQ0hFX0RJUiB8fFxuICAgIHBhdGguam9pbihvcy5ob21lZGlyKCksIFwiLnRlcnJhZm9ybS5kXCIsIFwicGx1Z2luLWNhY2hlXCIpO1xuICBpZiAoIWZzLmV4aXN0c1N5bmMocGx1Z2luQ2FjaGVQYXRoKSkge1xuICAgIGZzLm1rZGlycFN5bmMocGx1Z2luQ2FjaGVQYXRoKTtcbiAgfVxuICByZXR1cm4gcGx1Z2luQ2FjaGVQYXRoO1xufTtcblxuaWYgKCFDREtURl9ESVNBQkxFX1BMVUdJTl9DQUNIRV9FTlYpIHtcbiAgcHJvY2Vzcy5lbnYuVEZfUExVR0lOX0NBQ0hFX0RJUiA9IGVuc3VyZVBsdWdpbkNhY2hlKCk7XG59XG5cbmNvbnN0IGN1c3RvbUNvbXBsZXRpb24gPSBmdW5jdGlvbiAoXG4gIF9jdXJyZW50OiBzdHJpbmcsXG4gIGFyZ3Y6IGFueSxcbiAgY29tcGxldGlvbnNGaWx0ZXI6IChcbiAgICBkb25lPzogKGVycjogYW55LCBkZWZhdWx0Q29tcGxldGlvbnM6IHN0cmluZ1tdKSA9PiB2b2lkXG4gICkgPT4gdm9pZCxcbiAgZG9uZTogKGNvbXBsZXRpb25zOiBzdHJpbmdbXSkgPT4gdm9pZFxuKSB7XG4gIC8vIFRoZSBjb21wbGV0aW9uIGZ1bmN0aW9uIGdldHMgY2FsbGVkIHdoZW4gYmFzaCBjb21wbGV0aW9uIGlzIGludm9rZWQgYW5kXG4gIC8vIHdlIGhhdmUgdmVyeSBsaXR0bGUgY29udGV4dCB0aGVyZS4gU28gd2hlbiBkZWJ1Z2dpbmcgdmlhIGxvZ3MgdXNlIGUuZy5cbiAgLy8gZnMuYXBwZW5kRmlsZVN5bmMoXCIvVXNlcnMvYW5zZ2FyL2Nka3RmLWNvbXBsZXRpb25zLmxvZ1wiLCBgaGVsbG8gbG9nXFxuYCk7XG5cbiAgLy8gY29tcGxldGUgcG9zaXRpb25hbCBhcmcgZm9yIHN0YWNrIGZvciBkaWZmIC8gZGVwbG95IChhbmQgdGhlaXIgYWxpYXNlcyBwbGFuIC8gYXBwbHkpXG4gIGlmIChcbiAgICBhcmd2Ll8uaW5jbHVkZXMoXCJkaWZmXCIpIHx8XG4gICAgYXJndi5fLmluY2x1ZGVzKFwiZGVwbG95XCIpIHx8XG4gICAgYXJndi5fLmluY2x1ZGVzKFwicGxhblwiKSB8fFxuICAgIGFyZ3YuXy5pbmNsdWRlcyhcImFwcGx5XCIpXG4gICkge1xuICAgIGNvbXBsZXRpb25zRmlsdGVyKGFzeW5jIChfZXJyLCBkZWZhdWx0cykgPT4ge1xuICAgICAgY29uc3Qgc3RhY2tzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbWFuaWZlc3QgPSBhd2FpdCByZWFkQ0RLVEZNYW5pZmVzdCgpO1xuICAgICAgICBzdGFja3MucHVzaChcbiAgICAgICAgICAuLi5PYmplY3QudmFsdWVzKG1hbmlmZXN0LnN0YWNrcykubWFwKFxuICAgICAgICAgICAgKHN0YWNrKSA9PiBgJHtzdGFjay5uYW1lfTp0YXJnZXQgc3RhY2sgXCIke3N0YWNrLm5hbWV9XCJgXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgZG9uZShbLi4uZGVmYXVsdHMsIC4uLnN0YWNrc10pO1xuICAgICAgfVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGNvbXBsZXRpb25zRmlsdGVyKCk7XG4gIH1cbiAgLy8gcmV0dXJuIGRvbmUoW2N1cnJlbnRdKTtcbn0gYXMgdW5rbm93biBhcyB5YXJncy5Bc3luY0NvbXBsZXRpb25GdW5jdGlvbjtcbi8vIF4gd2UgbmVlZCB0byBmYWtlIHRoZSB0eXBlIGhlcmUgYXMgeWFyZ3MgaW50ZXJuYWxseSBjaGVja3Mgd2hldGhlciBmb3VyXG4vLyBhcmd1bWVudHMgYXJlIHByZXNlbnQgYnV0IGRvZXMgbm90IGV4cG9zZSB0aGUgdHlwZXMgY29ycmVjdGx5IHRvIHR5cGVzY3JpcHRcbi8vIGZvciB0aGUgcG9zc2libGUgb3ZlcmxvYWQgKHdoaWNoIHN1cHBvcnRzIGZhbGxpbmcgYmFjayB0byBkZWZhdWx0IGNvbXBsZXRpb25zKVxuLy8gaHR0cHM6Ly9naXRodWIuY29tL3lhcmdzL3lhcmdzL2Jsb2IvZDMzZTk5NzIyOTE0MDY0OTBjZDhmZGFkMGIzNTg5YmUyMzRlMGYxMi9saWIvY29tcGxldGlvbi50cyNMMjAyXG5cbnlhcmdzXG4gIC5jb21tYW5kKHJlcXVpcmUoXCIuL2NtZHMvaW5pdFwiKSlcbiAgLmNvbW1hbmQocmVxdWlyZShcIi4vY21kcy9nZXRcIikpXG4gIC5jb21tYW5kKHJlcXVpcmUoXCIuL2NtZHMvY29udmVydFwiKSlcbiAgLmNvbW1hbmQocmVxdWlyZShcIi4vY21kcy9kZXBsb3lcIikpXG4gIC5jb21tYW5kKHJlcXVpcmUoXCIuL2NtZHMvZGVzdHJveVwiKSlcbiAgLmNvbW1hbmQocmVxdWlyZShcIi4vY21kcy9kaWZmXCIpKVxuICAuY29tbWFuZChyZXF1aXJlKFwiLi9jbWRzL2xpc3RcIikpXG4gIC5jb21tYW5kKHJlcXVpcmUoXCIuL2NtZHMvbG9naW5cIikpXG4gIC5jb21tYW5kKHJlcXVpcmUoXCIuL2NtZHMvc3ludGhcIikpXG4gIC5jb21tYW5kKHJlcXVpcmUoXCIuL2NtZHMvd2F0Y2hcIikpXG4gIC5jb21tYW5kKHJlcXVpcmUoXCIuL2NtZHMvb3V0cHV0XCIpKVxuICAuY29tbWFuZChyZXF1aXJlKFwiLi9jbWRzL2RlYnVnXCIpKVxuICAuY29tbWFuZChyZXF1aXJlKFwiLi9jbWRzL3Byb3ZpZGVyXCIpKVxuICAucmVjb21tZW5kQ29tbWFuZHMoKVxuICAuZXhpdFByb2Nlc3MoZmFsc2UpXG4gIC53cmFwKHlhcmdzLnRlcm1pbmFsV2lkdGgoKSlcbiAgLnNob3dIZWxwT25GYWlsKGZhbHNlKVxuICAuZW52KFwiQ0RLVEZcIilcbiAgLmVwaWxvZ3VlKFxuICAgIGBPcHRpb25zIGNhbiBiZSBzcGVjaWZpZWQgdmlhIGVudmlyb25tZW50IHZhcmlhYmxlcyB3aXRoIHRoZSBcIkNES1RGX1wiIHByZWZpeCAoZS5nLiBcIkNES1RGX09VVFBVVFwiKWBcbiAgKVxuICAuaGVscCgpXG4gIC5hbGlhcyhcImhcIiwgXCJoZWxwXCIpXG4gIC5vcHRpb24oXCJkaXNhYmxlLXBsdWdpbi1jYWNoZS1lbnZcIiwge1xuICAgIHR5cGU6IFwiYm9vbGVhblwiLFxuICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgIHJlcXVpcmVkOiBmYWxzZSxcbiAgICBkZXNjOiBcIkRvbnQgc2V0IFRGX1BMVUdJTl9DQUNIRV9ESVIgYXV0b21hdGljYWxseS4gVGhpcyBpcyB1c2VmdWwgd2hlbiB0aGUgcGx1Z2luIGNhY2hlIGlzIGNvbmZpZ3VyZWQgZGlmZmVyZW50bHkuIFN1cHBvcnRlZCB1c2luZyB0aGUgZW52IENES1RGX0RJU0FCTEVfUExVR0lOX0NBQ0hFX0VOVi5cIixcbiAgfSlcbiAgLm9wdGlvbihcImxvZy1sZXZlbFwiLCB7XG4gICAgdHlwZTogXCJzdHJpbmdcIixcbiAgICByZXF1aXJlZDogZmFsc2UsXG4gICAgZGVzYzogXCJXaGljaCBsb2cgbGV2ZWwgc2hvdWxkIGJlIHdyaXR0ZW4uIE9ubHkgc3VwcG9ydGVkIHZpYSBzZXR0aW5nIHRoZSBlbnYgQ0RLVEZfTE9HX0xFVkVMXCIsXG4gIH0pXG4gIC5vcHRpb24oXCJjb250ZXh0LWpzb25cIiwge1xuICAgIHJlcXVpcmVkOiBmYWxzZSxcbiAgICBoaWRkZW46IHRydWUsXG4gICAgZGVzYzogXCJVc2VkIGludGVybmFsbHkgZm9yIGVudiB2YXJpYWJsZVwiLFxuICB9KVxuICAuY29tcGxldGlvbihcImNvbXBsZXRpb25cIiwgY3VzdG9tQ29tcGxldGlvbikgLy8gb3V0cHV0cyBjb21wbGV0aW9uIHNjcmlwdCBvbiBcImNka3RmIGNvbXBsZXRpb25cIlxuICAuY29tbWFuZCh7XG4gICAgY29tbWFuZDogXCIqXCIsIC8vIGNhdGNoZXMgZXZlcnl0aGluZyBub3QgcHJldmlvdXNseSBtYXRjaGVkXG4gICAgaGFuZGxlcjogKGFyZ3YpID0+IHtcbiAgICAgIGNvbnN0IGNtZCA9IGFyZ3YuX1swXTtcblxuICAgICAgaWYgKGNtZCA9PT0gXCJjb21wbGV0aW9uXCIpIHtcbiAgICAgICAgLy8gWWFyZ3Mgc2VlbXMgdG8gYWxzbyBydW4gdGhlIGNhdGNoIGFsbCBjb21tYW5kIGluIGNhc2UgdGhlIGNvbXBsZXRpb24gY29tbWFuZCBpcyBydW5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgY21kXG4gICAgICAgICAgPyBgQ291bGQgbm90IGZpbmQgY29tbWFuZCBcIiR7Y21kfVwiLCBoZXJlIGFyZSBhbGwgYXZhaWxhYmxlIG9uZXM6YFxuICAgICAgICAgIDogYFBsZWFzZSBwYXNzIGEgY29tbWFuZCB0byBjZGt0ZiwgaGVyZSBhcmUgYWxsIGF2YWlsYWJsZSBvbmVzOmBcbiAgICAgICk7XG4gICAgICB5YXJncy5zaG93SGVscCgpO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH0sXG4gIH0pXG4gIC5mYWlsKGFzeW5jIChtZXNzYWdlLCBlcnJvcikgPT4ge1xuICAgIC8vIHdpbGwgbm90IHN0b3AgdGhlIHByb2Nlc3MsIGJ1dCBzdG9wcyBmdXJ0aGVyIGV4ZWN1dGlvbiBvZiB0aGUgaGFuZGxlciBmdW5jdGlvblxuICAgIC8vIHRoaXMgaXMgY2FsbGVkIGZpcnN0IGJlY2F1c2UgeWFyZ3MgaXMgbm90IHdhaXRpbmcgZm9yIHRoaXMgYXN5bmMgZnVuY3Rpb25cbiAgICB5YXJncy5leGl0KDEsIGVycm9yKTtcblxuICAgIC8vIHNldCBpZiBlLmcuIHRoZSB2YWxpZGF0aW9uIG9mIGNvbW1hbmQgYXJndW1lbnRzIGZhaWxlZFxuICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICBjb25zb2xlLmxvZyhtZXNzYWdlKTtcbiAgICB9XG5cbiAgICAvLyBzZXQgaWYgZS5nLiBhbiBoYW5kbGVyIHRocmV3IGFuIGVycm9yIHdoaWxlIGJlaW5nIGludm9rZWRcbiAgICBpZiAoSXNFcnJvclR5cGUoZXJyb3IsIFwiVXNhZ2VcIikpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IubWVzc2FnZSk7XG4gICAgfSBlbHNlIGlmIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihlcnJvci5zdGFjayk7XG4gICAgICBjb25zb2xlLmVycm9yKFwiQ29sbGVjdGluZyBEZWJ1ZyBJbmZvcm1hdGlvbi4uLlwiKTtcbiAgICAgIGNvbnN0IGRlYnVnT3V0cHV0ID0gYXdhaXQgY29sbGVjdERlYnVnSW5mb3JtYXRpb24oKTtcblxuICAgICAgY29uc29sZS5lcnJvcihcIkRlYnVnIEluZm9ybWF0aW9uOlwiKTtcbiAgICAgIE9iamVjdC5lbnRyaWVzKGRlYnVnT3V0cHV0KS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coYCR7a2V5fTogJHt2YWx1ZSA9PT0gbnVsbCA/IFwibnVsbFwiIDogdmFsdWV9YCk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBhd2FpdCBTZW50cnkuY2xvc2UoNDAwMCk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9KS5hcmd2O1xuIl19