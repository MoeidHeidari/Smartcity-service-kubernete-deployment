"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TerraformCloud = exports.TerraformCloudPlan = void 0;
/* eslint-disable @typescript-eslint/no-unused-vars */
const path = __importStar(require("path"));
const os = __importStar(require("os"));
const fs = __importStar(require("fs"));
const terraform_1 = require("./terraform");
const TerraformCloudClient = __importStar(require("@skorfmann/terraform-cloud"));
const archiver_1 = __importDefault(require("archiver"));
const stream_buffers_1 = require("stream-buffers");
const logging_1 = require("../logging");
const errors_1 = require("../errors");
const agent = __importStar(require("tunnel-agent"));
const url_1 = require("url");
class TerraformCloudPlan extends terraform_1.AbstractTerraformPlan {
    constructor(planFile, plan, url) {
        super(planFile, plan.resourceChanges, plan.outputChanges);
        this.planFile = planFile;
        this.plan = plan;
        this.url = url;
    }
}
exports.TerraformCloudPlan = TerraformCloudPlan;
const zipDirectory = (source) => {
    const archive = archiver_1.default("tar", { gzip: true });
    const stream = new stream_buffers_1.WritableStreamBuffer();
    return new Promise((resolve, reject) => {
        archive
            .directory(source, false)
            .on("error", (err) => reject(err))
            .on("end", () => resolve(stream.getContents()))
            .pipe(stream);
        archive.finalize();
    });
};
const wait = (ms = 1000) => {
    return new Promise((resolve) => {
        setTimeout(resolve, ms);
    });
};
function BeautifyErrors(name) {
    return (target, propertyKey, descriptor) => {
        const isMethod = descriptor && descriptor.value instanceof Function;
        if (!isMethod)
            return;
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        const originalMethod = descriptor.value;
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        descriptor.value = async function (...args) {
            var _a;
            try {
                return await originalMethod.apply(this, args);
            }
            catch (e) {
                if (e.response &&
                    e.response.status >= 400 &&
                    e.response.status <= 599) {
                    const errors = (_a = e.response.data) === null || _a === void 0 ? void 0 : _a.errors;
                    logging_1.logger.error(`Error in ${name}: ${JSON.stringify(e)}`);
                    if (errors) {
                        throw new Error(`${name}: Request to Terraform Cloud failed with status ${e.response.status}: ${errors.map((e) => JSON.stringify(e)).join(", ")}`);
                    }
                }
                else {
                    logging_1.logger.warn(`Error in ${name}: ${JSON.stringify(e)}`);
                }
                throw e;
            }
        };
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        Object.defineProperty(target, propertyKey, descriptor);
    };
}
class TerraformCloud {
    constructor(abortSignal, stack, config, isSpeculative = false, createTerraformLogHandler = (_phase) => (_stdout, _isErr = false) => { } // eslint-disable-line @typescript-eslint/no-empty-function
    ) {
        this.abortSignal = abortSignal;
        this.stack = stack;
        this.config = config;
        this.createTerraformLogHandler = createTerraformLogHandler;
        this.terraformConfigFilePath = path.join(os.homedir(), ".terraform.d", "credentials.tfrc.json");
        this.lastLogMessageLength = 0;
        if (!config.workspaces.name)
            throw new Error("Please provide a workspace name for Terraform Cloud");
        if (!config.organization)
            throw new Error("Please provide an organization for Terraform Cloud");
        this.workDir = stack.workingDirectory;
        this.hostname = config.hostname || "app.terraform.io";
        this.workspaceName = config.workspaces.name;
        this.organizationName = config.organization;
        this.isSpeculative = isSpeculative;
        if (config.token) {
            this.token = config.token;
        }
        else if (process.env.TERRAFORM_CLOUD_TOKEN) {
            this.token = process.env.TERRAFORM_CLOUD_TOKEN;
        }
        else {
            if (!fs.existsSync(this.terraformConfigFilePath))
                throw new Error("Please provide a token for Terraform Cloud");
            const configFile = JSON.parse(fs.readFileSync(this.terraformConfigFilePath, "utf8"));
            this.token = configFile.credentials[this.hostname].token;
        }
        this.client = new TerraformCloudClient.TerraformCloud(this.token, this.hostname);
        this.abortSignal.addEventListener("abort", () => {
            this.removeRun("cancel");
        });
        const httpProxy = process.env.http_proxy || process.env.HTTP_PROXY;
        if (httpProxy && httpProxy !== "undefined") {
            // ¯\_(ツ)_/¯
            const url = new url_1.URL(httpProxy);
            logging_1.logger.debug(`setting tunnel agent via hostname=${url.hostname} port=${url.port}`);
            this.client.client.defaults.httpsAgent = agent.httpsOverHttp({
                proxy: { host: url.hostname, port: url.port },
            });
        }
    }
    async isRemoteWorkspace() {
        const workspace = await this.workspace();
        return workspace.attributes.executionMode !== "local";
    }
    async init() {
        const sendLog = this.createTerraformLogHandler("init");
        if (fs.existsSync(path.join(process.cwd(), `terraform.${this.stack.name}.tfstate`)))
            throw new Error(`Found a "terraform.${this.stack.name}.tfstate" file in your current working directory. Please migrate the state manually to Terraform Cloud and delete the file afterwards. https://cdk.tf/migrate-state`);
        const workspace = await this.workspace();
        sendLog("Creating Terraform Cloud configuration version");
        const version = await this.client.ConfigurationVersion.create(workspace.id, {
            data: {
                type: "configuration-version",
                attributes: {
                    autoQueueRuns: false,
                    speculative: this.isSpeculative,
                },
            },
        });
        this.configurationVersionId = version.id;
        sendLog(`Created Terraform Cloud configuration version ${this.configurationVersionId}`);
        this.removeLocalTerraformDirectory();
        sendLog(`Zipping up the directory ${this.workDir}`);
        const zipBuffer = await zipDirectory(this.workDir);
        if (!zipBuffer)
            throw new Error("Couldn't upload directory to Terraform Cloud");
        sendLog(`Uploading the directory to Terraform Cloud`);
        await this.client.ConfigurationVersion.upload(version.attributes.uploadUrl, zipBuffer);
        sendLog(`Uploaded the directory to Terraform Cloud`);
        sendLog(`Waiting for configuration version to become ready...`);
        // we might get an HTTP 422 error if we don't wait for the processing and try to run too early. see #647
        await this.waitForConfigurationVersionToBeReady();
    }
    async plan(destroy = false, refreshOnly = false) {
        var _a, _b, _c, _d, _e, _f, _g;
        if (!this.configurationVersionId)
            throw new Error("Please create a ConfigurationVersion before planning");
        const sendLog = this.createTerraformLogHandler("plan");
        const workspace = await this.workspace();
        const workspaceUrl = `https://${this.hostname}/app/${this.organizationName}/workspaces/${this.workspaceName}`;
        if (workspace.attributes.locked &&
            ((_c = (_b = (_a = workspace.relationships) === null || _a === void 0 ? void 0 : _a.lockedBy) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.type) === "users") {
            throw new Error(`Can not plan, the workspace ${this.organizationName}/${this.workspaceName} is locked by a user. You can find more information at ${workspaceUrl}`);
        }
        if (workspace.attributes.locked &&
            ((_f = (_e = (_d = workspace.relationships) === null || _d === void 0 ? void 0 : _d.lockedBy) === null || _e === void 0 ? void 0 : _e.data) === null || _f === void 0 ? void 0 : _f.type) === "runs") {
            throw new Error(`Can not plan, the workspace ${this.organizationName}/${this.workspaceName} is locked by a previous run, please wait until it's done. You can find more information at ${workspaceUrl}`);
        }
        if (workspace.attributes.locked) {
            throw new Error(`Can not plan, the workspace ${this.organizationName}/${this.workspaceName} is locked for an unknown reason: ${JSON.stringify((_g = workspace.relationships) === null || _g === void 0 ? void 0 : _g.lockedBy)}. You can find more information at ${workspaceUrl}`);
        }
        sendLog(`Creating speculative Terraform Cloud run`);
        let result = await this.client.Runs.create({
            data: {
                attributes: {
                    isDestroy: destroy,
                    refreshOnly,
                    message: "cdktf",
                },
                relationships: {
                    configurationVersion: {
                        data: {
                            id: this.configurationVersionId,
                            type: "configuration-versions",
                        },
                    },
                    workspace: {
                        data: {
                            id: workspace.id,
                            type: "workspaces",
                        },
                    },
                },
            },
        });
        const url = `https://${this.hostname}/app/${this.organizationName}/workspaces/${this.workspaceName}/runs/${result.id}`;
        sendLog(`Created speculative Terraform Cloud run: ${url}`);
        const pendingStates = ["pending", "plan_queued", "planning"];
        while (pendingStates.includes(result.attributes.status)) {
            result = await this.update(this.client, result.id, "plan");
            await wait(1000);
        }
        sendLog(`Speculative Terraform Cloud run done`);
        if (result.attributes.status === "errored") {
            throw new Error(`Error planning the run, please take a look at ${url}`);
        }
        sendLog(`Getting plan output`);
        const plan = await this.client.Plans.jsonOutput(result.relationships.plan.data.id);
        this.run = result;
        return new TerraformCloudPlan("terraform-cloud", plan, url);
    }
    async update(client, runId, phase) {
        const sendLog = this.createTerraformLogHandler(phase);
        const res = await client.Runs.show(runId);
        // fetch logs and update UI in the background
        client.Applies.logs(res.relationships.apply.data.id).then(({ data }) => {
            // In rare cases the backend sends an empty chunk of data back.
            if (data && data.length) {
                const buffer = Buffer.from(data, "utf8");
                // We only want to send what we have not seen yet.
                const bufferWithoutLastKnown = buffer
                    .subarray(this.lastLogMessageLength)
                    .toString("utf8");
                if (bufferWithoutLastKnown.trim().length) {
                    sendLog(bufferWithoutLastKnown, false);
                    this.lastLogMessageLength = buffer.length;
                }
            }
        });
        return res;
    }
    async deploy(_planFile, _refreshOnly) {
        const sendLog = this.createTerraformLogHandler("deploy");
        if (!this.run)
            throw new Error("Please create a ConfigurationVersion / Plan before deploying");
        const deployingStates = ["confirmed", "apply_queued", "applying"];
        const runId = this.run.id;
        sendLog(`Deploying Terraform Cloud run`);
        await this.client.Runs.action("apply", runId);
        let result = await this.client.Runs.show(runId);
        while (deployingStates.includes(result.attributes.status)) {
            result = await this.update(this.client, runId, "deploy");
            await wait(1000);
        }
        switch (result.attributes.status) {
            case "applied":
                break;
            default:
                throw new Error(`error: ${result.attributes.status}`);
        }
    }
    async destroy() {
        if (!this.run)
            throw new Error("Please create a ConfigurationVersion / Plan before destroying");
        const sendLog = this.createTerraformLogHandler("destroy");
        const destroyingStates = ["confirmed", "apply_queued", "applying"];
        const runId = this.run.id;
        sendLog(`Applying Terraform Cloud run`);
        await this.client.Runs.action("apply", runId);
        let result = await this.client.Runs.show(runId);
        while (destroyingStates.includes(result.attributes.status)) {
            result = await this.update(this.client, runId, "destroy");
            await wait(1000);
        }
        switch (result.attributes.status) {
            case "applied":
                break;
            default:
                throw new Error(`error: ${result.attributes.status}`);
        }
    }
    async version() {
        return (await this.workspace()).attributes.terraformVersion;
    }
    async abort() {
        if (!this.run) {
            throw errors_1.Errors.Internal("No run is present to abort, this means we called abort before the plan was started");
        }
        await this.removeRun("discard");
    }
    async output() {
        const sendLog = this.createTerraformLogHandler("output");
        sendLog("Fetching Terraform Cloud outputs");
        const stateVersion = await this.client.StateVersions.current((await this.workspace()).id, true);
        if (!stateVersion.included)
            return {};
        const outputs = stateVersion.included.reduce((acc, output) => {
            acc[output.attributes.name] = {
                sensitive: output.attributes.sensitive,
                type: output.attributes.type,
                value: output.attributes.value,
            };
            return acc;
        }, {});
        return outputs;
    }
    async workspace() {
        var _a;
        try {
            return await this.client.Workspaces.showByName(this.organizationName, this.workspaceName);
        }
        catch (e) {
            if (((_a = e.response) === null || _a === void 0 ? void 0 : _a.status) === 404) {
                // return a more descriptive error message as http response is not descriptive enough
                // will not be touched by BeautifyErrors decorator
                throw new Error(`TerraformCloud returned an HTTP 404 error. Please make sure the configured organization (${this.organizationName}) and workspace (${this.workspaceName}) exist and you have the correct access rights.`);
            }
            throw e;
        }
    }
    async isConfigurationVersionReady() {
        if (!this.configurationVersionId)
            throw new Error("No ConfigurationVersionId known. Cannot wait for ConfigurationVersion to become ready");
        const configVersion = await this.client.ConfigurationVersion.show(this.configurationVersionId);
        const { status } = configVersion.attributes;
        switch (status) {
            case "uploaded":
                return true;
            case "errored": {
                const { error, errorMessage } = configVersion.attributes;
                logging_1.logger.error(`ConfigurationVersion in Terraform Cloud has status "${status}". Returned config version was ${JSON.stringify(configVersion)}`);
                throw new Error(`Terraform Cloud ConfigurationVersion ${this.configurationVersionId} has status "errored" ${JSON.stringify({ error, errorMessage })}`);
            }
            case "pending": // fallthrough
            default:
                logging_1.logger.debug(`ConfigurationVersion in Terraform Cloud not considered ready with status "${status}".`);
                return false;
        }
    }
    async removeRun(action) {
        if (!this.run) {
            logging_1.logger.debug("No run to remove");
            return;
        }
        const url = `https://${this.hostname}/app/${this.organizationName}/workspaces/${this.workspaceName}/runs/${this.run.id}`;
        logging_1.logger.info(`${action}ing run ${url}`);
        this.client.Runs.action(action, this.run.id)
            .then(() => {
            logging_1.logger.debug(`Cancelled run ${url}`);
        })
            .catch(() => {
            logging_1.logger.error(`Failed to cancel run, please cancel manually at ${url}`);
        });
    }
    async waitForConfigurationVersionToBeReady(timeoutMs = 60000) {
        logging_1.logger.debug("waiting for Configuration Version to be ready in Terraform Cloud");
        let timeoutReached = false;
        const ready = async () => {
            while (!((await this.isConfigurationVersionReady()) && !timeoutReached)) {
                await wait(1000);
            }
        };
        const timeout = async () => {
            await wait(timeoutMs);
            timeoutReached = true;
            throw new Error(`Waiting for Terraform Cloud ConfigurationVersion to become ready timed out (timeout was ${timeoutMs}ms)`);
        };
        await Promise.race([ready(), timeout()]);
        logging_1.logger.debug("Configuration Version is ready in Terraform Cloud");
    }
    removeLocalTerraformDirectory() {
        try {
            fs.rmSync(path.resolve(this.stack.workingDirectory, ".terraform"), {
                recursive: true,
            });
        }
        catch (error) {
            logging_1.logger.debug(`Could not remove .terraform folder`, error);
        }
    }
}
__decorate([
    BeautifyErrors("IsRemoteWorkspace")
], TerraformCloud.prototype, "isRemoteWorkspace", null);
__decorate([
    BeautifyErrors("Init")
], TerraformCloud.prototype, "init", null);
__decorate([
    BeautifyErrors("Plan")
], TerraformCloud.prototype, "plan", null);
__decorate([
    BeautifyErrors("Deploy")
], TerraformCloud.prototype, "deploy", null);
__decorate([
    BeautifyErrors("Destroy")
], TerraformCloud.prototype, "destroy", null);
__decorate([
    BeautifyErrors("Version")
], TerraformCloud.prototype, "version", null);
__decorate([
    BeautifyErrors("Abort")
], TerraformCloud.prototype, "abort", null);
__decorate([
    BeautifyErrors("Output")
], TerraformCloud.prototype, "output", null);
__decorate([
    BeautifyErrors("Workspace")
], TerraformCloud.prototype, "workspace", null);
exports.TerraformCloud = TerraformCloud;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFmb3JtLWNsb3VkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVycmFmb3JtLWNsb3VkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxzREFBc0Q7QUFDdEQsMkNBQTZCO0FBQzdCLHVDQUF5QjtBQUN6Qix1Q0FBeUI7QUFDekIsMkNBS3FCO0FBRXJCLGlGQUFtRTtBQUNuRSx3REFBZ0M7QUFDaEMsbURBQXNEO0FBRXRELHdDQUFvQztBQUNwQyxzQ0FBbUM7QUFDbkMsb0RBQXNDO0FBQ3RDLDZCQUEwQjtBQUUxQixNQUFhLGtCQUNYLFNBQVEsaUNBQXFCO0lBRzdCLFlBQ2tCLFFBQWdCLEVBQ2hCLElBQTRCLEVBQzVCLEdBQVc7UUFFM0IsS0FBSyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUoxQyxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLFNBQUksR0FBSixJQUFJLENBQXdCO1FBQzVCLFFBQUcsR0FBSCxHQUFHLENBQVE7SUFHN0IsQ0FBQztDQUNGO0FBWEQsZ0RBV0M7QUFhRCxNQUFNLFlBQVksR0FBRyxDQUFDLE1BQWMsRUFBMkIsRUFBRTtJQUMvRCxNQUFNLE9BQU8sR0FBRyxrQkFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ2hELE1BQU0sTUFBTSxHQUFHLElBQUkscUNBQW9CLEVBQUUsQ0FBQztJQUUxQyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ3JDLE9BQU87YUFDSixTQUFTLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQzthQUN4QixFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDakMsRUFBRSxDQUFD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STtZQUNGLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLFlBQVksQ0FBQyxFQUFFO2dCQUNqRSxTQUFTLEVBQUUsSUFBSTthQUNoQixDQUFDLENBQUM7U0FDSjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDM0Q7SUFDSCxDQUFDO0NBQ0Y7QUF2WEM7SUFEQyxjQUFjLENBQUMsbUJBQW1CLENBQUM7dURBSW5DO0FBR0Q7SUFEQyxjQUFjLENBQUMsTUFBTSxDQUFDOzBDQWlEdEI7QUFHRDtJQURDLGNBQWMsQ0FBQyxNQUFNLENBQUM7MENBeUZ0QjtBQThCRDtJQURDLGNBQWMsQ0FBQyxRQUFRLENBQUM7NENBNEJ4QjtBQUdEO0lBREMsY0FBYyxDQUFDLFNBQVMsQ0FBQzs2Q0EwQnpCO0FBR0Q7SUFEQyxjQUFjLENBQUMsU0FBUyxDQUFDOzZDQUd6QjtBQUdEO0lBREMsY0FBYyxDQUFDLE9BQU8sQ0FBQzsyQ0FTdkI7QUFHRDtJQURDLGNBQWMsQ0FBQyxRQUFRLENBQUM7NENBdUJ4QjtBQUdEO0lBREMsY0FBYyxDQUFDLFdBQVcsQ0FBQzsrQ0FpQjNCO0FBeldILHdDQThiQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnVzZWQtdmFycyAqL1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgb3MgZnJvbSBcIm9zXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCB7XG4gIFRlcnJhZm9ybSxcbiAgVGVycmFmb3JtUGxhbixcbiAgVGVycmFmb3JtT3V0cHV0LFxuICBBYnN0cmFjdFRlcnJhZm9ybVBsYW4sXG59IGZyb20gXCIuL3RlcnJhZm9ybVwiO1xuaW1wb3J0IHsgVGVycmFmb3JtSnNvbkNvbmZpZ0JhY2tlbmRSZW1vdGUgfSBmcm9tIFwiLi4vdGVycmFmb3JtLWpzb25cIjtcbmltcG9ydCAqIGFzIFRlcnJhZm9ybUNsb3VkQ2xpZW50IGZyb20gXCJAc2tvcmZtYW5uL3RlcnJhZm9ybS1jbG91ZFwiO1xuaW1wb3J0IGFyY2hpdmVyIGZyb20gXCJhcmNoaXZlclwiO1xuaW1wb3J0IHsgV3JpdGFibGVTdHJlYW1CdWZmZXIgfSBmcm9tIFwic3RyZWFtLWJ1ZmZlcnNcIjtcbmltcG9ydCB7IFN5bnRoZXNpemVkU3RhY2sgfSBmcm9tIFwiLi4vc3ludGgtc3RhY2tcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCIuLi9sb2dnaW5nXCI7XG5pbXBvcnQgeyBFcnJvcnMgfSBmcm9tIFwiLi4vZXJyb3JzXCI7XG5pbXBvcnQgKiBhcyBhZ2VudCBmcm9tIFwidHVubmVsLWFnZW50XCI7XG5pbXBvcnQgeyBVUkwgfSBmcm9tIFwidXJsXCI7XG5cbmV4cG9ydCBjbGFzcyBUZXJyYWZvcm1DbG91ZFBsYW5cbiAgZXh0ZW5kcyBBYnN0cmFjdFRlcnJhZm9ybVBsYW5cbiAgaW1wbGVtZW50cyBUZXJyYWZvcm1QbGFuXG57XG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBwbGFuRmlsZTogc3RyaW5nLFxuICAgIHB1YmxpYyByZWFkb25seSBwbGFuOiB7IFtrZXk6IHN0cmluZ106IGFueSB9LFxuICAgIHB1YmxpYyByZWFkb25seSB1cmw6IHN0cmluZ1xuICApIHtcbiAgICBzdXBlcihwbGFuRmlsZSwgcGxhbi5yZXNvdXJjZUNoYW5nZXMsIHBsYW4ub3V0cHV0Q2hhbmdlcyk7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBUZXJyYWZvcm1DcmVkZW50aWFsc0l0ZW0ge1xuICB0b2tlbjogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRlcnJhZm9ybUNyZWRlbnRpYWxzIHtcbiAgW2hvc3RuYW1lOiBzdHJpbmddOiBUZXJyYWZvcm1DcmVkZW50aWFsc0l0ZW07XG59XG5leHBvcnQgaW50ZXJmYWNlIFRlcnJhZm9ybUNyZWRlbnRpYWxzRmlsZSB7XG4gIGNyZWRlbnRpYWxzOiBUZXJyYWZvcm1DcmVkZW50aWFscztcbn1cblxuY29uc3QgemlwRGlyZWN0b3J5ID0gKHNvdXJjZTogc3RyaW5nKTogUHJvbWlzZTxCdWZmZXIgfCBmYWxzZT4gPT4ge1xuICBjb25zdCBhcmNoaXZlID0gYXJjaGl2ZXIoXCJ0YXJcIiwgeyBnemlwOiB0cnVlIH0pO1xuICBjb25zdCBzdHJlYW0gPSBuZXcgV3JpdGFibGVTdHJlYW1CdWZmZXIoKTtcblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGFyY2hpdmVcbiAgICAgIC5kaXJlY3Rvcnkoc291cmNlLCBmYWxzZSlcbiAgICAgIC5vbihcImVycm9yXCIsIChlcnIpID0+IHJlamVjdChlcnIpKVxuICAgICAgLm9uKFwiZW5kXCIsICgpID0+IHJlc29sdmUoc3RyZWFtLmdldENvbnRlbnRzKCkpKVxuICAgICAgLnBpcGUoc3RyZWFtKTtcbiAgICBhcmNoaXZlLmZpbmFsaXplKCk7XG4gIH0pO1xufTtcblxuY29uc3Qgd2FpdCA9IChtcyA9IDEwMDApID0+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgc2V0VGltZW91dChyZXNvbHZlLCBtcyk7XG4gIH0pO1xufTtcblxuZnVuY3Rpb24gQmVhdXRpZnlFcnJvcnMobmFtZTogc3RyaW5nKSB7XG4gIHJldHVybiAodGFyZ2V0OiBhbnksIHByb3BlcnR5S2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcikgPT4ge1xuICAgIGNvbnN0IGlzTWV0aG9kID0gZGVzY3JpcHRvciAmJiBkZXNjcmlwdG9yLnZhbHVlIGluc3RhbmNlb2YgRnVuY3Rpb247XG4gICAgaWYgKCFpc01ldGhvZCkgcmV0dXJuO1xuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICBjb25zdCBvcmlnaW5hbE1ldGhvZCA9IGRlc2NyaXB0b3IhLnZhbHVlO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgZGVzY3JpcHRvciEudmFsdWUgPSBhc3luYyBmdW5jdGlvbiAoLi4uYXJnczogYW55W10pIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBvcmlnaW5hbE1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGUucmVzcG9uc2UgJiZcbiAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA+PSA0MDAgJiZcbiAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA8PSA1OTlcbiAgICAgICAgKSB7XG4gICAgICAgICAgY29uc3QgZXJyb3JzID0gZS5yZXNwb25zZS5kYXRhPy5lcnJvcnMgYXNcbiAgICAgICAgICAgIHwgUmVjb3JkPHN0cmluZywgdW5rbm93bj5bXVxuICAgICAgICAgICAgfCB1bmRlZmluZWQ7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKGBFcnJvciBpbiAke25hbWV9OiAke0pTT04uc3RyaW5naWZ5KGUpfWApO1xuICAgICAgICAgIGlmIChlcnJvcnMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgYCR7bmFtZX06IFJlcXVlc3QgdG8gVGVycmFmb3JtIENsb3VkIGZhaWxlZCB3aXRoIHN0YXR1cyAke1xuICAgICAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzXG4gICAgICAgICAgICAgIH06ICR7ZXJyb3JzLm1hcCgoZSkgPT4gSlNPTi5zdHJpbmdpZnkoZSkpLmpvaW4oXCIsIFwiKX1gXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2dnZXIud2FybihgRXJyb3IgaW4gJHtuYW1lfTogJHtKU09OLnN0cmluZ2lmeShlKX1gKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIHByb3BlcnR5S2V5LCBkZXNjcmlwdG9yISk7XG4gIH07XG59XG5leHBvcnQgY2xhc3MgVGVycmFmb3JtQ2xvdWQgaW1wbGVtZW50cyBUZXJyYWZvcm0ge1xuICBwcml2YXRlIHJlYWRvbmx5IHRlcnJhZm9ybUNvbmZpZ0ZpbGVQYXRoID0gcGF0aC5qb2luKFxuICAgIG9zLmhvbWVkaXIoKSxcbiAgICBcIi50ZXJyYWZvcm0uZFwiLFxuICAgIFwiY3JlZGVudGlhbHMudGZyYy5qc29uXCJcbiAgKTtcbiAgcHJpdmF0ZSByZWFkb25seSB0b2tlbjogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IGhvc3RuYW1lOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgd29ya3NwYWNlTmFtZTogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IG9yZ2FuaXphdGlvbk5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBjbGllbnQ6IFRlcnJhZm9ybUNsb3VkQ2xpZW50LlRlcnJhZm9ybUNsb3VkO1xuICBwcml2YXRlIHJlYWRvbmx5IGlzU3BlY3VsYXRpdmU6IGJvb2xlYW47XG4gIHByaXZhdGUgY29uZmlndXJhdGlvblZlcnNpb25JZD86IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHdvcmtEaXI6IHN0cmluZztcbiAgcHVibGljIHJ1bj86IFRlcnJhZm9ybUNsb3VkQ2xpZW50LlJ1bjtcbiAgcHJpdmF0ZSBsYXN0TG9nTWVzc2FnZUxlbmd0aCA9IDA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHJlYWRvbmx5IGFib3J0U2lnbmFsOiBBYm9ydFNpZ25hbCxcbiAgICBwdWJsaWMgcmVhZG9ubHkgc3RhY2s6IFN5bnRoZXNpemVkU3RhY2ssXG4gICAgcHVibGljIHJlYWRvbmx5IGNvbmZpZzogVGVycmFmb3JtSnNvbkNvbmZpZ0JhY2tlbmRSZW1vdGUsXG4gICAgaXNTcGVjdWxhdGl2ZSA9IGZhbHNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY3JlYXRlVGVycmFmb3JtTG9nSGFuZGxlciA9IChfcGhhc2U6IHN0cmluZykgPT5cbiAgICAgIChfc3Rkb3V0OiBzdHJpbmcsIF9pc0VyciA9IGZhbHNlKSA9PiB7fSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1mdW5jdGlvblxuICApIHtcbiAgICBpZiAoIWNvbmZpZy53b3Jrc3BhY2VzLm5hbWUpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQbGVhc2UgcHJvdmlkZSBhIHdvcmtzcGFjZSBuYW1lIGZvciBUZXJyYWZvcm0gQ2xvdWRcIik7XG4gICAgaWYgKCFjb25maWcub3JnYW5pemF0aW9uKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGxlYXNlIHByb3ZpZGUgYW4gb3JnYW5pemF0aW9uIGZvciBUZXJyYWZvcm0gQ2xvdWRcIik7XG4gICAgdGhpcy53b3JrRGlyID0gc3RhY2sud29ya2luZ0RpcmVjdG9yeTtcblxuICAgIHRoaXMuaG9zdG5hbWUgPSBjb25maWcuaG9zdG5hbWUgfHwgXCJhcHAudGVycmFmb3JtLmlvXCI7XG4gICAgdGhpcy53b3Jrc3BhY2VOYW1lID0gY29uZmlnLndvcmtzcGFjZXMubmFtZTtcbiAgICB0aGlzLm9yZ2FuaXphdGlvbk5hbWUgPSBjb25maWcub3JnYW5pemF0aW9uO1xuICAgIHRoaXMuaXNTcGVjdWxhdGl2ZSA9IGlzU3BlY3VsYXRpdmU7XG4gICAgaWYgKGNvbmZpZy50b2tlbikge1xuICAgICAgdGhpcy50b2tlbiA9IGNvbmZpZy50b2tlbjtcbiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52LlRFUlJBRk9STV9DTE9VRF9UT0tFTikge1xuICAgICAgdGhpcy50b2tlbiA9IHByb2Nlc3MuZW52LlRFUlJBRk9STV9DTE9VRF9UT0tFTjtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHRoaXMudGVycmFmb3JtQ29uZmlnRmlsZVBhdGgpKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQbGVhc2UgcHJvdmlkZSBhIHRva2VuIGZvciBUZXJyYWZvcm0gQ2xvdWRcIik7XG4gICAgICBjb25zdCBjb25maWdGaWxlID0gSlNPTi5wYXJzZShcbiAgICAgICAgZnMucmVhZEZpbGVTeW5jKHRoaXMudGVycmFmb3JtQ29uZmlnRmlsZVBhdGgsIFwidXRmOFwiKVxuICAgICAgKSBhcyBUZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGU7XG4gICAgICB0aGlzLnRva2VuID0gY29uZmlnRmlsZS5jcmVkZW50aWFsc1t0aGlzLmhvc3RuYW1lXS50b2tlbjtcbiAgICB9XG5cbiAgICB0aGlzLmNsaWVudCA9IG5ldyBUZXJyYWZvcm1DbG91ZENsaWVudC5UZXJyYWZvcm1DbG91ZChcbiAgICAgIHRoaXMudG9rZW4sXG4gICAgICB0aGlzLmhvc3RuYW1lXG4gICAgKTtcblxuICAgIHRoaXMuYWJvcnRTaWduYWwuYWRkRXZlbnRMaXN0ZW5lcihcImFib3J0XCIsICgpID0+IHtcbiAgICAgIHRoaXMucmVtb3ZlUnVuKFwiY2FuY2VsXCIpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgaHR0cFByb3h5ID0gcHJvY2Vzcy5lbnYuaHR0cF9wcm94eSB8fCBwcm9jZXNzLmVudi5IVFRQX1BST1hZO1xuICAgIGlmIChodHRwUHJveHkgJiYgaHR0cFByb3h5ICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAvLyDCr1xcXyjjg4QpXy/Cr1xuICAgICAgY29uc3QgdXJsID0gbmV3IFVSTChodHRwUHJveHkpO1xuICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICBgc2V0dGluZyB0dW5uZWwgYWdlbnQgdmlhIGhvc3RuYW1lPSR7dXJsLmhvc3RuYW1lfSBwb3J0PSR7dXJsLnBvcnR9YFxuICAgICAgKTtcbiAgICAgIHRoaXMuY2xpZW50LmNsaWVudC5kZWZhdWx0cy5odHRwc0FnZW50ID0gYWdlbnQuaHR0cHNPdmVySHR0cCh7XG4gICAgICAgIHByb3h5OiB7IGhvc3Q6IHVybC5ob3N0bmFtZSwgcG9ydDogdXJsLnBvcnQgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIEBCZWF1dGlmeUVycm9ycyhcIklzUmVtb3RlV29ya3NwYWNlXCIpXG4gIHB1YmxpYyBhc3luYyBpc1JlbW90ZVdvcmtzcGFjZSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCB3b3Jrc3BhY2UgPSBhd2FpdCB0aGlzLndvcmtzcGFjZSgpO1xuICAgIHJldHVybiB3b3Jrc3BhY2UuYXR0cmlidXRlcy5leGVjdXRpb25Nb2RlICE9PSBcImxvY2FsXCI7XG4gIH1cblxuICBAQmVhdXRpZnlFcnJvcnMoXCJJbml0XCIpXG4gIHB1YmxpYyBhc3luYyBpbml0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHNlbmRMb2cgPSB0aGlzLmNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIoXCJpbml0XCIpO1xuICAgIGlmIChcbiAgICAgIGZzLmV4aXN0c1N5bmMoXG4gICAgICAgIHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBgdGVycmFmb3JtLiR7dGhpcy5zdGFjay5uYW1lfS50ZnN0YXRlYClcbiAgICAgIClcbiAgICApXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGb3VuZCBhIFwidGVycmFmb3JtLiR7dGhpcy5zdGFjay5uYW1lfS50ZnN0YXRlXCIgZmlsZSBpbiB5b3VyIGN1cnJlbnQgd29ya2luZyBkaXJlY3RvcnkuIFBsZWFzZSBtaWdyYXRlIHRoZSBzdGF0ZSBtYW51YWxseSB0byBUZXJyYWZvcm0gQ2xvdWQgYW5kIGRlbGV0ZSB0aGUgZmlsZSBhZnRlcndhcmRzLiBodHRwczovL2Nkay50Zi9taWdyYXRlLXN0YXRlYFxuICAgICAgKTtcblxuICAgIGNvbnN0IHdvcmtzcGFjZSA9IGF3YWl0IHRoaXMud29ya3NwYWNlKCk7XG4gICAgc2VuZExvZyhcIkNyZWF0aW5nIFRlcnJhZm9ybSBDbG91ZCBjb25maWd1cmF0aW9uIHZlcnNpb25cIik7XG4gICAgY29uc3QgdmVyc2lvbiA9IGF3YWl0IHRoaXMuY2xpZW50LkNvbmZpZ3VyYXRpb25WZXJzaW9uLmNyZWF0ZShcbiAgICAgIHdvcmtzcGFjZS5pZCxcbiAgICAgIHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHR5cGU6IFwiY29uZmlndXJhdGlvbi12ZXJzaW9uXCIsXG4gICAgICAgICAgYXR0cmlidXRlczoge1xuICAgICAgICAgICAgYXV0b1F1ZXVlUnVuczogZmFsc2UsXG4gICAgICAgICAgICBzcGVjdWxhdGl2ZTogdGhpcy5pc1NwZWN1bGF0aXZlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMuY29uZmlndXJhdGlvblZlcnNpb25JZCA9IHZlcnNpb24uaWQ7XG4gICAgc2VuZExvZyhcbiAgICAgIGBDcmVhdGVkIFRlcnJhZm9ybSBDbG91ZCBjb25maWd1cmF0aW9uIHZlcnNpb24gJHt0aGlzLmNvbmZpZ3VyYXRpb25WZXJzaW9uSWR9YFxuICAgICk7XG5cbiAgICB0aGlzLnJlbW92ZUxvY2FsVGVycmFmb3JtRGlyZWN0b3J5KCk7XG5cbiAgICBzZW5kTG9nKGBaaXBwaW5nIHVwIHRoZSBkaXJlY3RvcnkgJHt0aGlzLndvcmtEaXJ9YCk7XG4gICAgY29uc3QgemlwQnVmZmVyID0gYXdhaXQgemlwRGlyZWN0b3J5KHRoaXMud29ya0Rpcik7XG4gICAgaWYgKCF6aXBCdWZmZXIpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZG4ndCB1cGxvYWQgZGlyZWN0b3J5IHRvIFRlcnJhZm9ybSBDbG91ZFwiKTtcblxuICAgIHNlbmRMb2coYFVwbG9hZGluZyB0aGUgZGlyZWN0b3J5IHRvIFRlcnJhZm9ybSBDbG91ZGApO1xuICAgIGF3YWl0IHRoaXMuY2xpZW50LkNvbmZpZ3VyYXRpb25WZXJzaW9uLnVwbG9hZChcbiAgICAgIHZlcnNpb24uYXR0cmlidXRlcy51cGxvYWRVcmwsXG4gICAgICB6aXBCdWZmZXJcbiAgICApO1xuXG4gICAgc2VuZExvZyhgVXBsb2FkZWQgdGhlIGRpcmVjdG9yeSB0byBUZXJyYWZvcm0gQ2xvdWRgKTtcbiAgICBzZW5kTG9nKGBXYWl0aW5nIGZvciBjb25maWd1cmF0aW9uIHZlcnNpb24gdG8gYmVjb21lIHJlYWR5Li4uYCk7XG4gICAgLy8gd2UgbWlnaHQgZ2V0IGFuIEhUVFAgNDIyIGVycm9yIGlmIHdlIGRvbid0IHdhaXQgZm9yIHRoZSBwcm9jZXNzaW5nIGFuZCB0cnkgdG8gcnVuIHRvbyBlYXJseS4gc2VlICM2NDdcbiAgICBhd2FpdCB0aGlzLndhaXRGb3JDb25maWd1cmF0aW9uVmVyc2lvblRvQmVSZWFkeSgpO1xuICB9XG5cbiAgQEJlYXV0aWZ5RXJyb3JzKFwiUGxhblwiKVxuICBwdWJsaWMgYXN5bmMgcGxhbihcbiAgICBkZXN0cm95ID0gZmFsc2UsXG4gICAgcmVmcmVzaE9ubHkgPSBmYWxzZVxuICApOiBQcm9taXNlPFRlcnJhZm9ybVBsYW4+IHtcbiAgICBpZiAoIXRoaXMuY29uZmlndXJhdGlvblZlcnNpb25JZClcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBsZWFzZSBjcmVhdGUgYSBDb25maWd1cmF0aW9uVmVyc2lvbiBiZWZvcmUgcGxhbm5pbmdcIik7XG4gICAgY29uc3Qgc2VuZExvZyA9IHRoaXMuY3JlYXRlVGVycmFmb3JtTG9nSGFuZGxlcihcInBsYW5cIik7XG4gICAgY29uc3Qgd29ya3NwYWNlID0gYXdhaXQgdGhpcy53b3Jrc3BhY2UoKTtcbiAgICBjb25zdCB3b3Jrc3BhY2VVcmwgPSBgaHR0cHM6Ly8ke3RoaXMuaG9zdG5hbWV9L2FwcC8ke3RoaXMub3JnYW5pemF0aW9uTmFtZX0vd29ya3NwYWNlcy8ke3RoaXMud29ya3NwYWNlTmFtZX1gO1xuXG4gICAgaWYgKFxuICAgICAgd29ya3NwYWNlLmF0dHJpYnV0ZXMubG9ja2VkICYmXG4gICAgICB3b3Jrc3BhY2UucmVsYXRpb25zaGlwcz8ubG9ja2VkQnk/LmRhdGE/LnR5cGUgPT09IFwidXNlcnNcIlxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2FuIG5vdCBwbGFuLCB0aGUgd29ya3NwYWNlICR7dGhpcy5vcmdhbml6YXRpb25OYW1lfS8ke3RoaXMud29ya3NwYWNlTmFtZX0gaXMgbG9ja2VkIGJ5IGEgdXNlci4gWW91IGNhbiBmaW5kIG1vcmUgaW5mb3JtYXRpb24gYXQgJHt3b3Jrc3BhY2VVcmx9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICB3b3Jrc3BhY2UuYXR0cmlidXRlcy5sb2NrZWQgJiZcbiAgICAgIHdvcmtzcGFjZS5yZWxhdGlvbnNoaXBzPy5sb2NrZWRCeT8uZGF0YT8udHlwZSA9PT0gXCJydW5zXCJcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbiBub3QgcGxhbiwgdGhlIHdvcmtzcGFjZSAke3RoaXMub3JnYW5pemF0aW9uTmFtZX0vJHt0aGlzLndvcmtzcGFjZU5hbWV9IGlzIGxvY2tlZCBieSBhIHByZXZpb3VzIHJ1biwgcGxlYXNlIHdhaXQgdW50aWwgaXQncyBkb25lLiBZb3UgY2FuIGZpbmQgbW9yZSBpbmZvcm1hdGlvbiBhdCAke3dvcmtzcGFjZVVybH1gXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICh3b3Jrc3BhY2UuYXR0cmlidXRlcy5sb2NrZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbiBub3QgcGxhbiwgdGhlIHdvcmtzcGFjZSAke3RoaXMub3JnYW5pemF0aW9uTmFtZX0vJHtcbiAgICAgICAgICB0aGlzLndvcmtzcGFjZU5hbWVcbiAgICAgICAgfSBpcyBsb2NrZWQgZm9yIGFuIHVua25vd24gcmVhc29uOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgIHdvcmtzcGFjZS5yZWxhdGlvbnNoaXBzPy5sb2NrZWRCeVxuICAgICAgICApfS4gWW91IGNhbiBmaW5kIG1vcmUgaW5mb3JtYXRpb24gYXQgJHt3b3Jrc3BhY2VVcmx9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBzZW5kTG9nKGBDcmVhdGluZyBzcGVjdWxhdGl2ZSBUZXJyYWZvcm0gQ2xvdWQgcnVuYCk7XG4gICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LlJ1bnMuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgYXR0cmlidXRlczoge1xuICAgICAgICAgIGlzRGVzdHJveTogZGVzdHJveSxcbiAgICAgICAgICByZWZyZXNoT25seSxcbiAgICAgICAgICBtZXNzYWdlOiBcImNka3RmXCIsXG4gICAgICAgIH0sXG4gICAgICAgIHJlbGF0aW9uc2hpcHM6IHtcbiAgICAgICAgICBjb25maWd1cmF0aW9uVmVyc2lvbjoge1xuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICBpZDogdGhpcy5jb25maWd1cmF0aW9uVmVyc2lvbklkLFxuICAgICAgICAgICAgICB0eXBlOiBcImNvbmZpZ3VyYXRpb24tdmVyc2lvbnNcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB3b3Jrc3BhY2U6IHtcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgaWQ6IHdvcmtzcGFjZS5pZCxcbiAgICAgICAgICAgICAgdHlwZTogXCJ3b3Jrc3BhY2VzXCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICAgIGNvbnN0IHVybCA9IGBodHRwczovLyR7dGhpcy5ob3N0bmFtZX0vYXBwLyR7dGhpcy5vcmdhbml6YXRpb25OYW1lfS93b3Jrc3BhY2VzLyR7dGhpcy53b3Jrc3BhY2VOYW1lfS9ydW5zLyR7cmVzdWx0LmlkfWA7XG4gICAgc2VuZExvZyhgQ3JlYXRlZCBzcGVjdWxhdGl2ZSBUZXJyYWZvcm0gQ2xvdWQgcnVuOiAke3VybH1gKTtcblxuICAgIGNvbnN0IHBlbmRpbmdTdGF0ZXMgPSBbXCJwZW5kaW5nXCIsIFwicGxhbl9xdWV1ZWRcIiwgXCJwbGFubmluZ1wiXTtcblxuICAgIHdoaWxlIChwZW5kaW5nU3RhdGVzLmluY2x1ZGVzKHJlc3VsdC5hdHRyaWJ1dGVzLnN0YXR1cykpIHtcbiAgICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMudXBkYXRlKHRoaXMuY2xpZW50LCByZXN1bHQuaWQsIFwicGxhblwiKTtcbiAgICAgIGF3YWl0IHdhaXQoMTAwMCk7XG4gICAgfVxuXG4gICAgc2VuZExvZyhgU3BlY3VsYXRpdmUgVGVycmFmb3JtIENsb3VkIHJ1biBkb25lYCk7XG4gICAgaWYgKHJlc3VsdC5hdHRyaWJ1dGVzLnN0YXR1cyA9PT0gXCJlcnJvcmVkXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRXJyb3IgcGxhbm5pbmcgdGhlIHJ1biwgcGxlYXNlIHRha2UgYSBsb29rIGF0ICR7dXJsfWApO1xuICAgIH1cblxuICAgIHNlbmRMb2coYEdldHRpbmcgcGxhbiBvdXRwdXRgKTtcbiAgICBjb25zdCBwbGFuID0gYXdhaXQgdGhpcy5jbGllbnQuUGxhbnMuanNvbk91dHB1dChcbiAgICAgIHJlc3VsdC5yZWxhdGlvbnNoaXBzLnBsYW4uZGF0YS5pZFxuICAgICk7XG5cbiAgICB0aGlzLnJ1biA9IHJlc3VsdDtcbiAgICByZXR1cm4gbmV3IFRlcnJhZm9ybUNsb3VkUGxhbihcbiAgICAgIFwidGVycmFmb3JtLWNsb3VkXCIsXG4gICAgICBwbGFuIGFzIHVua25vd24gYXMgYW55LFxuICAgICAgdXJsXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdXBkYXRlKFxuICAgIGNsaWVudDogVGVycmFmb3JtQ2xvdWRDbGllbnQuVGVycmFmb3JtQ2xvdWQsXG4gICAgcnVuSWQ6IHN0cmluZyxcbiAgICBwaGFzZTogc3RyaW5nXG4gICkge1xuICAgIGNvbnN0IHNlbmRMb2cgPSB0aGlzLmNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIocGhhc2UpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IGNsaWVudC5SdW5zLnNob3cocnVuSWQpO1xuXG4gICAgLy8gZmV0Y2ggbG9ncyBhbmQgdXBkYXRlIFVJIGluIHRoZSBiYWNrZ3JvdW5kXG4gICAgY2xpZW50LkFwcGxpZXMubG9ncyhyZXMucmVsYXRpb25zaGlwcy5hcHBseS5kYXRhLmlkKS50aGVuKCh7IGRhdGEgfSkgPT4ge1xuICAgICAgLy8gSW4gcmFyZSBjYXNlcyB0aGUgYmFja2VuZCBzZW5kcyBhbiBlbXB0eSBjaHVuayBvZiBkYXRhIGJhY2suXG4gICAgICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbShkYXRhLCBcInV0ZjhcIik7XG5cbiAgICAgICAgLy8gV2Ugb25seSB3YW50IHRvIHNlbmQgd2hhdCB3ZSBoYXZlIG5vdCBzZWVuIHlldC5cbiAgICAgICAgY29uc3QgYnVmZmVyV2l0aG91dExhc3RLbm93biA9IGJ1ZmZlclxuICAgICAgICAgIC5zdWJhcnJheSh0aGlzLmxhc3RMb2dNZXNzYWdlTGVuZ3RoKVxuICAgICAgICAgIC50b1N0cmluZyhcInV0ZjhcIik7XG4gICAgICAgIGlmIChidWZmZXJXaXRob3V0TGFzdEtub3duLnRyaW0oKS5sZW5ndGgpIHtcbiAgICAgICAgICBzZW5kTG9nKGJ1ZmZlcldpdGhvdXRMYXN0S25vd24sIGZhbHNlKTtcbiAgICAgICAgICB0aGlzLmxhc3RMb2dNZXNzYWdlTGVuZ3RoID0gYnVmZmVyLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBAQmVhdXRpZnlFcnJvcnMoXCJEZXBsb3lcIilcbiAgcHVibGljIGFzeW5jIGRlcGxveShcbiAgICBfcGxhbkZpbGU6IHN0cmluZyxcbiAgICBfcmVmcmVzaE9ubHk/OiBib29sZWFuXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHNlbmRMb2cgPSB0aGlzLmNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIoXCJkZXBsb3lcIik7XG4gICAgaWYgKCF0aGlzLnJ1bilcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJQbGVhc2UgY3JlYXRlIGEgQ29uZmlndXJhdGlvblZlcnNpb24gLyBQbGFuIGJlZm9yZSBkZXBsb3lpbmdcIlxuICAgICAgKTtcblxuICAgIGNvbnN0IGRlcGxveWluZ1N0YXRlcyA9IFtcImNvbmZpcm1lZFwiLCBcImFwcGx5X3F1ZXVlZFwiLCBcImFwcGx5aW5nXCJdO1xuICAgIGNvbnN0IHJ1bklkID0gdGhpcy5ydW4uaWQ7XG4gICAgc2VuZExvZyhgRGVwbG95aW5nIFRlcnJhZm9ybSBDbG91ZCBydW5gKTtcbiAgICBhd2FpdCB0aGlzLmNsaWVudC5SdW5zLmFjdGlvbihcImFwcGx5XCIsIHJ1bklkKTtcbiAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuUnVucy5zaG93KHJ1bklkKTtcblxuICAgIHdoaWxlIChkZXBsb3lpbmdTdGF0ZXMuaW5jbHVkZXMocmVzdWx0LmF0dHJpYnV0ZXMuc3RhdHVzKSkge1xuICAgICAgcmVzdWx0ID0gYXdhaXQgdGhpcy51cGRhdGUodGhpcy5jbGllbnQsIHJ1bklkLCBcImRlcGxveVwiKTtcbiAgICAgIGF3YWl0IHdhaXQoMTAwMCk7XG4gICAgfVxuXG4gICAgc3dpdGNoIChyZXN1bHQuYXR0cmlidXRlcy5zdGF0dXMpIHtcbiAgICAgIGNhc2UgXCJhcHBsaWVkXCI6XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBlcnJvcjogJHtyZXN1bHQuYXR0cmlidXRlcy5zdGF0dXN9YCk7XG4gICAgfVxuICB9XG5cbiAgQEJlYXV0aWZ5RXJyb3JzKFwiRGVzdHJveVwiKVxuICBwdWJsaWMgYXN5bmMgZGVzdHJveSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMucnVuKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIlBsZWFzZSBjcmVhdGUgYSBDb25maWd1cmF0aW9uVmVyc2lvbiAvIFBsYW4gYmVmb3JlIGRlc3Ryb3lpbmdcIlxuICAgICAgKTtcblxuICAgIGNvbnN0IHNlbmRMb2cgPSB0aGlzLmNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIoXCJkZXN0cm95XCIpO1xuICAgIGNvbnN0IGRlc3Ryb3lpbmdTdGF0ZXMgPSBbXCJjb25maXJtZWRcIiwgXCJhcHBseV9xdWV1ZWRcIiwgXCJhcHBseWluZ1wiXTtcbiAgICBjb25zdCBydW5JZCA9IHRoaXMucnVuLmlkO1xuICAgIHNlbmRMb2coYEFwcGx5aW5nIFRlcnJhZm9ybSBDbG91ZCBydW5gKTtcbiAgICBhd2FpdCB0aGlzLmNsaWVudC5SdW5zLmFjdGlvbihcImFwcGx5XCIsIHJ1bklkKTtcblxuICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmNsaWVudC5SdW5zLnNob3cocnVuSWQpO1xuXG4gICAgd2hpbGUgKGRlc3Ryb3lpbmdTdGF0ZXMuaW5jbHVkZXMocmVzdWx0LmF0dHJpYnV0ZXMuc3RhdHVzKSkge1xuICAgICAgcmVzdWx0ID0gYXdhaXQgdGhpcy51cGRhdGUodGhpcy5jbGllbnQsIHJ1bklkLCBcImRlc3Ryb3lcIik7XG4gICAgICBhd2FpdCB3YWl0KDEwMDApO1xuICAgIH1cblxuICAgIHN3aXRjaCAocmVzdWx0LmF0dHJpYnV0ZXMuc3RhdHVzKSB7XG4gICAgICBjYXNlIFwiYXBwbGllZFwiOlxuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgZXJyb3I6ICR7cmVzdWx0LmF0dHJpYnV0ZXMuc3RhdHVzfWApO1xuICAgIH1cbiAgfVxuXG4gIEBCZWF1dGlmeUVycm9ycyhcIlZlcnNpb25cIilcbiAgcHVibGljIGFzeW5jIHZlcnNpb24oKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMud29ya3NwYWNlKCkpLmF0dHJpYnV0ZXMudGVycmFmb3JtVmVyc2lvbjtcbiAgfVxuXG4gIEBCZWF1dGlmeUVycm9ycyhcIkFib3J0XCIpXG4gIHB1YmxpYyBhc3luYyBhYm9ydCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMucnVuKSB7XG4gICAgICB0aHJvdyBFcnJvcnMuSW50ZXJuYWwoXG4gICAgICAgIFwiTm8gcnVuIGlzIHByZXNlbnQgdG8gYWJvcnQsIHRoaXMgbWVhbnMgd2UgY2FsbGVkIGFib3J0IGJlZm9yZSB0aGUgcGxhbiB3YXMgc3RhcnRlZFwiXG4gICAgICApO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucmVtb3ZlUnVuKFwiZGlzY2FyZFwiKTtcbiAgfVxuXG4gIEBCZWF1dGlmeUVycm9ycyhcIk91dHB1dFwiKVxuICBwdWJsaWMgYXN5bmMgb3V0cHV0KCk6IFByb21pc2U8eyBba2V5OiBzdHJpbmddOiBUZXJyYWZvcm1PdXRwdXQgfT4ge1xuICAgIGNvbnN0IHNlbmRMb2cgPSB0aGlzLmNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIoXCJvdXRwdXRcIik7XG4gICAgc2VuZExvZyhcIkZldGNoaW5nIFRlcnJhZm9ybSBDbG91ZCBvdXRwdXRzXCIpO1xuICAgIGNvbnN0IHN0YXRlVmVyc2lvbiA9IGF3YWl0IHRoaXMuY2xpZW50LlN0YXRlVmVyc2lvbnMuY3VycmVudChcbiAgICAgIChcbiAgICAgICAgYXdhaXQgdGhpcy53b3Jrc3BhY2UoKVxuICAgICAgKS5pZCxcbiAgICAgIHRydWVcbiAgICApO1xuICAgIGlmICghc3RhdGVWZXJzaW9uLmluY2x1ZGVkKSByZXR1cm4ge307XG5cbiAgICBjb25zdCBvdXRwdXRzID0gc3RhdGVWZXJzaW9uLmluY2x1ZGVkLnJlZHVjZSgoYWNjLCBvdXRwdXQpID0+IHtcbiAgICAgIGFjY1tvdXRwdXQuYXR0cmlidXRlcy5uYW1lXSA9IHtcbiAgICAgICAgc2Vuc2l0aXZlOiBvdXRwdXQuYXR0cmlidXRlcy5zZW5zaXRpdmUsXG4gICAgICAgIHR5cGU6IG91dHB1dC5hdHRyaWJ1dGVzLnR5cGUsXG4gICAgICAgIHZhbHVlOiBvdXRwdXQuYXR0cmlidXRlcy52YWx1ZSxcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwge30gYXMgeyBba2V5OiBzdHJpbmddOiBUZXJyYWZvcm1PdXRwdXQgfSk7XG5cbiAgICByZXR1cm4gb3V0cHV0cztcbiAgfVxuXG4gIEBCZWF1dGlmeUVycm9ycyhcIldvcmtzcGFjZVwiKVxuICBwcml2YXRlIGFzeW5jIHdvcmtzcGFjZSgpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuY2xpZW50LldvcmtzcGFjZXMuc2hvd0J5TmFtZShcbiAgICAgICAgdGhpcy5vcmdhbml6YXRpb25OYW1lLFxuICAgICAgICB0aGlzLndvcmtzcGFjZU5hbWVcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUucmVzcG9uc2U/LnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgIC8vIHJldHVybiBhIG1vcmUgZGVzY3JpcHRpdmUgZXJyb3IgbWVzc2FnZSBhcyBodHRwIHJlc3BvbnNlIGlzIG5vdCBkZXNjcmlwdGl2ZSBlbm91Z2hcbiAgICAgICAgLy8gd2lsbCBub3QgYmUgdG91Y2hlZCBieSBCZWF1dGlmeUVycm9ycyBkZWNvcmF0b3JcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBUZXJyYWZvcm1DbG91ZCByZXR1cm5lZCBhbiBIVFRQIDQwNCBlcnJvci4gUGxlYXNlIG1ha2Ugc3VyZSB0aGUgY29uZmlndXJlZCBvcmdhbml6YXRpb24gKCR7dGhpcy5vcmdhbml6YXRpb25OYW1lfSkgYW5kIHdvcmtzcGFjZSAoJHt0aGlzLndvcmtzcGFjZU5hbWV9KSBleGlzdCBhbmQgeW91IGhhdmUgdGhlIGNvcnJlY3QgYWNjZXNzIHJpZ2h0cy5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaXNDb25maWd1cmF0aW9uVmVyc2lvblJlYWR5KCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGlmICghdGhpcy5jb25maWd1cmF0aW9uVmVyc2lvbklkKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIk5vIENvbmZpZ3VyYXRpb25WZXJzaW9uSWQga25vd24uIENhbm5vdCB3YWl0IGZvciBDb25maWd1cmF0aW9uVmVyc2lvbiB0byBiZWNvbWUgcmVhZHlcIlxuICAgICAgKTtcbiAgICBjb25zdCBjb25maWdWZXJzaW9uID0gYXdhaXQgdGhpcy5jbGllbnQuQ29uZmlndXJhdGlvblZlcnNpb24uc2hvdyhcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvblZlcnNpb25JZFxuICAgICk7XG4gICAgY29uc3QgeyBzdGF0dXMgfSA9IGNvbmZpZ1ZlcnNpb24uYXR0cmlidXRlcztcbiAgICBzd2l0Y2ggKHN0YXR1cykge1xuICAgICAgY2FzZSBcInVwbG9hZGVkXCI6XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgY2FzZSBcImVycm9yZWRcIjoge1xuICAgICAgICBjb25zdCB7IGVycm9yLCBlcnJvck1lc3NhZ2UgfSA9IGNvbmZpZ1ZlcnNpb24uYXR0cmlidXRlcztcbiAgICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAgIGBDb25maWd1cmF0aW9uVmVyc2lvbiBpbiBUZXJyYWZvcm0gQ2xvdWQgaGFzIHN0YXR1cyBcIiR7c3RhdHVzfVwiLiBSZXR1cm5lZCBjb25maWcgdmVyc2lvbiB3YXMgJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIGNvbmZpZ1ZlcnNpb25cbiAgICAgICAgICApfWBcbiAgICAgICAgKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBUZXJyYWZvcm0gQ2xvdWQgQ29uZmlndXJhdGlvblZlcnNpb24gJHtcbiAgICAgICAgICAgIHRoaXMuY29uZmlndXJhdGlvblZlcnNpb25JZFxuICAgICAgICAgIH0gaGFzIHN0YXR1cyBcImVycm9yZWRcIiAke0pTT04uc3RyaW5naWZ5KHsgZXJyb3IsIGVycm9yTWVzc2FnZSB9KX1gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBjYXNlIFwicGVuZGluZ1wiOiAvLyBmYWxsdGhyb3VnaFxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBDb25maWd1cmF0aW9uVmVyc2lvbiBpbiBUZXJyYWZvcm0gQ2xvdWQgbm90IGNvbnNpZGVyZWQgcmVhZHkgd2l0aCBzdGF0dXMgXCIke3N0YXR1c31cIi5gXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlbW92ZVJ1bihhY3Rpb246IFwiY2FuY2VsXCIgfCBcImRpc2NhcmRcIikge1xuICAgIGlmICghdGhpcy5ydW4pIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIk5vIHJ1biB0byByZW1vdmVcIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdXJsID0gYGh0dHBzOi8vJHt0aGlzLmhvc3RuYW1lfS9hcHAvJHt0aGlzLm9yZ2FuaXphdGlvbk5hbWV9L3dvcmtzcGFjZXMvJHt0aGlzLndvcmtzcGFjZU5hbWV9L3J1bnMvJHt0aGlzLnJ1bi5pZH1gO1xuICAgIGxvZ2dlci5pbmZvKGAke2FjdGlvbn1pbmcgcnVuICR7dXJsfWApO1xuICAgIHRoaXMuY2xpZW50LlJ1bnMuYWN0aW9uKGFjdGlvbiwgdGhpcy5ydW4uaWQpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgQ2FuY2VsbGVkIHJ1biAke3VybH1gKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBjYW5jZWwgcnVuLCBwbGVhc2UgY2FuY2VsIG1hbnVhbGx5IGF0ICR7dXJsfWApO1xuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHdhaXRGb3JDb25maWd1cmF0aW9uVmVyc2lvblRvQmVSZWFkeShcbiAgICB0aW1lb3V0TXMgPSA2MF8wMDBcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgXCJ3YWl0aW5nIGZvciBDb25maWd1cmF0aW9uIFZlcnNpb24gdG8gYmUgcmVhZHkgaW4gVGVycmFmb3JtIENsb3VkXCJcbiAgICApO1xuICAgIGxldCB0aW1lb3V0UmVhY2hlZCA9IGZhbHNlO1xuICAgIGNvbnN0IHJlYWR5ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgd2hpbGUgKCEoKGF3YWl0IHRoaXMuaXNDb25maWd1cmF0aW9uVmVyc2lvblJlYWR5KCkpICYmICF0aW1lb3V0UmVhY2hlZCkpIHtcbiAgICAgICAgYXdhaXQgd2FpdCgxMDAwKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IHRpbWVvdXQgPSBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB3YWl0KHRpbWVvdXRNcyk7XG4gICAgICB0aW1lb3V0UmVhY2hlZCA9IHRydWU7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBXYWl0aW5nIGZvciBUZXJyYWZvcm0gQ2xvdWQgQ29uZmlndXJhdGlvblZlcnNpb24gdG8gYmVjb21lIHJlYWR5IHRpbWVkIG91dCAodGltZW91dCB3YXMgJHt0aW1lb3V0TXN9bXMpYFxuICAgICAgKTtcbiAgICB9O1xuICAgIGF3YWl0IFByb21pc2UucmFjZShbcmVhZHkoKSwgdGltZW91dCgpXSk7XG4gICAgbG9nZ2VyLmRlYnVnKFwiQ29uZmlndXJhdGlvbiBWZXJzaW9uIGlzIHJlYWR5IGluIFRlcnJhZm9ybSBDbG91ZFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlTG9jYWxUZXJyYWZvcm1EaXJlY3RvcnkoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGZzLnJtU3luYyhwYXRoLnJlc29sdmUodGhpcy5zdGFjay53b3JraW5nRGlyZWN0b3J5LCBcIi50ZXJyYWZvcm1cIiksIHtcbiAgICAgICAgcmVjdXJzaXZlOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgQ291bGQgbm90IHJlbW92ZSAudGVycmFmb3JtIGZvbGRlcmAsIGVycm9yKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==