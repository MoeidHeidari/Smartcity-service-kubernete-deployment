"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TerraformCli = exports.TerraformCliPlan = void 0;
const util_1 = require("cdktf-cli/lib/util");
const terraform_1 = require("./terraform");
const terraform_2 = require("../terraform");
class TerraformCliPlan extends terraform_1.AbstractTerraformPlan {
    constructor(planFile, plan) {
        super(planFile, plan.resource_changes, plan.output_changes);
        this.planFile = planFile;
        this.plan = plan;
    }
}
exports.TerraformCliPlan = TerraformCliPlan;
class TerraformCli {
    constructor(abortSignal, stack, createTerraformLogHandler = (_phase) => (_stdout, _isErr = false) => { } // eslint-disable-line @typescript-eslint/no-empty-function
    ) {
        this.abortSignal = abortSignal;
        this.stack = stack;
        this.workdir = stack.workingDirectory;
        this.onStdout = (phase) => (stdout) => createTerraformLogHandler(phase)(stdout.toString());
        this.onStderr = (phase) => (stderr) => createTerraformLogHandler(phase)(stderr.toString(), true);
    }
    async init() {
        await this.setUserAgent();
        await util_1.exec(terraform_2.terraformBinaryName, ["init", "-input=false"], {
            cwd: this.workdir,
            env: process.env,
            signal: this.abortSignal,
        }, this.onStdout("init"), this.onStderr("init"));
    }
    async plan(destroy = false, refreshOnly = false) {
        const planFile = "plan";
        const options = ["plan", "-input=false", "-out", planFile];
        if (destroy) {
            options.push("-destroy");
        }
        if (refreshOnly) {
            options.push("-refresh-only");
        }
        await this.setUserAgent();
        await util_1.exec(terraform_2.terraformBinaryName, options, {
            cwd: this.workdir,
            env: process.env,
            signal: this.abortSignal,
        }, this.onStdout("plan"), this.onStderr("plan"));
        const jsonPlan = await util_1.exec(terraform_2.terraformBinaryName, ["show", "-json", planFile], { cwd: this.workdir, env: process.env, signal: this.abortSignal }, 
        // we don't care about the output, this is just internally to compose a plan
        () => { }, // eslint-disable-line @typescript-eslint/no-empty-function
        this.onStderr("plan"));
        return new TerraformCliPlan(planFile, JSON.parse(jsonPlan));
    }
    async deploy(planFile, refreshOnly = false, extraOptions = []) {
        await this.setUserAgent();
        await util_1.exec(terraform_2.terraformBinaryName, [
            "apply",
            "-auto-approve",
            "-input=false",
            ...extraOptions,
            // only appends planFile if not empty
            // this allows deploying without a plan (as used in watch)
            ...(planFile ? [planFile] : []),
            ...(refreshOnly ? ["-refresh-only"] : []),
        ], { cwd: this.workdir, env: process.env, signal: this.abortSignal }, this.onStdout("deploy"), this.onStderr("deploy"));
    }
    async destroy() {
        await this.setUserAgent();
        await util_1.exec(terraform_2.terraformBinaryName, ["destroy", "-auto-approve", "-input=false"], { cwd: this.workdir, env: process.env, signal: this.abortSignal }, this.onStdout("destroy"), this.onStderr("destroy"));
    }
    async version() {
        try {
            return await util_1.exec(terraform_2.terraformBinaryName, ["-v"], {
                cwd: this.workdir,
                env: process.env,
                signal: this.abortSignal,
            }, this.onStdout("version"), this.onStderr("version"));
        }
        catch (_a) {
            throw new Error("Terraform CLI not present - Please install a current version https://learn.hashicorp.com/terraform/getting-started/install.html");
        }
    }
    async output() {
        const output = await util_1.exec(terraform_2.terraformBinaryName, ["output", "-json"], {
            cwd: this.workdir,
            env: process.env,
            signal: this.abortSignal,
        }, 
        // We don't need to log the output here since we use it later on
        () => { }, // eslint-disable-line @typescript-eslint/no-empty-function
        this.onStderr("output"));
        return JSON.parse(output);
    }
    async setUserAgent() {
        // Read the cdktf version from the 'cdk.tf.json' file
        // and set the user agent.
        const version = await util_1.readCDKTFVersion(this.workdir);
        if (version != "") {
            process.env.TF_APPEND_USER_AGENT =
                "cdktf/" + version + " (+https://github.com/hashicorp/terraform-cdk)";
        }
    }
    // We don't need to clean anything up for a running execution in the CLI since there is no left-over state in contrast to an open Terraform Cloud run
    async abort() {
        return;
    }
}
exports.TerraformCli = TerraformCli;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFmb3JtLWNsaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlcnJhZm9ybS1jbGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkNBQTREO0FBQzVELDJDQUtxQjtBQUVyQiw0Q0FBbUQ7QUFFbkQsTUFBYSxnQkFDWCxTQUFRLGlDQUFxQjtJQUc3QixZQUNrQixRQUFnQixFQUNoQixJQUE0QjtRQUU1QyxLQUFLLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFINUMsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUNoQixTQUFJLEdBQUosSUFBSSxDQUF3QjtJQUc5QyxDQUFDO0NBQ0Y7QUFWRCw0Q0FVQztBQUVELE1BQWEsWUFBWTtJQU92QixZQUNtQixXQUF3QixFQUN6QixLQUF1QixFQUN2Qyw0QkFBNEIsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUM3QyxDQUFDLE9BQWUsRUFBRSxNQUFNLEdBQUcsS0FBSyxFQUFFLEVBQUUsR0FBRSxDQUFDLENBQUMsMkRBQTJEOztRQUhwRixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN6QixVQUFLLEdBQUwsS0FBSyxDQUFrQjtRQUl2QyxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQztRQUN0QyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsS0FBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDLE1BQWMsRUFBRSxFQUFFLENBQ3BELHlCQUF5QixDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBMkIsRUFBRSxFQUFFLENBQ2pFLHlCQUF5QixDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM5RCxDQUFD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QUUsMkRBQTJEO1FBQ3JFLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQ3hCLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVNLEtBQUssQ0FBQyxZQUFZO1FBQ3ZCLHFEQUFxRDtRQUNyRCwwQkFBMEI7UUFDMUIsTUFBTSxPQUFPLEdBQUcsTUFBTSx1QkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDckQsSUFBSSxPQUFPLElBQUksRUFBRSxFQUFFO1lBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CO2dCQUM5QixRQUFRLEdBQUcsT0FBTyxHQUFHLGdEQUFnRCxDQUFDO1NBQ3pFO0lBQ0gsQ0FBQztJQUVELHFKQUFxSjtJQUM5SSxLQUFLLENBQUMsS0FBSztRQUNoQixPQUFPO0lBQ1QsQ0FBQztDQUNGO0FBN0pELG9DQTZKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4ZWMsIHJlYWRDREtURlZlcnNpb24gfSBmcm9tIFwiY2RrdGYtY2xpL2xpYi91dGlsXCI7XG5pbXBvcnQge1xuICBUZXJyYWZvcm0sXG4gIFRlcnJhZm9ybVBsYW4sXG4gIFRlcnJhZm9ybU91dHB1dCxcbiAgQWJzdHJhY3RUZXJyYWZvcm1QbGFuLFxufSBmcm9tIFwiLi90ZXJyYWZvcm1cIjtcbmltcG9ydCB7IFN5bnRoZXNpemVkU3RhY2sgfSBmcm9tIFwiLi4vc3ludGgtc3RhY2tcIjtcbmltcG9ydCB7IHRlcnJhZm9ybUJpbmFyeU5hbWUgfSBmcm9tIFwiLi4vdGVycmFmb3JtXCI7XG5cbmV4cG9ydCBjbGFzcyBUZXJyYWZvcm1DbGlQbGFuXG4gIGV4dGVuZHMgQWJzdHJhY3RUZXJyYWZvcm1QbGFuXG4gIGltcGxlbWVudHMgVGVycmFmb3JtUGxhblxue1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGxhbkZpbGU6IHN0cmluZyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGxhbjogeyBba2V5OiBzdHJpbmddOiBhbnkgfVxuICApIHtcbiAgICBzdXBlcihwbGFuRmlsZSwgcGxhbi5yZXNvdXJjZV9jaGFuZ2VzLCBwbGFuLm91dHB1dF9jaGFuZ2VzKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVGVycmFmb3JtQ2xpIGltcGxlbWVudHMgVGVycmFmb3JtIHtcbiAgcHVibGljIHJlYWRvbmx5IHdvcmtkaXI6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBvblN0ZG91dDogKHN0YXRlTmFtZTogc3RyaW5nKSA9PiAoc3Rkb3V0OiBCdWZmZXIpID0+IHZvaWQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgb25TdGRlcnI6IChcbiAgICBzdGF0ZU5hbWU6IHN0cmluZ1xuICApID0+IChzdGRlcnI6IHN0cmluZyB8IFVpbnQ4QXJyYXkpID0+IHZvaWQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBhYm9ydFNpZ25hbDogQWJvcnRTaWduYWwsXG4gICAgcHVibGljIHJlYWRvbmx5IHN0YWNrOiBTeW50aGVzaXplZFN0YWNrLFxuICAgIGNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIgPSAoX3BoYXNlOiBzdHJpbmcpID0+XG4gICAgICAoX3N0ZG91dDogc3RyaW5nLCBfaXNFcnIgPSBmYWxzZSkgPT4ge30gLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZW1wdHktZnVuY3Rpb25cbiAgKSB7XG4gICAgdGhpcy53b3JrZGlyID0gc3RhY2sud29ya2luZ0RpcmVjdG9yeTtcbiAgICB0aGlzLm9uU3Rkb3V0ID0gKHBoYXNlOiBzdHJpbmcpID0+IChzdGRvdXQ6IEJ1ZmZlcikgPT5cbiAgICAgIGNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIocGhhc2UpKHN0ZG91dC50b1N0cmluZygpKTtcbiAgICB0aGlzLm9uU3RkZXJyID0gKHBoYXNlOiBzdHJpbmcpID0+IChzdGRlcnI6IHN0cmluZyB8IFVpbnQ4QXJyYXkpID0+XG4gICAgICBjcmVhdGVUZXJyYWZvcm1Mb2dIYW5kbGVyKHBoYXNlKShzdGRlcnIudG9TdHJpbmcoKSwgdHJ1ZSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnNldFVzZXJBZ2VudCgpO1xuICAgIGF3YWl0IGV4ZWMoXG4gICAgICB0ZXJyYWZvcm1CaW5hcnlOYW1lLFxuICAgICAgW1wiaW5pdFwiLCBcIi1pbnB1dD1mYWxzZVwiXSxcbiAgICAgIHtcbiAgICAgICAgY3dkOiB0aGlzLndvcmtkaXIsXG4gICAgICAgIGVudjogcHJvY2Vzcy5lbnYsXG4gICAgICAgIHNpZ25hbDogdGhpcy5hYm9ydFNpZ25hbCxcbiAgICAgIH0sXG4gICAgICB0aGlzLm9uU3Rkb3V0KFwiaW5pdFwiKSxcbiAgICAgIHRoaXMub25TdGRlcnIoXCJpbml0XCIpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBwbGFuKFxuICAgIGRlc3Ryb3kgPSBmYWxzZSxcbiAgICByZWZyZXNoT25seSA9IGZhbHNlXG4gICk6IFByb21pc2U8VGVycmFmb3JtUGxhbj4ge1xuICAgIGNvbnN0IHBsYW5GaWxlID0gXCJwbGFuXCI7XG4gICAgY29uc3Qgb3B0aW9ucyA9IFtcInBsYW5cIiwgXCItaW5wdXQ9ZmFsc2VcIiwgXCItb3V0XCIsIHBsYW5GaWxlXTtcbiAgICBpZiAoZGVzdHJveSkge1xuICAgICAgb3B0aW9ucy5wdXNoKFwiLWRlc3Ryb3lcIik7XG4gICAgfVxuICAgIGlmIChyZWZyZXNoT25seSkge1xuICAgICAgb3B0aW9ucy5wdXNoKFwiLXJlZnJlc2gtb25seVwiKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5zZXRVc2VyQWdlbnQoKTtcbiAgICBhd2FpdCBleGVjKFxuICAgICAgdGVycmFmb3JtQmluYXJ5TmFtZSxcbiAgICAgIG9wdGlvbnMsXG4gICAgICB7XG4gICAgICAgIGN3ZDogdGhpcy53b3JrZGlyLFxuICAgICAgICBlbnY6IHByb2Nlc3MuZW52LFxuICAgICAgICBzaWduYWw6IHRoaXMuYWJvcnRTaWduYWwsXG4gICAgICB9LFxuICAgICAgdGhpcy5vblN0ZG91dChcInBsYW5cIiksXG4gICAgICB0aGlzLm9uU3RkZXJyKFwicGxhblwiKVxuICAgICk7XG5cbiAgICBjb25zdCBqc29uUGxhbiA9IGF3YWl0IGV4ZWMoXG4gICAgICB0ZXJyYWZvcm1CaW5hcnlOYW1lLFxuICAgICAgW1wic2hvd1wiLCBcIi1qc29uXCIsIHBsYW5GaWxlXSxcbiAgICAgIHsgY3dkOiB0aGlzLndvcmtkaXIsIGVudjogcHJvY2Vzcy5lbnYsIHNpZ25hbDogdGhpcy5hYm9ydFNpZ25hbCB9LFxuICAgICAgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCB0aGUgb3V0cHV0LCB0aGlzIGlzIGp1c3QgaW50ZXJuYWxseSB0byBjb21wb3NlIGEgcGxhblxuICAgICAgKCkgPT4ge30sIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWZ1bmN0aW9uXG4gICAgICB0aGlzLm9uU3RkZXJyKFwicGxhblwiKVxuICAgICk7XG4gICAgcmV0dXJuIG5ldyBUZXJyYWZvcm1DbGlQbGFuKHBsYW5GaWxlLCBKU09OLnBhcnNlKGpzb25QbGFuKSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVwbG95KFxuICAgIHBsYW5GaWxlOiBzdHJpbmcsXG4gICAgcmVmcmVzaE9ubHkgPSBmYWxzZSxcbiAgICBleHRyYU9wdGlvbnM6IHN0cmluZ1tdID0gW11cbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zZXRVc2VyQWdlbnQoKTtcbiAgICBhd2FpdCBleGVjKFxuICAgICAgdGVycmFmb3JtQmluYXJ5TmFtZSxcbiAgICAgIFtcbiAgICAgICAgXCJhcHBseVwiLFxuICAgICAgICBcIi1hdXRvLWFwcHJvdmVcIixcbiAgICAgICAgXCItaW5wdXQ9ZmFsc2VcIixcblxuICAgICAgICAuLi5leHRyYU9wdGlvbnMsXG4gICAgICAgIC8vIG9ubHkgYXBwZW5kcyBwbGFuRmlsZSBpZiBub3QgZW1wdHlcbiAgICAgICAgLy8gdGhpcyBhbGxvd3MgZGVwbG95aW5nIHdpdGhvdXQgYSBwbGFuIChhcyB1c2VkIGluIHdhdGNoKVxuICAgICAgICAuLi4ocGxhbkZpbGUgPyBbcGxhbkZpbGVdIDogW10pLFxuICAgICAgICAuLi4ocmVmcmVzaE9ubHkgPyBbXCItcmVmcmVzaC1vbmx5XCJdIDogW10pLFxuICAgICAgXSxcbiAgICAgIHsgY3dkOiB0aGlzLndvcmtkaXIsIGVudjogcHJvY2Vzcy5lbnYsIHNpZ25hbDogdGhpcy5hYm9ydFNpZ25hbCB9LFxuICAgICAgdGhpcy5vblN0ZG91dChcImRlcGxveVwiKSxcbiAgICAgIHRoaXMub25TdGRlcnIoXCJkZXBsb3lcIilcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3koKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zZXRVc2VyQWdlbnQoKTtcbiAgICBhd2FpdCBleGVjKFxuICAgICAgdGVycmFmb3JtQmluYXJ5TmFtZSxcbiAgICAgIFtcImRlc3Ryb3lcIiwgXCItYXV0by1hcHByb3ZlXCIsIFwiLWlucHV0PWZhbHNlXCJdLFxuICAgICAgeyBjd2Q6IHRoaXMud29ya2RpciwgZW52OiBwcm9jZXNzLmVudiwgc2lnbmFsOiB0aGlzLmFib3J0U2lnbmFsIH0sXG4gICAgICB0aGlzLm9uU3Rkb3V0KFwiZGVzdHJveVwiKSxcbiAgICAgIHRoaXMub25TdGRlcnIoXCJkZXN0cm95XCIpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB2ZXJzaW9uKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBleGVjKFxuICAgICAgICB0ZXJyYWZvcm1CaW5hcnlOYW1lLFxuICAgICAgICBbXCItdlwiXSxcbiAgICAgICAge1xuICAgICAgICAgIGN3ZDogdGhpcy53b3JrZGlyLFxuICAgICAgICAgIGVudjogcHJvY2Vzcy5lbnYsXG4gICAgICAgICAgc2lnbmFsOiB0aGlzLmFib3J0U2lnbmFsLFxuICAgICAgICB9LFxuICAgICAgICB0aGlzLm9uU3Rkb3V0KFwidmVyc2lvblwiKSxcbiAgICAgICAgdGhpcy5vblN0ZGVycihcInZlcnNpb25cIilcbiAgICAgICk7XG4gICAgfSBjYXRjaCB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiVGVycmFmb3JtIENMSSBub3QgcHJlc2VudCAtIFBsZWFzZSBpbnN0YWxsIGEgY3VycmVudCB2ZXJzaW9uIGh0dHBzOi8vbGVhcm4uaGFzaGljb3JwLmNvbS90ZXJyYWZvcm0vZ2V0dGluZy1zdGFydGVkL2luc3RhbGwuaHRtbFwiXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBvdXRwdXQoKTogUHJvbWlzZTx7IFtrZXk6IHN0cmluZ106IFRlcnJhZm9ybU91dHB1dCB9PiB7XG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgZXhlYyhcbiAgICAgIHRlcnJhZm9ybUJpbmFyeU5hbWUsXG4gICAgICBbXCJvdXRwdXRcIiwgXCItanNvblwiXSxcbiAgICAgIHtcbiAgICAgICAgY3dkOiB0aGlzLndvcmtkaXIsXG4gICAgICAgIGVudjogcHJvY2Vzcy5lbnYsXG4gICAgICAgIHNpZ25hbDogdGhpcy5hYm9ydFNpZ25hbCxcbiAgICAgIH0sXG4gICAgICAvLyBXZSBkb24ndCBuZWVkIHRvIGxvZyB0aGUgb3V0cHV0IGhlcmUgc2luY2Ugd2UgdXNlIGl0IGxhdGVyIG9uXG4gICAgICAoKSA9PiB7fSwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZW1wdHktZnVuY3Rpb25cbiAgICAgIHRoaXMub25TdGRlcnIoXCJvdXRwdXRcIilcbiAgICApO1xuICAgIHJldHVybiBKU09OLnBhcnNlKG91dHB1dCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2V0VXNlckFnZW50KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIFJlYWQgdGhlIGNka3RmIHZlcnNpb24gZnJvbSB0aGUgJ2Nkay50Zi5qc29uJyBmaWxlXG4gICAgLy8gYW5kIHNldCB0aGUgdXNlciBhZ2VudC5cbiAgICBjb25zdCB2ZXJzaW9uID0gYXdhaXQgcmVhZENES1RGVmVyc2lvbih0aGlzLndvcmtkaXIpO1xuICAgIGlmICh2ZXJzaW9uICE9IFwiXCIpIHtcbiAgICAgIHByb2Nlc3MuZW52LlRGX0FQUEVORF9VU0VSX0FHRU5UID1cbiAgICAgICAgXCJjZGt0Zi9cIiArIHZlcnNpb24gKyBcIiAoK2h0dHBzOi8vZ2l0aHViLmNvbS9oYXNoaWNvcnAvdGVycmFmb3JtLWNkaylcIjtcbiAgICB9XG4gIH1cblxuICAvLyBXZSBkb24ndCBuZWVkIHRvIGNsZWFuIGFueXRoaW5nIHVwIGZvciBhIHJ1bm5pbmcgZXhlY3V0aW9uIGluIHRoZSBDTEkgc2luY2UgdGhlcmUgaXMgbm8gbGVmdC1vdmVyIHN0YXRlIGluIGNvbnRyYXN0IHRvIGFuIG9wZW4gVGVycmFmb3JtIENsb3VkIHJ1blxuICBwdWJsaWMgYXN5bmMgYWJvcnQoKSB7XG4gICAgcmV0dXJuO1xuICB9XG59XG4iXX0=