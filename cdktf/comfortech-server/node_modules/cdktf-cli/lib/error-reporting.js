"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.captureException = exports.initializErrorReporting = exports.askForCrashReportingConsent = exports.persistReportCrashReportDecision = exports.shouldReportCrash = void 0;
const Sentry = __importStar(require("@sentry/node"));
const checkpoint_1 = require("./checkpoint");
const debug_1 = require("./debug");
const logging_1 = require("./logging");
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const ci_detect_1 = __importDefault(require("@npmcli/ci-detect"));
const inquirer_1 = __importDefault(require("inquirer"));
const version_1 = require("./version");
function shouldReportCrash(projectPath = process.cwd()) {
    try {
        const cdktfJson = JSON.parse(fs.readFileSync(path.resolve(projectPath, "cdktf.json"), "utf8"));
        return typeof cdktfJson.sendCrashReports === "boolean"
            ? cdktfJson.sendCrashReports
            : cdktfJson.sendCrashReports === "true";
    }
    catch (e) {
        logging_1.logger.debug(`Error determining if crash reporting should be enabled, defaulting to false: ${e}`);
        return false;
    }
}
exports.shouldReportCrash = shouldReportCrash;
function persistReportCrashReportDecision(decision, projectPath = process.cwd()) {
    const cdktfJson = JSON.parse(fs.readFileSync(path.resolve(projectPath, "cdktf.json"), "utf8"));
    cdktfJson.sendCrashReports = decision;
    fs.writeFileSync(path.resolve(projectPath, "cdktf.json"), JSON.stringify(cdktfJson, null, 2));
}
exports.persistReportCrashReportDecision = persistReportCrashReportDecision;
async function askForCrashReportingConsent() {
    const answer = await inquirer_1.default.prompt({
        name: "reportCrash",
        message: "Do you want to send crash reports to the CDKTF team? See https://www.terraform.io/cdktf/create-and-deploy/configuration-file#enable-crash-reporting-for-the-cli for more information",
        type: "confirm",
        default: true,
    });
    return answer.reportCrash;
}
exports.askForCrashReportingConsent = askForCrashReportingConsent;
function isPromise(p) {
    return (typeof p === "object" &&
        typeof p.then === "function" &&
        typeof p.catch === "function");
}
async function initializErrorReporting(askForConsent = false) {
    let shouldReport = shouldReportCrash();
    const ci = ci_detect_1.default();
    // We have no info yet, so we need to ask the user
    if (shouldReport === undefined && askForConsent) {
        // But only if it's a user
        if (ci) {
            return;
        }
        shouldReport = await askForCrashReportingConsent();
        persistReportCrashReportDecision(shouldReport);
    }
    if (!shouldReport) {
        logging_1.logger.debug("Error reporting disabled");
        return;
    }
    if (!process.env.SENTRY_DSN) {
        logging_1.logger.info("Error reporting disabled: SENTRY_DSN not set");
        return;
    }
    logging_1.logger.debug("Initializing error reporting");
    Sentry.init({
        autoSessionTracking: true,
        dsn: process.env.SENTRY_DSN,
        release: `cdktf-cli-${version_1.DISPLAY_VERSION}`,
        async beforeSend(event, hint) {
            if (!hint) {
                return event;
            }
            // The promise character is not documented, but it happens
            const originalException = hint.originalException;
            let error;
            if (isPromise(originalException)) {
                originalException.catch((e) => (error = e));
                await Promise.allSettled([originalException]);
            }
            else {
                error = originalException;
            }
            const errorMessage = (error === null || error === void 0 ? void 0 : error.toString()) || "";
            if (errorMessage.includes("Usage Error")) {
                // This is a usage error, so we don't want to report it
                return null;
            }
            return event;
        },
    });
    Sentry.configureScope(function (scope) {
        scope.setUser({
            id: checkpoint_1.getUserId(),
        });
        scope.setTag("projectId", checkpoint_1.getProjectId());
    });
    logging_1.logger.debug("Collecting environment information for error reporting");
    debug_1.collectDebugInformation().then((debugOutput) => {
        Sentry.setContext("environment", debugOutput);
    });
}
exports.initializErrorReporting = initializErrorReporting;
function captureException({ message, type, command, context, }) {
    if (process.env.SENTRY_DSN && shouldReportCrash()) {
        Sentry.captureException(new Error(message), {
            tags: {
                context: JSON.stringify(context),
                type,
                command,
            },
        });
    }
}
exports.captureException = captureException;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3ItcmVwb3J0aW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXJyb3ItcmVwb3J0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxxREFBdUM7QUFDdkMsNkNBQXVEO0FBQ3ZELG1DQUFrRDtBQUNsRCx1Q0FBbUM7QUFDbkMsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQixrRUFBeUM7QUFDekMsd0RBQWdDO0FBQ2hDLHVDQUE0QztBQUU1QyxTQUFnQixpQkFBaUIsQ0FDL0IsV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUU7SUFFM0IsSUFBSTtRQUNGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQzFCLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQ2pFLENBQUM7UUFFRixPQUFPLE9BQU8sU0FBUyxDQUFDLGdCQUFnQixLQUFLLFNBQVM7WUFDcEQsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0I7WUFDNUIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsS0FBSyxNQUFNLENBQUM7S0FDM0M7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLGdCQUFNLENBQUMsS0FBSyxDQUNWLGdGQUFnRixDQUFDLEVBQUUsQ0FDcEYsQ0FBQztRQUNGLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7QUFDSCxDQUFDO0FBakJELDhDQWlCQztBQUVELFNBQWdCLGdDQUFnQyxDQUM5QyxRQUFpQixFQUNqQixXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRTtJQUUzQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUMxQixFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUNqRSxDQUFDO0lBQ0YsU0FB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Q2YsQ0FBQztLQUNGLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxjQUFjLENBQUMsVUFBVSxLQUFLO1FBQ25DLEtBQUssQ0FBQyxPQUFPLENBQUM7WUFDWixFQUFFLEVBQUUsc0JBQVMsRUFBRTtTQUNoQixDQUFDLENBQUM7UUFDSCxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSx5QkFBWSxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FBQztJQUVILGdCQUFNLENBQUMsS0FBSyxDQUFDLHdEQUF3RCxDQUFDLENBQUM7SUFDdkUsK0JBQXVCLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtRQUM3QyxNQUFNLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUF4RUQsMERBd0VDO0FBRUQsU0FBZ0IsZ0JBQWdCLENBQUMsRUFDL0IsT0FBTyxFQUNQLElBQUksRUFDSixPQUFPLEVBQ1AsT0FBTyxHQU1SO0lBQ0MsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxpQkFBaUIsRUFBRSxFQUFFO1FBQ2pELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUMxQyxJQUFJLEVBQUU7Z0JBQ0osT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDO2dCQUNoQyxJQUFJO2dCQUNKLE9BQU87YUFDUjtTQUNGLENBQUMsQ0FBQztLQUNKO0FBQ0gsQ0FBQztBQXBCRCw0Q0FvQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBTZW50cnkgZnJvbSBcIkBzZW50cnkvbm9kZVwiO1xuaW1wb3J0IHsgZ2V0UHJvamVjdElkLCBnZXRVc2VySWQgfSBmcm9tIFwiLi9jaGVja3BvaW50XCI7XG5pbXBvcnQgeyBjb2xsZWN0RGVidWdJbmZvcm1hdGlvbiB9IGZyb20gXCIuL2RlYnVnXCI7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwiLi9sb2dnaW5nXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCBjaURldGVjdCBmcm9tIFwiQG5wbWNsaS9jaS1kZXRlY3RcIjtcbmltcG9ydCBpbnF1aXJlciBmcm9tIFwiaW5xdWlyZXJcIjtcbmltcG9ydCB7IERJU1BMQVlfVkVSU0lPTiB9IGZyb20gXCIuL3ZlcnNpb25cIjtcblxuZXhwb3J0IGZ1bmN0aW9uIHNob3VsZFJlcG9ydENyYXNoKFxuICBwcm9qZWN0UGF0aCA9IHByb2Nlc3MuY3dkKClcbik6IGJvb2xlYW4gfCB1bmRlZmluZWQge1xuICB0cnkge1xuICAgIGNvbnN0IGNka3RmSnNvbiA9IEpTT04ucGFyc2UoXG4gICAgICBmcy5yZWFkRmlsZVN5bmMocGF0aC5yZXNvbHZlKHByb2plY3RQYXRoLCBcImNka3RmLmpzb25cIiksIFwidXRmOFwiKVxuICAgICk7XG5cbiAgICByZXR1cm4gdHlwZW9mIGNka3RmSnNvbi5zZW5kQ3Jhc2hSZXBvcnRzID09PSBcImJvb2xlYW5cIlxuICAgICAgPyBjZGt0Zkpzb24uc2VuZENyYXNoUmVwb3J0c1xuICAgICAgOiBjZGt0Zkpzb24uc2VuZENyYXNoUmVwb3J0cyA9PT0gXCJ0cnVlXCI7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZGVidWcoXG4gICAgICBgRXJyb3IgZGV0ZXJtaW5pbmcgaWYgY3Jhc2ggcmVwb3J0aW5nIHNob3VsZCBiZSBlbmFibGVkLCBkZWZhdWx0aW5nIHRvIGZhbHNlOiAke2V9YFxuICAgICk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZXJzaXN0UmVwb3J0Q3Jhc2hSZXBvcnREZWNpc2lvbihcbiAgZGVjaXNpb246IGJvb2xlYW4sXG4gIHByb2plY3RQYXRoID0gcHJvY2Vzcy5jd2QoKVxuKSB7XG4gIGNvbnN0IGNka3RmSnNvbiA9IEpTT04ucGFyc2UoXG4gICAgZnMucmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShwcm9qZWN0UGF0aCwgXCJjZGt0Zi5qc29uXCIpLCBcInV0ZjhcIilcbiAgKTtcbiAgY2RrdGZKc29uLnNlbmRDcmFzaFJlcG9ydHMgPSBkZWNpc2lvbjtcbiAgZnMud3JpdGVGaWxlU3luYyhcbiAgICBwYXRoLnJlc29sdmUocHJvamVjdFBhdGgsIFwiY2RrdGYuanNvblwiKSxcbiAgICBKU09OLnN0cmluZ2lmeShjZGt0Zkpzb24sIG51bGwsIDIpXG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhc2tGb3JDcmFzaFJlcG9ydGluZ0NvbnNlbnQoKSB7XG4gIGNvbnN0IGFuc3dlcjogeyByZXBvcnRDcmFzaDogYm9vbGVhbiB9ID0gYXdhaXQgaW5xdWlyZXIucHJvbXB0KHtcbiAgICBuYW1lOiBcInJlcG9ydENyYXNoXCIsXG4gICAgbWVzc2FnZTpcbiAgICAgIFwiRG8geW91IHdhbnQgdG8gc2VuZCBjcmFzaCByZXBvcnRzIHRvIHRoZSBDREtURiB0ZWFtPyBTZWUgaHR0cHM6Ly93d3cudGVycmFmb3JtLmlvL2Nka3RmL2NyZWF0ZS1hbmQtZGVwbG95L2NvbmZpZ3VyYXRpb24tZmlsZSNlbmFibGUtY3Jhc2gtcmVwb3J0aW5nLWZvci10aGUtY2xpIGZvciBtb3JlIGluZm9ybWF0aW9uXCIsXG4gICAgdHlwZTogXCJjb25maXJtXCIsXG4gICAgZGVmYXVsdDogdHJ1ZSxcbiAgfSk7XG5cbiAgcmV0dXJuIGFuc3dlci5yZXBvcnRDcmFzaDtcbn1cblxuZnVuY3Rpb24gaXNQcm9taXNlKHA6IGFueSk6IHAgaXMgUHJvbWlzZTxhbnk+IHtcbiAgcmV0dXJuIChcbiAgICB0eXBlb2YgcCA9PT0gXCJvYmplY3RcIiAmJlxuICAgIHR5cGVvZiBwLnRoZW4gPT09IFwiZnVuY3Rpb25cIiAmJlxuICAgIHR5cGVvZiBwLmNhdGNoID09PSBcImZ1bmN0aW9uXCJcbiAgKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRpYWxpekVycm9yUmVwb3J0aW5nKGFza0ZvckNvbnNlbnQgPSBmYWxzZSkge1xuICBsZXQgc2hvdWxkUmVwb3J0ID0gc2hvdWxkUmVwb3J0Q3Jhc2goKTtcbiAgY29uc3QgY2k6IHN0cmluZyB8IGZhbHNlID0gY2lEZXRlY3QoKTtcblxuICAvLyBXZSBoYXZlIG5vIGluZm8geWV0LCBzbyB3ZSBuZWVkIHRvIGFzayB0aGUgdXNlclxuICBpZiAoc2hvdWxkUmVwb3J0ID09PSB1bmRlZmluZWQgJiYgYXNrRm9yQ29uc2VudCkge1xuICAgIC8vIEJ1dCBvbmx5IGlmIGl0J3MgYSB1c2VyXG4gICAgaWYgKGNpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgc2hvdWxkUmVwb3J0ID0gYXdhaXQgYXNrRm9yQ3Jhc2hSZXBvcnRpbmdDb25zZW50KCk7XG4gICAgcGVyc2lzdFJlcG9ydENyYXNoUmVwb3J0RGVjaXNpb24oc2hvdWxkUmVwb3J0KTtcbiAgfVxuXG4gIGlmICghc2hvdWxkUmVwb3J0KSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiRXJyb3IgcmVwb3J0aW5nIGRpc2FibGVkXCIpO1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoIXByb2Nlc3MuZW52LlNFTlRSWV9EU04pIHtcbiAgICBsb2dnZXIuaW5mbyhcIkVycm9yIHJlcG9ydGluZyBkaXNhYmxlZDogU0VOVFJZX0RTTiBub3Qgc2V0XCIpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZyhcIkluaXRpYWxpemluZyBlcnJvciByZXBvcnRpbmdcIik7XG5cbiAgU2VudHJ5LmluaXQoe1xuICAgIGF1dG9TZXNzaW9uVHJhY2tpbmc6IHRydWUsXG4gICAgZHNuOiBwcm9jZXNzLmVudi5TRU5UUllfRFNOLFxuICAgIHJlbGVhc2U6IGBjZGt0Zi1jbGktJHtESVNQTEFZX1ZFUlNJT059YCxcbiAgICBhc3luYyBiZWZvcmVTZW5kKGV2ZW50LCBoaW50KSB7XG4gICAgICBpZiAoIWhpbnQpIHtcbiAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgfVxuXG4gICAgICAvLyBUaGUgcHJvbWlzZSBjaGFyYWN0ZXIgaXMgbm90IGRvY3VtZW50ZWQsIGJ1dCBpdCBoYXBwZW5zXG4gICAgICBjb25zdCBvcmlnaW5hbEV4Y2VwdGlvbjpcbiAgICAgICAgfCBQcm9taXNlPEVycm9yPlxuICAgICAgICB8IEVycm9yXG4gICAgICAgIHwgc3RyaW5nXG4gICAgICAgIHwgbnVsbFxuICAgICAgICB8IHVuZGVmaW5lZCA9IGhpbnQub3JpZ2luYWxFeGNlcHRpb247XG4gICAgICBsZXQgZXJyb3I6IEVycm9yIHwgc3RyaW5nIHwgbnVsbCB8IHVuZGVmaW5lZDtcbiAgICAgIGlmIChpc1Byb21pc2Uob3JpZ2luYWxFeGNlcHRpb24pKSB7XG4gICAgICAgIChvcmlnaW5hbEV4Y2VwdGlvbiBhcyB1bmtub3duIGFzIFByb21pc2U8RXJyb3I+KS5jYXRjaChcbiAgICAgICAgICAoZSkgPT4gKGVycm9yID0gZSlcbiAgICAgICAgKTtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFtvcmlnaW5hbEV4Y2VwdGlvbl0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXJyb3IgPSBvcmlnaW5hbEV4Y2VwdGlvbjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZXJyb3I/LnRvU3RyaW5nKCkgfHwgXCJcIjtcbiAgICAgIGlmIChlcnJvck1lc3NhZ2UuaW5jbHVkZXMoXCJVc2FnZSBFcnJvclwiKSkge1xuICAgICAgICAvLyBUaGlzIGlzIGEgdXNhZ2UgZXJyb3IsIHNvIHdlIGRvbid0IHdhbnQgdG8gcmVwb3J0IGl0XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGV2ZW50O1xuICAgIH0sXG4gIH0pO1xuXG4gIFNlbnRyeS5jb25maWd1cmVTY29wZShmdW5jdGlvbiAoc2NvcGUpIHtcbiAgICBzY29wZS5zZXRVc2VyKHtcbiAgICAgIGlkOiBnZXRVc2VySWQoKSxcbiAgICB9KTtcbiAgICBzY29wZS5zZXRUYWcoXCJwcm9qZWN0SWRcIiwgZ2V0UHJvamVjdElkKCkpO1xuICB9KTtcblxuICBsb2dnZXIuZGVidWcoXCJDb2xsZWN0aW5nIGVudmlyb25tZW50IGluZm9ybWF0aW9uIGZvciBlcnJvciByZXBvcnRpbmdcIik7XG4gIGNvbGxlY3REZWJ1Z0luZm9ybWF0aW9uKCkudGhlbigoZGVidWdPdXRwdXQpID0+IHtcbiAgICBTZW50cnkuc2V0Q29udGV4dChcImVudmlyb25tZW50XCIsIGRlYnVnT3V0cHV0KTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYXB0dXJlRXhjZXB0aW9uKHtcbiAgbWVzc2FnZSxcbiAgdHlwZSxcbiAgY29tbWFuZCxcbiAgY29udGV4dCxcbn06IHtcbiAgbWVzc2FnZTogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGNvbW1hbmQ6IHN0cmluZztcbiAgY29udGV4dD86IFJlY29yZDxzdHJpbmcsIGFueT47XG59KSB7XG4gIGlmIChwcm9jZXNzLmVudi5TRU5UUllfRFNOICYmIHNob3VsZFJlcG9ydENyYXNoKCkpIHtcbiAgICBTZW50cnkuY2FwdHVyZUV4Y2VwdGlvbihuZXcgRXJyb3IobWVzc2FnZSksIHtcbiAgICAgIHRhZ3M6IHtcbiAgICAgICAgY29udGV4dDogSlNPTi5zdHJpbmdpZnkoY29udGV4dCksXG4gICAgICAgIHR5cGUsXG4gICAgICAgIGNvbW1hbmQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG59XG4iXX0=