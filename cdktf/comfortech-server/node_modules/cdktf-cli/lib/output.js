"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getConstructIdsForOutputs = exports.parseOutput = exports.normalizeOutputPath = exports.saveOutputs = void 0;
const z = __importStar(require("zod"));
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const strip_ansi_1 = __importDefault(require("strip-ansi"));
const logging_1 = require("./logging");
const schema_1 = require("./models/schema");
const terraform_1 = require("./models/terraform");
function unpackTerraformOutput(outputs, includeSensitiveOutputs) {
    return Object.entries(outputs).reduce((acc, [key, entry]) => ({
        ...acc,
        [key]: terraform_1.isTerraformOutput(entry)
            ? !entry.sensitive || includeSensitiveOutputs
                ? entry.value
                : undefined
            : unpackTerraformOutput(entry, includeSensitiveOutputs),
    }), {});
}
async function saveOutputs(filePath, outputs, includeSensitiveOutputs) {
    fs.writeFileSync(filePath, JSON.stringify(unpackTerraformOutput(outputs, includeSensitiveOutputs), null, 2));
}
exports.saveOutputs = saveOutputs;
function normalizeOutputPath(filePath) {
    return path.isAbsolute(filePath)
        ? filePath
        : path.join(process.cwd(), filePath);
}
exports.normalizeOutputPath = normalizeOutputPath;
const mapActionToState = (action, done) => {
    switch (action) {
        case "create":
        case "update":
            return done
                ? terraform_1.DeployingResourceApplyState.CREATED
                : terraform_1.DeployingResourceApplyState.CREATING;
        case "delete":
            return done
                ? terraform_1.DeployingResourceApplyState.DESTROYED
                : terraform_1.DeployingResourceApplyState.DESTROYING;
        default:
            return terraform_1.DeployingResourceApplyState.WAITING;
    }
};
// This is deprecated and will be removed in a future version.
const parseJsonOutputLine = (line) => {
    let json, message;
    try {
        json = JSON.parse(line);
    }
    catch (_a) {
        logging_1.logger.trace(`Could not parse line as JSON: ${line}`);
        return;
    }
    try {
        message = schema_1.schema.parse(json);
    }
    catch (err) {
        if (err instanceof z.ZodError) {
            logging_1.logger.trace(`Error parsing line into schema: ${JSON.stringify(err.errors)} => ${line}`);
        }
        return;
    }
    switch (message.type) {
        case "apply_start":
        case "apply_progress":
            return {
                id: message.hook.resource.resource,
                applyState: mapActionToState(message.hook.action, false),
            };
        case "apply_complete":
            return {
                id: message.hook.resource.resource,
                applyState: mapActionToState(message.hook.action, true),
            };
        default:
            return;
    }
};
const parseTextOutputLine = (line) => {
    if (/^Outputs:/.test(line)) {
        return;
    }
    if (/^Plan:/.test(line)) {
        return;
    }
    if (/^data\..*/.test(line)) {
        return;
    }
    const resourceMatch = line.match(/^([a-zA-Z_][a-zA-Z\d_\-.]*):/);
    let applyState;
    switch (true) {
        case /Creating.../.test(line):
        case /Still creating.../.test(line):
            applyState = terraform_1.DeployingResourceApplyState.CREATING;
            break;
        case /Creation complete/.test(line):
            applyState = terraform_1.DeployingResourceApplyState.CREATED;
            break;
        case /Modifying.../.test(line):
            applyState = terraform_1.DeployingResourceApplyState.UPDATING;
            break;
        case /Modifications complete/.test(line):
            applyState = terraform_1.DeployingResourceApplyState.UPDATED;
            break;
        case /Destroying.../.test(line):
        case /Still destroying.../.test(line):
            applyState = terraform_1.DeployingResourceApplyState.DESTROYING;
            break;
        case /Destruction complete/.test(line):
            applyState = terraform_1.DeployingResourceApplyState.DESTROYED;
            break;
        default:
            return;
    }
    if (resourceMatch &&
        resourceMatch.length >= 0 &&
        resourceMatch[1] != "Warning") {
        return {
            id: resourceMatch[1],
            applyState,
        };
    }
    else {
        return;
    }
};
exports.parseOutput = (str) => {
    const lines = strip_ansi_1.default(str.toString()).split("\n");
    const resources = lines.map((line) => {
        const parsed = parseJsonOutputLine(line) || parseTextOutputLine(line);
        if (parsed === undefined) {
            return;
        }
        const { id, applyState } = parsed;
        return {
            id,
            applyState,
            action: terraform_1.PlannedResourceAction.CREATE,
        };
    });
    return resources.reduce((acc, resource) => {
        if (resource) {
            acc.push(resource);
        }
        return acc;
        // eslint-disable-next-line @typescript-eslint/no-array-constructor
    }, new Array());
};
const isObjectEmpty = (obj) => {
    if (typeof obj !== "object") {
        return false;
    }
    return (Object.keys(obj).length === 0 ||
        Object.values(obj).every((v) => v === undefined || v === null || isObjectEmpty(v)));
};
exports.getConstructIdsForOutputs = (stackContent, outputs) => {
    // Older cdktf versions might not have the output metadata
    if (!("//" in stackContent) || !("outputs" in stackContent["//"])) {
        return outputs;
    }
    const outputsMapping = stackContent["//"].outputs;
    const mapOutputs = (value) => {
        return Object.entries(value).reduce((acc, [key, value]) => {
            if (typeof value === "string") {
                return { ...acc, [key]: outputs[value] };
            }
            const mapped = mapOutputs(value);
            if (isObjectEmpty(mapped)) {
                return acc;
            }
            return {
                ...acc,
                [key]: mapped,
            };
        }, {});
    };
    return mapOutputs(outputsMapping);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3V0cHV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib3V0cHV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1Q0FBeUI7QUFDekIsdUNBQXlCO0FBQ3pCLDJDQUE2QjtBQUM3Qiw0REFBbUM7QUFFbkMsdUNBQW1DO0FBQ25DLDRDQUFzRDtBQUN0RCxrREFNNEI7QUFPNUIsU0FBUyxxQkFBcUIsQ0FDNUIsT0FBK0IsRUFDL0IsdUJBQWdDO0lBRWhDLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQ25DLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3RCLEdBQUcsR0FBRztRQUNOLENBQUMsR0FBRyxDQUFDLEVBQUUsNkJBQWlCLENBQUMsS0FBSyxDQUFDO1lBQzdCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLElBQUksdUJBQXVCO2dCQUMzQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUs7Z0JBQ2IsQ0FBQyxDQUFDLFNBQVM7WUFDYixDQUFDLENBQUMscUJBQXFCLENBQUMsS0FBSyxFQUFFLHVCQUF1QixDQUFDO0tBQzFELENBQUMsRUFDRixFQUFFLENBQ0gsQ0FBQztBQUNKLENBQUM7QUFFTSxLQUFLLFVBQVUsV0FBVyxDQUMvQixRQUFnQixFQUNoQixPQUErQixFQUMvQix1QkFBZ0M7SUFFaEMsRUFBRSxDQUFDLGFBQWEsQ0FDZCxRQUFRLEVBQ1IsSUFBSSxDQUFDLFNBQVMsQ0FDWixxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsdUJBQXVCLENBQUMsRUFDdkQsSUFBSSxFQUNKLENBQUMsQ0FDRixDQUNGLENBQUM7QUFDSixDQUFDO0FBYkQsa0NBYUM7QUFFRCxTQUFnQixtQkFBbUIsQ0FBQyxRQUFnQjtJQUNsRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDO1FB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SUFDMUIsMERBQTBEO0lBQzFELElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFO1FBQ2pFLE9BQU8sT0FBTyxDQUFDO0tBQ2hCO0lBQ0QsTUFBTSxjQUFjLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUVsRCxNQUFNLFVBQVUsR0FBRyxDQUFDLEtBQWtCLEVBQTBCLEVBQUU7UUFDaEUsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQ3hELElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO2dCQUM3QixPQUFPLEVBQUUsR0FBRyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzthQUMxQztZQUVELE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNqQyxJQUFJLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDekIsT0FBTyxHQUFHLENBQUM7YUFDWjtZQUVELE9BQU87Z0JBQ0wsR0FBRyxHQUFHO2dCQUNOLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTTthQUNkLENBQUM7UUFDSixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDVCxDQUFDLENBQUM7SUFFRixPQUFPLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUNwQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB6IGZyb20gXCJ6b2RcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHN0cmlwQW5zaSBmcm9tIFwic3RyaXAtYW5zaVwiO1xuXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwiLi9sb2dnaW5nXCI7XG5pbXBvcnQgeyBBY3Rpb25UeXBlcywgc2NoZW1hIH0gZnJvbSBcIi4vbW9kZWxzL3NjaGVtYVwiO1xuaW1wb3J0IHtcbiAgRGVwbG95aW5nUmVzb3VyY2UsXG4gIERlcGxveWluZ1Jlc291cmNlQXBwbHlTdGF0ZSxcbiAgUGxhbm5lZFJlc291cmNlQWN0aW9uLFxuICBUZXJyYWZvcm1PdXRwdXQsXG4gIGlzVGVycmFmb3JtT3V0cHV0LFxufSBmcm9tIFwiLi9tb2RlbHMvdGVycmFmb3JtXCI7XG5cbmV4cG9ydCB0eXBlIE91dHB1dHMgPSB7IFtrZXk6IHN0cmluZ106IFRlcnJhZm9ybU91dHB1dCB9O1xuZXhwb3J0IHR5cGUgT3V0cHV0SWRNYXBMZWFmID0geyBbY29uc3RydWN0SWQ6IHN0cmluZ106IHN0cmluZyB9O1xuZXhwb3J0IHR5cGUgT3V0cHV0SWRNYXBOb2RlID0geyBbc3RhY2tPckNvbnN0cnVjdElkOiBzdHJpbmddOiBPdXRwdXRJZE1hcCB9O1xuZXhwb3J0IHR5cGUgT3V0cHV0SWRNYXAgPSBPdXRwdXRJZE1hcExlYWYgfCBPdXRwdXRJZE1hcE5vZGU7XG5cbmZ1bmN0aW9uIHVucGFja1RlcnJhZm9ybU91dHB1dChcbiAgb3V0cHV0czogTmVzdGVkVGVycmFmb3JtT3V0cHV0cyxcbiAgaW5jbHVkZVNlbnNpdGl2ZU91dHB1dHM6IGJvb2xlYW5cbik6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4ge1xuICByZXR1cm4gT2JqZWN0LmVudHJpZXMob3V0cHV0cykucmVkdWNlKFxuICAgIChhY2MsIFtrZXksIGVudHJ5XSkgPT4gKHtcbiAgICAgIC4uLmFjYyxcbiAgICAgIFtrZXldOiBpc1RlcnJhZm9ybU91dHB1dChlbnRyeSlcbiAgICAgICAgPyAhZW50cnkuc2Vuc2l0aXZlIHx8IGluY2x1ZGVTZW5zaXRpdmVPdXRwdXRzXG4gICAgICAgICAgPyBlbnRyeS52YWx1ZVxuICAgICAgICAgIDogdW5kZWZpbmVkXG4gICAgICAgIDogdW5wYWNrVGVycmFmb3JtT3V0cHV0KGVudHJ5LCBpbmNsdWRlU2Vuc2l0aXZlT3V0cHV0cyksXG4gICAgfSksXG4gICAge31cbiAgKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNhdmVPdXRwdXRzKFxuICBmaWxlUGF0aDogc3RyaW5nLFxuICBvdXRwdXRzOiBOZXN0ZWRUZXJyYWZvcm1PdXRwdXRzLFxuICBpbmNsdWRlU2Vuc2l0aXZlT3V0cHV0czogYm9vbGVhblxuKSB7XG4gIGZzLndyaXRlRmlsZVN5bmMoXG4gICAgZmlsZVBhdGgsXG4gICAgSlNPTi5zdHJpbmdpZnkoXG4gICAgICB1bnBhY2tUZXJyYWZvcm1PdXRwdXQob3V0cHV0cywgaW5jbHVkZVNlbnNpdGl2ZU91dHB1dHMpLFxuICAgICAgbnVsbCxcbiAgICAgIDJcbiAgICApXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVPdXRwdXRQYXRoKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHBhdGguaXNBYnNvbHV0ZShmaWxlUGF0aClcbiAgICA/IGZpbGVQYXRoXG4gICAgOiBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgZmlsZVBhdGgpO1xufVxuXG5leHBvcnQgdHlwZSBOZXN0ZWRUZXJyYWZvcm1PdXRwdXRzID1cbiAgfCB7IFtrZXk6IHN0cmluZ106IFRlcnJhZm9ybU91dHB1dCB9XG4gIHwgeyBba2V5OiBzdHJpbmddOiBOZXN0ZWRUZXJyYWZvcm1PdXRwdXRzIH07XG5cbmNvbnN0IG1hcEFjdGlvblRvU3RhdGUgPSAoYWN0aW9uOiBBY3Rpb25UeXBlcywgZG9uZTogYm9vbGVhbikgPT4ge1xuICBzd2l0Y2ggKGFjdGlvbikge1xuICAgIGNhc2UgXCJjcmVhdGVcIjpcbiAgICBjYXNlIFwidXBkYXRlXCI6XG4gICAgICByZXR1cm4gZG9uZVxuICAgICAgICA/IERlcGxveWluZ1Jlc291cmNlQXBwbHlTdGF0ZS5DUkVBVEVEXG4gICAgICAgIDogRGVwbG95aW5nUmVzb3VyY2VBcHBseVN0YXRlLkNSRUFUSU5HO1xuICAgIGNhc2UgXCJkZWxldGVcIjpcbiAgICAgIHJldHVybiBkb25lXG4gICAgICAgID8gRGVwbG95aW5nUmVzb3VyY2VBcHBseVN0YXRlLkRFU1RST1lFRFxuICAgICAgICA6IERlcGxveWluZ1Jlc291cmNlQXBwbHlTdGF0ZS5ERVNUUk9ZSU5HO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gRGVwbG95aW5nUmVzb3VyY2VBcHBseVN0YXRlLldBSVRJTkc7XG4gIH1cbn07XG4vLyBUaGlzIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSB2ZXJzaW9uLlxuY29uc3QgcGFyc2VKc29uT3V0cHV0TGluZSA9IChcbiAgbGluZTogc3RyaW5nXG4pOiBPbWl0PERlcGxveWluZ1Jlc291cmNlLCBcImFjdGlvblwiPiB8IHVuZGVmaW5lZCA9PiB7XG4gIGxldCBqc29uLCBtZXNzYWdlO1xuICB0cnkge1xuICAgIGpzb24gPSBKU09OLnBhcnNlKGxpbmUpO1xuICB9IGNhdGNoIHtcbiAgICBsb2dnZXIudHJhY2UoYENvdWxkIG5vdCBwYXJzZSBsaW5lIGFzIEpTT046ICR7bGluZX1gKTtcbiAgICByZXR1cm47XG4gIH1cblxuICB0cnkge1xuICAgIG1lc3NhZ2UgPSBzY2hlbWEucGFyc2UoanNvbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIgaW5zdGFuY2VvZiB6LlpvZEVycm9yKSB7XG4gICAgICBsb2dnZXIudHJhY2UoXG4gICAgICAgIGBFcnJvciBwYXJzaW5nIGxpbmUgaW50byBzY2hlbWE6ICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgZXJyLmVycm9yc1xuICAgICAgICApfSA9PiAke2xpbmV9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm47XG4gIH1cblxuICBzd2l0Y2ggKG1lc3NhZ2UudHlwZSkge1xuICAgIGNhc2UgXCJhcHBseV9zdGFydFwiOlxuICAgIGNhc2UgXCJhcHBseV9wcm9ncmVzc1wiOlxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IG1lc3NhZ2UuaG9vay5yZXNvdXJjZS5yZXNvdXJjZSxcbiAgICAgICAgYXBwbHlTdGF0ZTogbWFwQWN0aW9uVG9TdGF0ZShtZXNzYWdlLmhvb2suYWN0aW9uLCBmYWxzZSksXG4gICAgICB9O1xuXG4gICAgY2FzZSBcImFwcGx5X2NvbXBsZXRlXCI6XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogbWVzc2FnZS5ob29rLnJlc291cmNlLnJlc291cmNlLFxuICAgICAgICBhcHBseVN0YXRlOiBtYXBBY3Rpb25Ub1N0YXRlKG1lc3NhZ2UuaG9vay5hY3Rpb24sIHRydWUpLFxuICAgICAgfTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuO1xuICB9XG59O1xuXG5jb25zdCBwYXJzZVRleHRPdXRwdXRMaW5lID0gKFxuICBsaW5lOiBzdHJpbmdcbik6IE9taXQ8RGVwbG95aW5nUmVzb3VyY2UsIFwiYWN0aW9uXCI+IHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKC9eT3V0cHV0czovLnRlc3QobGluZSkpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKC9eUGxhbjovLnRlc3QobGluZSkpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKC9eZGF0YVxcLi4qLy50ZXN0KGxpbmUpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgcmVzb3VyY2VNYXRjaCA9IGxpbmUubWF0Y2goL14oW2EtekEtWl9dW2EtekEtWlxcZF9cXC0uXSopOi8pO1xuICBsZXQgYXBwbHlTdGF0ZTogRGVwbG95aW5nUmVzb3VyY2VBcHBseVN0YXRlO1xuXG4gIHN3aXRjaCAodHJ1ZSkge1xuICAgIGNhc2UgL0NyZWF0aW5nLi4uLy50ZXN0KGxpbmUpOlxuICAgIGNhc2UgL1N0aWxsIGNyZWF0aW5nLi4uLy50ZXN0KGxpbmUpOlxuICAgICAgYXBwbHlTdGF0ZSA9IERlcGxveWluZ1Jlc291cmNlQXBwbHlTdGF0ZS5DUkVBVElORztcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgL0NyZWF0aW9uIGNvbXBsZXRlLy50ZXN0KGxpbmUpOlxuICAgICAgYXBwbHlTdGF0ZSA9IERlcGxveWluZ1Jlc291cmNlQXBwbHlTdGF0ZS5DUkVBVEVEO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAvTW9kaWZ5aW5nLi4uLy50ZXN0KGxpbmUpOlxuICAgICAgYXBwbHlTdGF0ZSA9IERlcGxveWluZ1Jlc291cmNlQXBwbHlTdGF0ZS5VUERBVElORztcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgL01vZGlmaWNhdGlvbnMgY29tcGxldGUvLnRlc3QobGluZSk6XG4gICAgICBhcHBseVN0YXRlID0gRGVwbG95aW5nUmVzb3VyY2VBcHBseVN0YXRlLlVQREFURUQ7XG4gICAgICBicmVhaztcbiAgICBjYXNlIC9EZXN0cm95aW5nLi4uLy50ZXN0KGxpbmUpOlxuICAgIGNhc2UgL1N0aWxsIGRlc3Ryb3lpbmcuLi4vLnRlc3QobGluZSk6XG4gICAgICBhcHBseVN0YXRlID0gRGVwbG95aW5nUmVzb3VyY2VBcHBseVN0YXRlLkRFU1RST1lJTkc7XG4gICAgICBicmVhaztcbiAgICBjYXNlIC9EZXN0cnVjdGlvbiBjb21wbGV0ZS8udGVzdChsaW5lKTpcbiAgICAgIGFwcGx5U3RhdGUgPSBEZXBsb3lpbmdSZXNvdXJjZUFwcGx5U3RhdGUuREVTVFJPWUVEO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChcbiAgICByZXNvdXJjZU1hdGNoICYmXG4gICAgcmVzb3VyY2VNYXRjaC5sZW5ndGggPj0gMCAmJlxuICAgIHJlc291cmNlTWF0Y2hbMV0gIT0gXCJXYXJuaW5nXCJcbiAgKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiByZXNvdXJjZU1hdGNoWzFdLFxuICAgICAgYXBwbHlTdGF0ZSxcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybjtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHBhcnNlT3V0cHV0ID0gKHN0cjogc3RyaW5nKTogRGVwbG95aW5nUmVzb3VyY2VbXSA9PiB7XG4gIGNvbnN0IGxpbmVzID0gc3RyaXBBbnNpKHN0ci50b1N0cmluZygpKS5zcGxpdChcIlxcblwiKTtcblxuICBjb25zdCByZXNvdXJjZXMgPSBsaW5lcy5tYXAoKGxpbmUpID0+IHtcbiAgICBjb25zdCBwYXJzZWQgPSBwYXJzZUpzb25PdXRwdXRMaW5lKGxpbmUpIHx8IHBhcnNlVGV4dE91dHB1dExpbmUobGluZSk7XG4gICAgaWYgKHBhcnNlZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBpZCwgYXBwbHlTdGF0ZSB9ID0gcGFyc2VkO1xuICAgIHJldHVybiB7XG4gICAgICBpZCxcbiAgICAgIGFwcGx5U3RhdGUsXG4gICAgICBhY3Rpb246IFBsYW5uZWRSZXNvdXJjZUFjdGlvbi5DUkVBVEUsXG4gICAgfTtcbiAgfSk7XG5cbiAgcmV0dXJuIHJlc291cmNlcy5yZWR1Y2UoKGFjYywgcmVzb3VyY2UpID0+IHtcbiAgICBpZiAocmVzb3VyY2UpIHtcbiAgICAgIGFjYy5wdXNoKHJlc291cmNlKTtcbiAgICB9XG4gICAgcmV0dXJuIGFjYztcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWFycmF5LWNvbnN0cnVjdG9yXG4gIH0sIG5ldyBBcnJheSgpKTtcbn07XG5cbmNvbnN0IGlzT2JqZWN0RW1wdHkgPSAob2JqOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogYm9vbGVhbiA9PiB7XG4gIGlmICh0eXBlb2Ygb2JqICE9PSBcIm9iamVjdFwiKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIHJldHVybiAoXG4gICAgT2JqZWN0LmtleXMob2JqKS5sZW5ndGggPT09IDAgfHxcbiAgICBPYmplY3QudmFsdWVzKG9iaikuZXZlcnkoXG4gICAgICAodikgPT4gdiA9PT0gdW5kZWZpbmVkIHx8IHYgPT09IG51bGwgfHwgaXNPYmplY3RFbXB0eSh2KVxuICAgIClcbiAgKTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRDb25zdHJ1Y3RJZHNGb3JPdXRwdXRzID0gKFxuICBzdGFja0NvbnRlbnQ6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gIG91dHB1dHM6IHsgW2tleTogc3RyaW5nXTogVGVycmFmb3JtT3V0cHV0IH1cbik6IE5lc3RlZFRlcnJhZm9ybU91dHB1dHMgPT4ge1xuICAvLyBPbGRlciBjZGt0ZiB2ZXJzaW9ucyBtaWdodCBub3QgaGF2ZSB0aGUgb3V0cHV0IG1ldGFkYXRhXG4gIGlmICghKFwiLy9cIiBpbiBzdGFja0NvbnRlbnQpIHx8ICEoXCJvdXRwdXRzXCIgaW4gc3RhY2tDb250ZW50W1wiLy9cIl0pKSB7XG4gICAgcmV0dXJuIG91dHB1dHM7XG4gIH1cbiAgY29uc3Qgb3V0cHV0c01hcHBpbmcgPSBzdGFja0NvbnRlbnRbXCIvL1wiXS5vdXRwdXRzO1xuXG4gIGNvbnN0IG1hcE91dHB1dHMgPSAodmFsdWU6IE91dHB1dElkTWFwKTogTmVzdGVkVGVycmFmb3JtT3V0cHV0cyA9PiB7XG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKHZhbHVlKS5yZWR1Y2UoKGFjYywgW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHJldHVybiB7IC4uLmFjYywgW2tleV06IG91dHB1dHNbdmFsdWVdIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1hcHBlZCA9IG1hcE91dHB1dHModmFsdWUpO1xuICAgICAgaWYgKGlzT2JqZWN0RW1wdHkobWFwcGVkKSkge1xuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5hY2MsXG4gICAgICAgIFtrZXldOiBtYXBwZWQsXG4gICAgICB9O1xuICAgIH0sIHt9KTtcbiAgfTtcblxuICByZXR1cm4gbWFwT3V0cHV0cyhvdXRwdXRzTWFwcGluZyk7XG59O1xuIl19