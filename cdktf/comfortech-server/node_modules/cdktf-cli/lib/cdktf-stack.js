"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CdktfStack = void 0;
const output_1 = require("./output");
const logging_1 = require("./logging");
const terraform_logs_1 = require("./server/terraform-logs");
const terraform_cloud_1 = require("./models/terraform-cloud");
const terraform_cli_1 = require("./models/terraform-cli");
async function getTerraformClient(abortSignal, stack, isSpeculative, createTerraformLogHandler) {
    var _a, _b;
    const parsedStack = JSON.parse(stack.content);
    if ((_b = (_a = parsedStack.terraform) === null || _a === void 0 ? void 0 : _a.backend) === null || _b === void 0 ? void 0 : _b.remote) {
        const tfClient = new terraform_cloud_1.TerraformCloud(abortSignal, stack, parsedStack.terraform.backend.remote, isSpeculative, createTerraformLogHandler);
        if (await tfClient.isRemoteWorkspace()) {
            return tfClient;
        }
    }
    return new terraform_cli_1.TerraformCli(abortSignal, stack, createTerraformLogHandler);
}
class CdktfStack {
    constructor(options) {
        this.options = options;
        this.stopped = false;
        this.currentState = "idle";
        this.stack = options.stack;
    }
    get isPending() {
        return this.currentState === "idle" && !this.stopped;
    }
    get isDone() {
        return (this.currentState === "done" ||
            this.currentState === "error" ||
            this.stopped);
    }
    get isRunning() {
        return !this.isPending && !this.isDone;
    }
    updateState(update) {
        logging_1.logger.debug(`[${this.stack.name}]: ${update.type}`);
        this.currentState = update.type;
        switch (update.type) {
            case "idle":
            case "done":
            case "error":
                break;
            case "outputs fetched":
            case "deployed":
                logging_1.logger.debug(`Outputs: ${JSON.stringify(update.outputs)}`);
                logging_1.logger.debug(`OutputsByConstructId: ${JSON.stringify(update.outputsByConstructId)}`);
                this.outputs = update.outputs;
                this.outputsByConstructId = update.outputsByConstructId;
                this.options.onUpdate(update);
                break;
            default:
                this.options.onUpdate(update);
                break;
        }
    }
    createTerraformLogHandler(phase) {
        const onLog = this.options.onLog;
        return (msg, isError = false) => {
            const message = terraform_logs_1.extractJsonLogIfPresent(msg);
            logging_1.logger.debug(`[${this.options.stack.name}](${phase}): ${msg}`);
            if (onLog) {
                onLog({ message, isError });
            }
        };
    }
    waitForApproval(plan) {
        return new Promise((resolve) => {
            this.updateState({
                type: "waiting for stack approval",
                stackName: this.stack.name,
                plan: plan,
                approve: () => {
                    resolve(true);
                },
                reject: () => {
                    resolve(false);
                },
            });
        });
    }
    async initalizeTerraform({ isSpeculative, }) {
        const terraform = await getTerraformClient(this.options.abortSignal, this.options.stack, isSpeculative, this.createTerraformLogHandler.bind(this));
        await terraform.init();
        return terraform;
    }
    async run(cb) {
        if (this.stopped) {
            return;
        }
        try {
            this.currentWorkPromise = cb();
            await this.currentWorkPromise;
            this.updateState({ type: "done" });
        }
        catch (e) {
            this.currentWorkPromise = undefined;
            this.updateState({
                type: "errored",
                stackName: this.stack.name,
                error: String(e),
            });
        }
        this.currentWorkPromise = undefined;
    }
    async diff({ refreshOnly }) {
        await this.run(async () => {
            this.updateState({ type: "planning", stackName: this.stack.name });
            const terraform = await this.initalizeTerraform({ isSpeculative: false });
            const plan = await terraform.plan(false, refreshOnly);
            this.currentPlan = plan;
            this.updateState({ type: "planned", stackName: this.stack.name, plan });
        });
    }
    async deploy(refreshOnly) {
        await this.run(async () => {
            this.updateState({ type: "planning", stackName: this.stack.name });
            const terraform = await this.initalizeTerraform({ isSpeculative: false });
            const plan = await terraform.plan(false, refreshOnly);
            this.updateState({ type: "planned", stackName: this.stack.name, plan });
            const approved = this.options.autoApprove
                ? true
                : await this.waitForApproval(plan);
            if (!approved) {
                this.updateState({ type: "dismissed", stackName: this.stack.name });
                return;
            }
            this.updateState({ type: "deploying", stackName: this.stack.name });
            if (plan.needsApply) {
                await terraform.deploy(plan.planFile, refreshOnly);
            }
            const outputs = await terraform.output();
            const outputsByConstructId = output_1.getConstructIdsForOutputs(JSON.parse(this.stack.content), outputs);
            this.updateState({
                type: "deployed",
                stackName: this.stack.name,
                outputs,
                outputsByConstructId,
            });
        });
    }
    async destroy() {
        await this.run(async () => {
            this.updateState({ type: "planning", stackName: this.stack.name });
            const terraform = await this.initalizeTerraform({ isSpeculative: false });
            const plan = await terraform.plan(true);
            this.updateState({ type: "planned", stackName: this.stack.name, plan });
            const approved = this.options.autoApprove
                ? true
                : await this.waitForApproval(plan);
            if (!approved) {
                this.updateState({ type: "dismissed", stackName: this.stack.name });
                return;
            }
            this.updateState({ type: "destroying", stackName: this.stack.name });
            await terraform.destroy();
            this.updateState({
                type: "destroyed",
                stackName: this.stack.name,
            });
        });
    }
    async fetchOutputs() {
        await this.run(async () => {
            const terraform = await this.initalizeTerraform({ isSpeculative: false });
            const outputs = await terraform.output();
            const outputsByConstructId = output_1.getConstructIdsForOutputs(JSON.parse(this.stack.content), outputs);
            this.updateState({
                type: "outputs fetched",
                stackName: this.stack.name,
                outputs,
                outputsByConstructId,
            });
        });
        return this.outputs;
    }
    async stop() {
        this.stopped = true;
    }
}
exports.CdktfStack = CdktfStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrdGYtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjZGt0Zi1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxxQ0FBNkU7QUFDN0UsdUNBQW1DO0FBQ25DLDREQUFrRTtBQUVsRSw4REFBMEQ7QUFDMUQsMERBQXNEO0FBZ0V0RCxLQUFLLFVBQVUsa0JBQWtCLENBQy9CLFdBQXdCLEVBQ3hCLEtBQXVCLEVBQ3ZCLGFBQXNCLEVBQ3RCLHlCQUVpRDs7SUFFakQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFrQixDQUFDO0lBRS9ELGdCQUFJLFdBQVcsQ0FBQyxTQUFTLDBDQUFFLE9BQU8sMENBQUUsTUFBTSxFQUFFO1FBQzFDLE1BQU0sUUFBUSxHQUFHLElBQUksZ0NBQWMsQ0FDakMsV0FBVyxFQUNYLEtBQUssRUFDTCxXQUFXLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQ3BDLGFBQWEsRUFDYix5QkFBeUIsQ0FDMUIsQ0FBQztRQUNGLElBQUksTUFBTSxRQUFRLENBQUMsaUJBQWlCLEVBQUUsRUFBRTtZQUN0QyxPQUFPLFFBQVEsQ0FBQztTQUNqQjtLQUNGO0lBQ0QsT0FBTyxJQUFJLDRCQUFZLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO0FBQ3pFLENBQUM7QUFnQkQsTUFBYSxVQUFVO0lBU3JCLFlBQW1CLE9BQTBCO1FBQTFCLFlBQU8sR0FBUCxPQUFPLENBQW1CO1FBSnRDLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFFUCxpQkFBWSxHQUFxQixNQUFNLENBQUM7UUFHdEQsSUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO0lBQzdCLENBQUM7SUFFRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsWUFBWSxLQUFLLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdkQs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QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUM5QixPQUFPLENBQ1IsQ0FBQztZQUNGLElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ2YsSUFBSSxFQUFFLGlCQUFpQjtnQkFDdkIsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtnQkFDMUIsT0FBTztnQkFDUCxvQkFBb0I7YUFDckIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJO1FBQ2YsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBL05ELGdDQStOQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN5bnRoZXNpemVkU3RhY2sgfSBmcm9tIFwiLi9zeW50aC1zdGFja1wiO1xuaW1wb3J0IHsgVGVycmFmb3JtLCBUZXJyYWZvcm1QbGFuIH0gZnJvbSBcIi4vbW9kZWxzL3RlcnJhZm9ybVwiO1xuaW1wb3J0IHsgZ2V0Q29uc3RydWN0SWRzRm9yT3V0cHV0cywgTmVzdGVkVGVycmFmb3JtT3V0cHV0cyB9IGZyb20gXCIuL291dHB1dFwiO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIi4vbG9nZ2luZ1wiO1xuaW1wb3J0IHsgZXh0cmFjdEpzb25Mb2dJZlByZXNlbnQgfSBmcm9tIFwiLi9zZXJ2ZXIvdGVycmFmb3JtLWxvZ3NcIjtcbmltcG9ydCB7IFRlcnJhZm9ybUpzb24gfSBmcm9tIFwiLi90ZXJyYWZvcm0tanNvblwiO1xuaW1wb3J0IHsgVGVycmFmb3JtQ2xvdWQgfSBmcm9tIFwiLi9tb2RlbHMvdGVycmFmb3JtLWNsb3VkXCI7XG5pbXBvcnQgeyBUZXJyYWZvcm1DbGkgfSBmcm9tIFwiLi9tb2RlbHMvdGVycmFmb3JtLWNsaVwiO1xuXG5leHBvcnQgdHlwZSBTdGFja1VwZGF0ZSA9XG4gIHwge1xuICAgICAgdHlwZTogXCJwbGFubmluZ1wiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwicGxhbm5lZFwiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgICBwbGFuOiBUZXJyYWZvcm1QbGFuO1xuICAgIH1cbiAgfCB7XG4gICAgICB0eXBlOiBcImRlcGxveWluZ1wiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwiZGVwbG95IHVwZGF0ZVwiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgICBkZXBsb3lPdXRwdXQ6IHN0cmluZztcbiAgICB9XG4gIHwge1xuICAgICAgdHlwZTogXCJkZXBsb3llZFwiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgICBvdXRwdXRzQnlDb25zdHJ1Y3RJZDogTmVzdGVkVGVycmFmb3JtT3V0cHV0cztcbiAgICAgIG91dHB1dHM6IFJlY29yZDxzdHJpbmcsIGFueT47XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwiZGVzdHJveWluZ1wiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwiZGVzdHJveSB1cGRhdGVcIjtcbiAgICAgIHN0YWNrTmFtZTogc3RyaW5nO1xuICAgICAgZGVzdHJveU91dHB1dDogc3RyaW5nO1xuICAgIH1cbiAgfCB7XG4gICAgICB0eXBlOiBcImRlc3Ryb3llZFwiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwib3V0cHV0cyBmZXRjaGVkXCI7XG4gICAgICBzdGFja05hbWU6IHN0cmluZztcbiAgICAgIG91dHB1dHNCeUNvbnN0cnVjdElkOiBOZXN0ZWRUZXJyYWZvcm1PdXRwdXRzO1xuICAgICAgb3V0cHV0czogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgICB9XG4gIHwge1xuICAgICAgdHlwZTogXCJlcnJvcmVkXCI7XG4gICAgICBzdGFja05hbWU6IHN0cmluZztcbiAgICAgIGVycm9yOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwiZGlzbWlzc2VkXCI7XG4gICAgICBzdGFja05hbWU6IHN0cmluZztcbiAgICB9O1xuXG5leHBvcnQgdHlwZSBTdGFja0FwcHJvdmFsVXBkYXRlID0ge1xuICB0eXBlOiBcIndhaXRpbmcgZm9yIHN0YWNrIGFwcHJvdmFsXCI7XG4gIHN0YWNrTmFtZTogc3RyaW5nO1xuICBwbGFuOiBUZXJyYWZvcm1QbGFuO1xuICBhcHByb3ZlOiAoKSA9PiB2b2lkO1xuICByZWplY3Q6ICgpID0+IHZvaWQ7XG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRUZXJyYWZvcm1DbGllbnQoXG4gIGFib3J0U2lnbmFsOiBBYm9ydFNpZ25hbCxcbiAgc3RhY2s6IFN5bnRoZXNpemVkU3RhY2ssXG4gIGlzU3BlY3VsYXRpdmU6IGJvb2xlYW4sXG4gIGNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXI6IChcbiAgICBwaGFzZTogc3RyaW5nXG4gICkgPT4gKG1lc3NhZ2U6IHN0cmluZywgaXNFcnJvcj86IGJvb2xlYW4pID0+IHZvaWRcbik6IFByb21pc2U8VGVycmFmb3JtPiB7XG4gIGNvbnN0IHBhcnNlZFN0YWNrID0gSlNPTi5wYXJzZShzdGFjay5jb250ZW50KSBhcyBUZXJyYWZvcm1Kc29uO1xuXG4gIGlmIChwYXJzZWRTdGFjay50ZXJyYWZvcm0/LmJhY2tlbmQ/LnJlbW90ZSkge1xuICAgIGNvbnN0IHRmQ2xpZW50ID0gbmV3IFRlcnJhZm9ybUNsb3VkKFxuICAgICAgYWJvcnRTaWduYWwsXG4gICAgICBzdGFjayxcbiAgICAgIHBhcnNlZFN0YWNrLnRlcnJhZm9ybS5iYWNrZW5kLnJlbW90ZSxcbiAgICAgIGlzU3BlY3VsYXRpdmUsXG4gICAgICBjcmVhdGVUZXJyYWZvcm1Mb2dIYW5kbGVyXG4gICAgKTtcbiAgICBpZiAoYXdhaXQgdGZDbGllbnQuaXNSZW1vdGVXb3Jrc3BhY2UoKSkge1xuICAgICAgcmV0dXJuIHRmQ2xpZW50O1xuICAgIH1cbiAgfVxuICByZXR1cm4gbmV3IFRlcnJhZm9ybUNsaShhYm9ydFNpZ25hbCwgc3RhY2ssIGNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIpO1xufVxuXG50eXBlIENka3RmU3RhY2tPcHRpb25zID0ge1xuICBzdGFjazogU3ludGhlc2l6ZWRTdGFjaztcbiAgb25VcGRhdGU6ICh1cGRhdGU6IFN0YWNrVXBkYXRlIHwgU3RhY2tBcHByb3ZhbFVwZGF0ZSkgPT4gdm9pZDtcbiAgb25Mb2c/OiAobG9nOiB7IG1lc3NhZ2U6IHN0cmluZzsgaXNFcnJvcjogYm9vbGVhbiB9KSA9PiB2b2lkO1xuICBhdXRvQXBwcm92ZT86IGJvb2xlYW47XG4gIGFib3J0U2lnbmFsOiBBYm9ydFNpZ25hbDtcbn07XG50eXBlIENka3RmU3RhY2tTdGF0ZXMgPVxuICB8IFN0YWNrVXBkYXRlW1widHlwZVwiXVxuICB8IFN0YWNrQXBwcm92YWxVcGRhdGVbXCJ0eXBlXCJdXG4gIHwgXCJpZGxlXCJcbiAgfCBcImRvbmVcIlxuICB8IFwiZXJyb3JcIjtcblxuZXhwb3J0IGNsYXNzIENka3RmU3RhY2sge1xuICBwdWJsaWMgY3VycmVudFBsYW4/OiBUZXJyYWZvcm1QbGFuO1xuICBwdWJsaWMgc3RhY2s6IFN5bnRoZXNpemVkU3RhY2s7XG4gIHB1YmxpYyBvdXRwdXRzPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgcHVibGljIG91dHB1dHNCeUNvbnN0cnVjdElkPzogTmVzdGVkVGVycmFmb3JtT3V0cHV0cztcbiAgcHVibGljIHN0b3BwZWQgPSBmYWxzZTtcbiAgcHVibGljIGN1cnJlbnRXb3JrUHJvbWlzZTogUHJvbWlzZTx2b2lkPiB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHJlYWRvbmx5IGN1cnJlbnRTdGF0ZTogQ2RrdGZTdGFja1N0YXRlcyA9IFwiaWRsZVwiO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBvcHRpb25zOiBDZGt0ZlN0YWNrT3B0aW9ucykge1xuICAgIHRoaXMuc3RhY2sgPSBvcHRpb25zLnN0YWNrO1xuICB9XG5cbiAgcHVibGljIGdldCBpc1BlbmRpbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlID09PSBcImlkbGVcIiAmJiAhdGhpcy5zdG9wcGVkO1xuICB9XG4gIHB1YmxpYyBnZXQgaXNEb25lKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9PT0gXCJkb25lXCIgfHxcbiAgICAgIHRoaXMuY3VycmVudFN0YXRlID09PSBcImVycm9yXCIgfHxcbiAgICAgIHRoaXMuc3RvcHBlZFxuICAgICk7XG4gIH1cbiAgcHVibGljIGdldCBpc1J1bm5pbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICF0aGlzLmlzUGVuZGluZyAmJiAhdGhpcy5pc0RvbmU7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVN0YXRlKFxuICAgIHVwZGF0ZTpcbiAgICAgIHwgU3RhY2tVcGRhdGVcbiAgICAgIHwgU3RhY2tBcHByb3ZhbFVwZGF0ZVxuICAgICAgfCB7IHR5cGU6IFwiaWRsZVwiIH1cbiAgICAgIHwgeyB0eXBlOiBcImRvbmVcIiB9XG4gICAgICB8IHsgdHlwZTogXCJlcnJvclwiIH1cbiAgKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBbJHt0aGlzLnN0YWNrLm5hbWV9XTogJHt1cGRhdGUudHlwZX1gKTtcbiAgICAodGhpcy5jdXJyZW50U3RhdGUgYXMgQ2RrdGZTdGFja1N0YXRlcykgPSB1cGRhdGUudHlwZTtcbiAgICBzd2l0Y2ggKHVwZGF0ZS50eXBlKSB7XG4gICAgICBjYXNlIFwiaWRsZVwiOlxuICAgICAgY2FzZSBcImRvbmVcIjpcbiAgICAgIGNhc2UgXCJlcnJvclwiOlxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBcIm91dHB1dHMgZmV0Y2hlZFwiOlxuICAgICAgY2FzZSBcImRlcGxveWVkXCI6XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgT3V0cHV0czogJHtKU09OLnN0cmluZ2lmeSh1cGRhdGUub3V0cHV0cyl9YCk7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICBgT3V0cHV0c0J5Q29uc3RydWN0SWQ6ICR7SlNPTi5zdHJpbmdpZnkodXBkYXRlLm91dHB1dHNCeUNvbnN0cnVjdElkKX1gXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMub3V0cHV0cyA9IHVwZGF0ZS5vdXRwdXRzO1xuICAgICAgICB0aGlzLm91dHB1dHNCeUNvbnN0cnVjdElkID0gdXBkYXRlLm91dHB1dHNCeUNvbnN0cnVjdElkO1xuICAgICAgICB0aGlzLm9wdGlvbnMub25VcGRhdGUodXBkYXRlKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMub3B0aW9ucy5vblVwZGF0ZSh1cGRhdGUpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIoXG4gICAgcGhhc2U6IHN0cmluZ1xuICApOiAobWVzc2FnZTogc3RyaW5nLCBpc0Vycm9yPzogYm9vbGVhbikgPT4gdm9pZCB7XG4gICAgY29uc3Qgb25Mb2cgPSB0aGlzLm9wdGlvbnMub25Mb2c7XG4gICAgcmV0dXJuIChtc2c6IHN0cmluZywgaXNFcnJvciA9IGZhbHNlKSA9PiB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gZXh0cmFjdEpzb25Mb2dJZlByZXNlbnQobXNnKTtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgWyR7dGhpcy5vcHRpb25zLnN0YWNrLm5hbWV9XSgke3BoYXNlfSk6ICR7bXNnfWApO1xuICAgICAgaWYgKG9uTG9nKSB7XG4gICAgICAgIG9uTG9nKHsgbWVzc2FnZSwgaXNFcnJvciB9KTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSB3YWl0Rm9yQXBwcm92YWwocGxhbjogVGVycmFmb3JtUGxhbikge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgIHR5cGU6IFwid2FpdGluZyBmb3Igc3RhY2sgYXBwcm92YWxcIixcbiAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgIHBsYW46IHBsYW4sXG4gICAgICAgIGFwcHJvdmU6ICgpID0+IHtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9LFxuICAgICAgICByZWplY3Q6ICgpID0+IHtcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbml0YWxpemVUZXJyYWZvcm0oe1xuICAgIGlzU3BlY3VsYXRpdmUsXG4gIH06IHtcbiAgICBpc1NwZWN1bGF0aXZlOiBib29sZWFuO1xuICB9KSB7XG4gICAgY29uc3QgdGVycmFmb3JtID0gYXdhaXQgZ2V0VGVycmFmb3JtQ2xpZW50KFxuICAgICAgdGhpcy5vcHRpb25zLmFib3J0U2lnbmFsLFxuICAgICAgdGhpcy5vcHRpb25zLnN0YWNrLFxuICAgICAgaXNTcGVjdWxhdGl2ZSxcbiAgICAgIHRoaXMuY3JlYXRlVGVycmFmb3JtTG9nSGFuZGxlci5iaW5kKHRoaXMpXG4gICAgKTtcblxuICAgIGF3YWl0IHRlcnJhZm9ybS5pbml0KCk7XG5cbiAgICByZXR1cm4gdGVycmFmb3JtO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBydW4oY2I6ICgpID0+IFByb21pc2U8dm9pZD4pIHtcbiAgICBpZiAodGhpcy5zdG9wcGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuY3VycmVudFdvcmtQcm9taXNlID0gY2IoKTtcbiAgICAgIGF3YWl0IHRoaXMuY3VycmVudFdvcmtQcm9taXNlO1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7IHR5cGU6IFwiZG9uZVwiIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuY3VycmVudFdvcmtQcm9taXNlID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgIHR5cGU6IFwiZXJyb3JlZFwiLFxuICAgICAgICBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSxcbiAgICAgICAgZXJyb3I6IFN0cmluZyhlKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmN1cnJlbnRXb3JrUHJvbWlzZSA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkaWZmKHsgcmVmcmVzaE9ubHkgfTogeyByZWZyZXNoT25seT86IGJvb2xlYW4gfSkge1xuICAgIGF3YWl0IHRoaXMucnVuKGFzeW5jICgpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoeyB0eXBlOiBcInBsYW5uaW5nXCIsIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lIH0pO1xuICAgICAgY29uc3QgdGVycmFmb3JtID0gYXdhaXQgdGhpcy5pbml0YWxpemVUZXJyYWZvcm0oeyBpc1NwZWN1bGF0aXZlOiBmYWxzZSB9KTtcblxuICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHRlcnJhZm9ybS5wbGFuKGZhbHNlLCByZWZyZXNoT25seSk7XG4gICAgICB0aGlzLmN1cnJlbnRQbGFuID0gcGxhbjtcbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoeyB0eXBlOiBcInBsYW5uZWRcIiwgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsIHBsYW4gfSk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVwbG95KHJlZnJlc2hPbmx5PzogYm9vbGVhbikge1xuICAgIGF3YWl0IHRoaXMucnVuKGFzeW5jICgpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoeyB0eXBlOiBcInBsYW5uaW5nXCIsIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lIH0pO1xuICAgICAgY29uc3QgdGVycmFmb3JtID0gYXdhaXQgdGhpcy5pbml0YWxpemVUZXJyYWZvcm0oeyBpc1NwZWN1bGF0aXZlOiBmYWxzZSB9KTtcblxuICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHRlcnJhZm9ybS5wbGFuKGZhbHNlLCByZWZyZXNoT25seSk7XG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgdHlwZTogXCJwbGFubmVkXCIsIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLCBwbGFuIH0pO1xuXG4gICAgICBjb25zdCBhcHByb3ZlZCA9IHRoaXMub3B0aW9ucy5hdXRvQXBwcm92ZVxuICAgICAgICA/IHRydWVcbiAgICAgICAgOiBhd2FpdCB0aGlzLndhaXRGb3JBcHByb3ZhbChwbGFuKTtcblxuICAgICAgaWYgKCFhcHByb3ZlZCkge1xuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgdHlwZTogXCJkaXNtaXNzZWRcIiwgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7IHR5cGU6IFwiZGVwbG95aW5nXCIsIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lIH0pO1xuICAgICAgaWYgKHBsYW4ubmVlZHNBcHBseSkge1xuICAgICAgICBhd2FpdCB0ZXJyYWZvcm0uZGVwbG95KHBsYW4ucGxhbkZpbGUsIHJlZnJlc2hPbmx5KTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgb3V0cHV0cyA9IGF3YWl0IHRlcnJhZm9ybS5vdXRwdXQoKTtcbiAgICAgIGNvbnN0IG91dHB1dHNCeUNvbnN0cnVjdElkID0gZ2V0Q29uc3RydWN0SWRzRm9yT3V0cHV0cyhcbiAgICAgICAgSlNPTi5wYXJzZSh0aGlzLnN0YWNrLmNvbnRlbnQpLFxuICAgICAgICBvdXRwdXRzXG4gICAgICApO1xuXG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICAgICAgdHlwZTogXCJkZXBsb3llZFwiLFxuICAgICAgICBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSxcbiAgICAgICAgb3V0cHV0cyxcbiAgICAgICAgb3V0cHV0c0J5Q29uc3RydWN0SWQsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZXN0cm95KCkge1xuICAgIGF3YWl0IHRoaXMucnVuKGFzeW5jICgpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoeyB0eXBlOiBcInBsYW5uaW5nXCIsIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lIH0pO1xuICAgICAgY29uc3QgdGVycmFmb3JtID0gYXdhaXQgdGhpcy5pbml0YWxpemVUZXJyYWZvcm0oeyBpc1NwZWN1bGF0aXZlOiBmYWxzZSB9KTtcblxuICAgICAgY29uc3QgcGxhbiA9IGF3YWl0IHRlcnJhZm9ybS5wbGFuKHRydWUpO1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7IHR5cGU6IFwicGxhbm5lZFwiLCBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSwgcGxhbiB9KTtcblxuICAgICAgY29uc3QgYXBwcm92ZWQgPSB0aGlzLm9wdGlvbnMuYXV0b0FwcHJvdmVcbiAgICAgICAgPyB0cnVlXG4gICAgICAgIDogYXdhaXQgdGhpcy53YWl0Rm9yQXBwcm92YWwocGxhbik7XG4gICAgICBpZiAoIWFwcHJvdmVkKSB7XG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoeyB0eXBlOiBcImRpc21pc3NlZFwiLCBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgdHlwZTogXCJkZXN0cm95aW5nXCIsIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lIH0pO1xuICAgICAgYXdhaXQgdGVycmFmb3JtLmRlc3Ryb3koKTtcblxuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgIHR5cGU6IFwiZGVzdHJveWVkXCIsXG4gICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZmV0Y2hPdXRwdXRzKCkge1xuICAgIGF3YWl0IHRoaXMucnVuKGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRlcnJhZm9ybSA9IGF3YWl0IHRoaXMuaW5pdGFsaXplVGVycmFmb3JtKHsgaXNTcGVjdWxhdGl2ZTogZmFsc2UgfSk7XG5cbiAgICAgIGNvbnN0IG91dHB1dHMgPSBhd2FpdCB0ZXJyYWZvcm0ub3V0cHV0KCk7XG4gICAgICBjb25zdCBvdXRwdXRzQnlDb25zdHJ1Y3RJZCA9IGdldENvbnN0cnVjdElkc0Zvck91dHB1dHMoXG4gICAgICAgIEpTT04ucGFyc2UodGhpcy5zdGFjay5jb250ZW50KSxcbiAgICAgICAgb3V0cHV0c1xuICAgICAgKTtcbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICB0eXBlOiBcIm91dHB1dHMgZmV0Y2hlZFwiLFxuICAgICAgICBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSxcbiAgICAgICAgb3V0cHV0cyxcbiAgICAgICAgb3V0cHV0c0J5Q29uc3RydWN0SWQsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLm91dHB1dHM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RvcCgpIHtcbiAgICB0aGlzLnN0b3BwZWQgPSB0cnVlO1xuICB9XG59XG4iXX0=